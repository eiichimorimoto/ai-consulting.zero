# AI Consulting Zero - 開発ルール（Superpowers統合版）

> バージョン: 4.2 | 最終更新: 2026-02-13
> 統合: プロジェクト固有ルール + Superpowers開発規律

---

## 🎯 ルール適用の優先順位

### 優先度（必ず遵守）
1. **セキュリティ・安全性**: 最優先（絶対禁止事項）
2. **プロジェクト固有要件**: 技術スタック、ファイル保護レベル
3. **開発プロセス**: Superpowers 4段階プロセス
4. **コード品質**: テスト、型安全性、ドキュメント

### 競合時の解決原則
- セキュリティ > すべて
- プロジェクト固有 > 一般ルール
- 明示的指示 > 暗黙の改善
- 不明な場合は必ずユーザーに確認

---

# ===========================================
# SECTION 1: プロジェクト固有ルール
# ===========================================

## 1.1 プロジェクト情報

### 基本情報
- **プロジェクト名**: AI Consulting Zero
- **技術スタック**: Next.js 16 + TypeScript + Supabase
- **開発環境**: Cursor + Claude Code
- **バンドラー**: Turbopack（Next.js 16でstableでデフォルト）

### 【重要】このファイルはあなた（Cursor AI）への指示書です

あなたは以下のルールに**絶対に**従わなければなりません。

---

## 1.2 ファイル保護レベル（厳格遵守）

### レベル1: 絶対変更禁止（触る前に必ず確認）
```
lib/supabase/proxy.ts # 認証プロキシ（§8-3 suspended対応含む）
.env.local            # 機密情報
next.config.js        # ビルド設定
package.json          # 依存関係
package-lock.json     # ロックファイル
lib/stripe/**         # Stripe決済ロジック（v20対応済み）
```

### 【重要】Next.js 16でのmiddleware.ts

**現状（このプロジェクト）**:
- 現在は`middleware.ts`を使用中
- Next.js 16で動作するが**deprecated（非推奨）**
- 将来のバージョンで削除される予定

**Next.js 16の公式推奨**:
- `proxy.ts`への移行が推奨される
- `proxy.ts`はNode.js runtimeで動作（Edge非対応）
- より明確なネットワーク境界の表現

**このプロジェクトでの方針**:
- 当面は`middleware.ts`を継続使用
- 移行は慎重に計画的に実施

**移行するべきタイミング**:
- ✅ プロジェクトが安定している時
- ✅ テストカバレッジが十分な時
- ✅ 時間的余裕がある時
- ❌ 緊急の機能実装中
- ❌ 本番環境でトラブル発生中

**移行する場合の厳守手順**:
```bash
# Step 1: 事前準備
git add -A
git commit -m "chore: middleware.ts移行前のバックアップ"

# Step 2: codemod実行
npx @next/codemod@canary middleware-to-proxy .

# Step 3: 関数名変更確認
# middleware.ts → proxy.ts
# export function middleware() → export function proxy()

# Step 4: クリーンビルド（必須）
pkill -f "next"
sleep 10
rm -rf .next node_modules/.cache
npm run dev

# Step 5: 全ページ動作確認
# 認証フロー、保護ルート、リダイレクトを確認

# Step 6: 問題があればロールバック
git reset --hard HEAD~1
```

**注意事項**:
- Edge Runtimeが必要な場合は`middleware.ts`を維持
- `proxy.ts`はNode.js runtimeのみ（Edge非対応）
- 認証ロジックの移行先も検討（layout.tsx、Server Actions等）

**教訓（2026-01-20）**: middleware.ts関連の変更でキャッシュ問題発生
- ファイル名変更・移行時は**必ず**クリーンビルド
- キャッシュが古い状態で動作すると認証が不安定化
- 段階的な確認が必須

### レベル2: 慎重に扱う（変更前に影響範囲報告）
```
lib/supabase.ts       # DB接続
lib/auth.ts           # 認証ロジック
app/layout.tsx        # グローバルレイアウト
app/api/**            # APIルート
```

### レベル3: 変更可能（ただし1ファイルずつ、承認後）
```
app/**/page.tsx       # 個別ページ
components/**         # UIコンポーネント
```

---

## 1.3 絶対禁止事項（セキュリティ・安全性）

### コード変更での禁止
| 行為 | 理由 | 例外 |
|------|------|------|
| インポート文の自動整理 | 依存関係破壊 | ユーザー明示指示のみ |
| 未使用変数の自動削除 | 将来使う予定かも | 明示的指示があれば可 |
| ファイル名変更 | インポートパス破壊 | 不可 |
| 複数ファイル同時変更 | 原因特定困難 | 不可 |
| TypeScriptの`any`を勝手に修正 | 型エラー多発 | 新規コードのみ可 |

### ファイル操作での禁止
| 行為 | 理由 |
|------|------|
| `middleware.ts`の無計画な移行 | キャッシュ問題で認証が不安定化 |
| `.backup`ファイルの放置 | ビルドプロセスに影響 |
| `.env.local`の表示・コミット | セキュリティ違反 |
| `node_modules`削除 | 事前確認必須 |
| `git push --force` | 履歴破壊 |

### セキュリティ禁止事項
- `.env.local`は**絶対に**表示・コミット禁止
- APIキーのハードコード禁止
- `console.log`に機密情報を出力禁止
- `NEXT_PUBLIC_*`以外の環境変数はサーバーサイドのみ

---

## 1.4 変更前の必須プロトコル

### 【重要】変更前の宣言義務
```
【変更通知】
ファイル: src/xxx.tsx
箇所: 15-30行目
理由: ログイン処理のバグ修正
影響: なし（このファイルのみ）

この変更を実行してよろしいですか？
```

### スコープ制限の厳守
1. 指示されたファイル以外は**参照のみ**
2. 「ついでに」「改善のため」の変更は**全て禁止**
3. リファクタリングは明示的指示がない限り禁止

### 段階的実行（必須）
```
1ファイル変更 → 動作確認待ち → 次のファイル
```

- 複数ファイルの同時変更は禁止
- バッチ処理も禁止

### 差分確認の義務
コード生成前に必ず：
- 変更前後の差分を表示
- 削除される行がある場合は理由を説明
- インポート文の変更も報告

---

## 1.5 サーバー操作プロトコル

### Cursorサンドボックス権限（重要）
```bash
# 開発サーバー起動時は必ず
npm run dev
required_permissions: ["all"]
```

**理由**: Next.jsは`os.networkInterfaces()`を使用
→ `["network"]`だけでは`SystemError`が発生

### 起動前チェック（自動実行禁止 - 報告のみ）
```bash
# 1. Nextプロセス確認
ps aux | grep "[n]ext"

# 2. ポート使用状況（macOS/Linux）
lsof -i :3000

# 3. .nextフォルダ状態
ls -la .next

# 4. キャッシュサイズ
du -sh node_modules/.cache
```

**重要**: これらは**報告のみ**、勝手に実行しない

### 安全な起動手順（ユーザー承認後のみ実行）
```bash
# Step 1: プロセス停止
pkill -f "next"

# Step 2: 待機（必須）
sleep 10

# Step 3: ポート確認
lsof -i :3000

# Step 4: 必要に応じてキャッシュ削除
rm -rf .next

# Step 5: 起動
npm run dev

# Step 6: 起動確認
sleep 15 && curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/
```

---

## 1.6 キャッシュ管理とクリーンビルド

### 【重要】キャッシュ問題の教訓（2026-01-20）

**問題**: `middleware.ts`関連の変更後、古いキャッシュで動作
→ キャッシュクリア後に問題顕在化

**原因**:
- `.next/dev`に古いビルド結果が残存
- Turbopackのファイルシステムキャッシュが古い状態
- `.backup`ファイルがビルドプロセスに影響

### クリーンビルドが必要なタイミング

**必須実施**:
```bash
pkill -f "next"
rm -rf .next node_modules/.cache
npm run dev
```

**推奨タイミング**:
- ✅ middleware.ts、next.config.js、package.json変更後
- ✅ 原因不明のエラー発生時
- ✅ デプロイ前の最終確認
- ✅ 週1回（定期メンテナンス）

**通常時は不要**:
- ❌ 毎回の起動時
- ❌ UIコンポーネントの変更時
- ❌ 通常のコード変更時

### Turbopack File System Caching（Next.js 16.1+）

**情報**: Next.js 16.1以降、Turbopackのファイルシステムキャッシュは**stableでデフォルト有効**

- 開発サーバー再起動時のコンパイル時間が大幅短縮
- 大規模プロジェクトやモノレポで特に効果的
- 設定不要（自動的に有効）

**以前の設定（Next.js 16.0）**:
```javascript
// next.config.js - Next.js 16.0ではexperimentalフラグが必要だった
const nextConfig = {
  experimental: {
    turbopackFileSystemCacheForDev: true,
  },
};
```

**現在の設定（Next.js 16.1+）**:
```javascript
// next.config.js - 設定不要（デフォルトで有効）
// 無効化したい場合のみ設定
const nextConfig = {
  experimental: {
    turbopackFileSystemCacheForDev: false, // 明示的に無効化する場合
  },
};
```

### キャッシュトラブル診断フロー
```
1. エラー発生
   ↓
2. 単純再起動（pkill + npm run dev）
   ↓ ダメなら
3. キャッシュクリア（rm -rf .next）
   ↓ ダメなら
4. 拡張キャッシュクリア（rm -rf .next node_modules/.cache）
   ↓ ダメなら
5. Git復元（git restore .）
   ↓ ダメなら
6. 完全リセット（要承認）
```

### バックアップファイルの正しい扱い
- ❌ プロジェクトルートに`.backup`放置
- ✅ `backups/`フォルダに移動
- ✅ Gitのコミット履歴活用（`git show [commit]:file`）

---

## 1.7 エラー対応プロトコル

### エラー発生時の行動フロー（必須）
```
1. 【報告】「〇〇エラーが発生しました」
2. 【分析】最近の変更を確認
3. 【原因特定】推測ではなく事実を報告
4. 【対策提案】「Step Xを試しますか？」
5. 【承認待ち】勝手に実行しない
```

### 段階的トラブルシューティング

#### Step 1: 単純再起動（軽度エラー）
```bash
pkill -f "next"
sleep 5
npm run dev
```

#### Step 2: キャッシュクリア（ENOENT系）
```bash
pkill -f "next"
sleep 10
rm -rf .next
npm run dev
```

#### Step 3: 拡張キャッシュクリア（MODULE_NOT_FOUND）
```bash
pkill -f "next"
sleep 10
rm -rf .next node_modules/.cache
npm run dev
```

#### Step 4: Git復元（コード起因）
```bash
git status
git restore .
rm -rf .next
npm run dev
```

#### Step 5: 完全リセット（最終手段・要承認）
```bash
# ⚠️ ユーザー承認必須
git stash
rm -rf node_modules .next
npm install
npm run dev
```

### エラー別自動判定マトリクス

| エラーメッセージ | 推奨Step | 自動実行可否 |
|----------------|---------|------------|
| `ENOENT: .next/dev/*` | Step 2 | 可（報告後） |
| `MODULE_NOT_FOUND` | Step 3 | 可（報告後） |
| `Internal Server Error` | Step 1→2 | 可（報告後） |
| TypeScriptエラー | 報告のみ | 不可 |
| `port already in use` | ポート確認 | 可（報告後） |
| `SystemError: uv_interface_addresses` | 権限説明 | 不可 |

---

## 1.8 構文検証ルール（絶対遵守）

### JSX/HTML構造のチェック（必須）

**問題**: 途中で処理終了 → タグ開閉不一致

**対策（必須実施）**:

#### 1. タグカウントは2-3回繰り返して検証
```bash
# 1回目: 全体をカウント
grep -o "<div" file.tsx | wc -l
grep -o "</div>" file.tsx | wc -l

# 2回目: return以降をカウント
# 3回目: 手動で構造確認
```

#### 2. 数が合わない場合の対応
- ❌ 「1回カウントして終了」は禁止
- ✅ 最低2回、できれば3回異なる方法で検証
- ✅ 最後まで処理を完了
- ✅ 推測せず確実に確認

#### 3. 検証方法（3段階）
```
【検証1】正規表現カウント
  - 開きタグ: <div, <span
  - 閉じタグ: </div>, </span>

【検証2】構造解析
  - インデントで階層確認
  - 各開きタグに対応する閉じタグ特定

【検証3】手動確認
  - ファイル全体を目視
  - return文以降のJSX構造を精査
```

---

## 1.9 ライブラリ使用ルール

### pdfjs-dist の正しい実装（必須知識）

**Vercel環境でのワーカーエラー対策**:

#### 1. ワーカーファイル配置
```bash
cp node_modules/pdfjs-dist/build/pdf.worker.min.mjs public/
```

#### 2. クライアントサイド実装
```typescript
// lib/ocr/pdf-to-image-client.ts
const pdfjsLib = await import('pdfjs-dist')

if (typeof window !== 'undefined') {
  pdfjsLib.GlobalWorkerOptions.workerSrc = '/pdf.worker.min.mjs'
}
```

#### 3. コミット
```bash
git add public/pdf.worker.min.mjs
git commit -m "feat: pdfjs-distワーカーファイル追加"
```

### 重要原則
- 30分ルール: 解決しなければ別アプローチ
- クライアント優先: pdfjs-distはブラウザで使用
- public配置: ワーカーは静的アセット

---

## 1.10 コードスタイル（変更時に適用）

### TypeScript
- `any`は最小限（既存のanyは変更しない）
- 型推論を活用
- 明示的な型が必要な場合のみ記述

### React
- コンポーネント: デフォルトエクスポート
- Hooks: ファイル上部に配置
- useEffect: 依存配列を必ず記述

### ファイル命名規約

| カテゴリ | 規約 | 例 |
|---------|------|-----|
| UIコンポーネント | `PascalCase.tsx` | `AppHeader.tsx`, `LogoutButton.tsx` |
| ページ | `page.tsx`, `layout.tsx`, `loading.tsx`, `error.tsx` | Next.js App Router標準 |
| ユーティリティ | `kebab-case.ts` | `auth-utils.ts`, `fetch-with-retry.ts` |
| カスタムフック | `use-kebab-case.ts` | `use-auth.ts`, `use-subscription.ts` |
| 型定義ファイル | `types.ts` or `*.types.ts` | `stripe.types.ts`, `types.ts` |
| テストファイル | `*.test.ts(x)` （対象と同階層） | `proxy.test.ts`, `LoginForm.test.tsx` |
| API Route | `route.ts`（RESTful: 名詞複数形パス） | `app/api/users/route.ts` |
| Server Actions | `actions.ts` | `app/dashboard/actions.ts` |

**既存ファイルの注意**: `footer.tsx`, `sidebar.tsx`, `theme-provider.tsx` 等の小文字ファイルは既存のため許容。新規作成時は上記規約に従うこと。

### interface / type 命名
- interface: プレフィックスなし → `UserProfile`, `SubscriptionData`
- type alias: プレフィックスなし → `ApiResponse`, `PlanType`
- Props型: `{ComponentName}Props` → `AppHeaderProps`
- Enum: PascalCase → `SubscriptionStatus`

### Git運用

#### コミットメッセージ規約（Conventional Commits準拠）
```bash
feat: 新機能追加
fix: バグ修正
refactor: リファクタリング
chore: 設定変更
docs: ドキュメント更新
test: テスト追加・修正
style: フォーマット変更（コード動作に影響なし）
```

#### ブランチ命名規約
```
feature/xxx    # 新機能
fix/xxx        # バグ修正
hotfix/xxx     # 緊急修正
release/xxx    # リリース準備
docs/xxx       # ドキュメント
```

---

## 1.11 テスト規約

### テストファイル配置
- テストファイルは**対象ファイルと同じディレクトリ**に配置
- 命名: `[対象ファイル名].test.ts(x)`
- 例: `lib/consulting/report-request.ts` → `lib/consulting/report-request.test.ts`

### テスト種別と目標
| 種別 | 対象 | ツール | カバレッジ目標 |
|------|------|--------|-------------|
| ユニットテスト | lib/, utils | Jest | 70%以上 |
| コンポーネントテスト | components/ | Jest + Testing Library | 主要コンポーネント |
| API テスト | app/api/ | Jest | 全エンドポイント |
| E2E テスト | 主要フロー | Playwright | 認証・決済・コンサル |

### テスト実行コマンド
```bash
npm test                  # 全テスト実行
npm run test:watch        # ウォッチモード
npm run test:coverage     # カバレッジ付き
```

### モック戦略
- Supabaseクライアント: `jest.mock("@supabase/supabase-js")`
- Stripe: `jest.mock("stripe")`
- 環境変数: `process.env` を直接設定（テスト用値）

---

## 1.12 セキュリティ運用

### .env.local ルール（明確化）
- **チャット出力への含め禁止**: 実際の値をAIの応答に含めない
- **プレースホルダー値のみ表示可**: `RESEND_API_KEY=re_xxxxxxxxxx`
- **環境変数テンプレート**: `.env.example` に全キー名を記載（値は空）

### Cronエンドポイント認証パターン
```typescript
// app/api/cron/*/route.ts の冒頭に必須
export async function GET(request: Request) {
  const authHeader = request.headers.get("authorization")
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return new Response("Unauthorized", { status: 401 })
  }
  // ...処理
}
```

### 依存関係セキュリティ
- **週次**: `npm audit` 実行（development-guide.md 定期メンテナンス参照）
- **脆弱性発見時**: `npm audit fix` で修正可能か確認 → 不可なら手動対応
- **メジャーアップデート**: 変更履歴を確認してからアップデート

---

## 1.13 ディレクトリ構造
```
app/                    # Next.js App Router（ページ・APIルート）
  ├── api/              # APIエンドポイント（RESTful）
  ├── (auth)/           # 認証関連ページ
  ├── dashboard/        # ダッシュボード
  └── account/          # アカウント管理
components/             # 共通UIコンポーネント（PascalCase.tsx）
  ├── ui/               # shadcn/ui ベースコンポーネント
  ├── billing/          # 課金関連
  └── consulting/       # コンサルティング関連
lib/                    # ユーティリティ・ビジネスロジック
  ├── supabase/         # Supabase接続・認証プロキシ
  ├── stripe/           # Stripe決済ロジック（Level 1）
  └── consulting/       # コンサルティングロジック
docs/                   # ドキュメント
  ├── ai-process.md     # AI 4段階プロセス
  └── development-guide.md  # 人間開発者ガイド
backups/                # バックアップファイル置き場
```

---

# ===========================================
# SECTION 2: Superpowers開発規律（概要）
# ===========================================

## 2.1 基本原則

コードを書く前に、必ず **Brainstorm → Design → Plan → Implement** の4段階を経ること。

> **詳細プロセス・テンプレート・チェックリスト**: `docs/ai-process.md` を参照

### 必須フロー（要約）
1. **Brainstorm**: 要件確認・逆質問 → `docs/architecture/brainstorm_*.md`
2. **Design**: アーキテクチャ・セキュリティ設計 → `docs/architecture/design_*.md`
3. **Plan**: タスク分解（1タスク=1ファイル=200行以内） → `docs/plans/*.md`
4. **Implement**: TDD → 変更通知 → 最小実装 → 構文検証 → コミット → 動作確認待ち

### 応答スタイル
- **言語**: 日本語で応答
- **説明**: 詳細な箇条書き、ステップバイステップ
- **図表**: 必要に応じてASCIIアート使用

---

# ===========================================
# SECTION 3: FAQ（よくある質問）
# ===========================================

**Q: ルールが矛盾したら？** → セキュリティ > プロジェクト固有 > 一般ルール。不明ならユーザーに確認。
**Q: 軽微な修正でも4段階必要？** → Typo修正は不要（変更通知は必須）。機能変更は必要。レベル1は常に必要。
**Q: テストが書けない場合は？** → 手動確認手順をドキュメント化。
**Q: proxy.ts移行はいつ？** → プロジェクト安定時・テスト充実時。詳細はSECTION 1.2参照。

---

# ===========================================
# SECTION 4: バージョン履歴
# ===========================================

## v4.2 (2026-02-13) - ルールレビュー後改善版
- **SECTION 2をdocs/ai-process.mdに分離**: .cursorrules を約600行→約350行に軽量化
- **Level 1ファイルリスト更新**: middleware.ts → lib/supabase/proxy.ts、lib/stripe/** 追加
- **ESLint + Prettier導入**: eslint.config.mjs, .prettierrc 追加
- **ネーミング規約を拡充**: API Route、hooks、types の命名規約を追加
- **テスト規約セクション追加**: テストファイル配置・命名・カバレッジ目標
- **セキュリティルール明確化**: .env.local のチャット出力禁止、Cron認証パターン追加

## v4.1 (2026-01-23)
- middleware.ts情報修正、proxy.ts移行ガイド追加

## v4.0 (2026-01-23)
- Superpowers開発規律を統合、4段階プロセス追加

## v3.3-v3.0 (2026-01-21 〜 2025-01-10)
- 構文検証ルール、キャッシュ管理教訓、AI制御最適化

---

## 🎯 まとめ

変更依頼 → SECTION 1で保護レベル確認 → `docs/ai-process.md` の4段階プロセス開始 → SECTION 1の制約遵守。
不明な点は推測せずユーザーに確認。セキュリティ > プロジェクト固有 > 一般ルール。