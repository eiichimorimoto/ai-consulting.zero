# AI Consulting Zero - 開発ルール

## 🎯 基本方針
- **安全第一**: 破壊的な変更を行う前に必ず確認
- **段階的実装**: 小さな変更を積み重ねる
- **動作確認**: 各変更後に必ずテスト
- **Git管理**: 重要な変更前にコミット
- **機能単位の最小変更**: コード追加・修正は対象機能に必要なファイルのみで完結させ、無関係なコードには手を加えない（関連が明確な場合のみ例外）

---

## 📋 実行前の必須チェック

### サーバー操作時
1. **ミドルウェアの存在確認**
   - `middleware.ts`が存在することを確認
   - 削除や移動の際は必ず理由を説明

1.5. **安定優先（devサーバーのエンジン統一）**
   - 開発中は **Webpack を優先**（Turbopackは環境/キャッシュ依存で不安定になりやすい）
   - **devサーバーは常に1つだけ起動**（二重起動はロック/ポートずれ/環境反映漏れの原因）
   - Turbopackエラーが出たら、まずキャッシュ削除（`rm -rf .next .turbo`）→再起動
   - 本リポジトリの `npm run dev` は既定で Webpack 起動（Turbopackを使う場合のみ `NEXT_DEV_ENGINE=turbopack`）

2. **キャッシュ状態の確認**
   - エラーが解決しない場合は`rm -rf .next`を提案
   - 変更が反映されない場合はキャッシュクリアを検討

3. **プロセスの確認**
   - サーバー起動前に既存プロセスを確認
   - ポート競合を事前にチェック

### ファイル操作時
1. **バックアップの作成**
   - 重要なファイル削除・変更前にバックアップ
   - バックアップファイル名は`.backup`または`.old`

2. **Git状態の確認**
   - 大きな変更前に`git status`で現在の状態を確認
   - 変更内容を明示的に説明

3. **エクスポート/インポートの統一**
   - コンポーネントはデフォルトエクスポートを優先
   - ユーティリティ関数は名前付きエクスポート

### コミット前の必須確認（重要！）

**新しいファイルを作成した場合、`git add`を忘れるとVercelでビルドエラーになる**

```bash
# 1. 未追跡ファイル（??マーク）がないか確認
git status

# 出力例:
# ?? components/NewComponent.tsx  ← これは追跡されていない！
# ?? lib/new-module/              ← フォルダごと追跡されていない！

# 2. 新しいファイルがあれば追加
git add components/NewComponent.tsx
git add lib/new-module/

# 3. 追加されたことを確認（A = Added）
git status
# A  components/NewComponent.tsx  ← 追加済み

# 4. コミット
git commit -m "feat: 新機能追加"
```

**よくあるミス:**
- 新しいコンポーネントを作成 → importを追加 → `git add`忘れ → Vercelでエラー
- 新しいフォルダ（lib/ocr/など）を作成 → `git add`忘れ → Vercelでエラー

**対策:**
- コミット前に必ず`git status`で`??`マークのファイルを確認
- 必要なファイルはすべて`git add`してからコミット

---

## 🚫 禁止事項

### 絶対にしてはいけないこと
1. **ミドルウェアファイルの削除**
   - `middleware.ts`は認証管理に必須
   - 削除する場合は必ず代替案を提示

2. **複数ファイルの同時大規模変更**
   - 1つずつ変更し、動作確認してから次へ
   - トラブルの原因特定を困難にする

3. **package.jsonの無計画な変更**
   - スクリプト変更時は必ず理由を説明
   - 元の設定をコメントで残す

4. **強制的なGit操作**
   - `git push --force`は禁止（明示的に要求された場合のみ）
   - `git reset --hard`は慎重に

5. **環境変数の削除**
   - `.env.local`の内容を削除しない
   - 変更前に必ず確認

---

## ✅ 推奨事項

### コード変更時
1. **段階的な実装**
   ```
   Step 1: 1つのファイルを変更
   Step 2: 動作確認
   Step 3: 問題なければ次のファイル
   ```

2. **明確なコミットメッセージ**
   ```
   feat: 新機能追加
   fix: バグ修正
   refactor: リファクタリング
   docs: ドキュメント更新
   style: コードスタイル変更
   test: テスト追加
   chore: ビルド・設定変更
   ```

3. **エラー発生時の対応**
   - エラーメッセージを完全に読み取る
   - キャッシュクリアを試す
   - Git履歴から原因を特定
   - 最悪の場合は`git restore`で戻す

### ファイル構成
1. **重複ファイルの管理**
   - `ComponentName.tsx`のみ使用
   - `ComponentName 2.tsx`等は削除
   - バックアップは`.backup`拡張子

2. **ディレクトリ構造の遵守**
   ```
   app/              # Next.js App Router
   components/       # 共通コンポーネント
   lib/              # ユーティリティ・ヘルパー
   public/           # 静的ファイル
   docs/             # ドキュメント
   middleware.ts     # 必須: 認証ミドルウェア
   ```

---

## 🔧 トラブルシューティング標準手順

### Phase 1: 状況確認
```bash
# 1. 現在の状態
git status
ps aux | grep "next dev"
lsof -i :3000

# 2. エラーログ確認
# ターミナル出力を注意深く読む
```

### Phase 2: 基本対応
```bash
# 1. プロセス停止
pkill -f "next dev"

# 2. キャッシュクリア
rm -rf .next

# 3. サーバー再起動
npm run dev
```

### Phase 3: 復旧手順
```bash
# うまくいかない場合
git restore .
rm -rf .next
npm run dev
```

### Phase 4: 完全リセット（最終手段）
```bash
git stash
git pull origin main
rm -rf node_modules .next
npm install
npm run dev
```

---

## 📦 依存関係管理

### パッケージ追加時
1. **必要性を確認**
   - 既存パッケージで代用できないか
   - バンドルサイズへの影響

2. **インストール方法**
   ```bash
   npm install <package-name>
   # または
   npm install -D <package-name>  # devDependencies
   ```

3. **package.jsonの確認**
   - バージョンを固定するか検討
   - `package-lock.json`もコミット

---

## 🔐 セキュリティ

### 環境変数の取り扱い
1. **絶対にコミットしない**
   - `.env.local`は`.gitignore`で除外済み
   - 環境変数の値は絶対に表示しない

2. **公開情報との区別**
   - `NEXT_PUBLIC_*`: ブラウザに公開される
   - その他: サーバーサイドのみ

3. **APIキーの管理**
   - 開発環境と本番環境で分ける
   - 定期的にローテーション

---

## 🎨 コードスタイル

### TypeScript/React
1. **型安全性**
   - `any`の使用は最小限に
   - 適切なインターフェース定義

2. **コンポーネント設計**
   ```typescript
   // Good
   export default function MyComponent() {
     return <div>...</div>
   }
   
   // Import
   import MyComponent from './MyComponent'
   ```

3. **ファイル命名**
   - コンポーネント: `PascalCase.tsx`
   - ユーティリティ: `kebab-case.ts`
   - ページ: `page.tsx`, `layout.tsx`

---

## 📊 パフォーマンス

### 最適化の原則
1. **画像最適化**
   - Next.jsの`<Image>`コンポーネント使用
   - 適切なサイズとフォーマット

2. **コンポーネントの遅延読み込み**
   ```typescript
   const HeavyComponent = dynamic(() => import('./HeavyComponent'))
   ```

3. **不要な再レンダリング防止**
   - `useMemo`, `useCallback`の適切な使用
   - `React.memo`でコンポーネントをメモ化

---

## 🧪 テスト

### 動作確認項目
1. **基本動作**
   - [ ] トップページが表示される
   - [ ] ヘッダーが正しく表示される
   - [ ] ナビゲーションが機能する

2. **認証機能**
   - [ ] ログインできる
   - [ ] ログアウトできる
   - [ ] 保護されたページにリダイレクトされる

3. **主要機能**
   - [ ] お問い合わせフォームが表示される
   - [ ] 料金ページが表示される
   - [ ] ダッシュボードにアクセスできる

---

## 📝 ドキュメント

### 更新が必要な場合
1. **README.md**: セットアップ手順の変更
2. **docs/**: 新機能やトラブルシューティング
3. **コード内コメント**: 複雑なロジックの説明

---

## 🚀 デプロイ前チェック

### 本番環境へのデプロイ前
1. **ビルド確認**
   ```bash
   npm run build
   npm run start
   ```

2. **環境変数の確認**
   - 本番用の`.env.production`を設定
   - すべての必須環境変数が設定されているか

3. **セキュリティチェック**
   - APIキーが漏れていないか
   - 不要なログ出力を削除

---

## 🌐 Vercelデプロイ管理（重要）

### ⚠️ よくある問題: ローカル修正が本番に反映されない

**原因パターン:**
1. **コミット忘れ**: ローカルで修正したがgit commitしていない
2. **プッシュ忘れ**: コミットしたがgit pushしていない
3. **自動デプロイ停止**: VercelとGitHubの連携が切れている
4. **ビルドエラー**: Vercelでビルドが失敗している

### 修正後の必須チェックリスト

```bash
# 1. 未コミットの変更を確認
git status

# 2. 変更をコミット
git add <変更したファイル>
git commit -m "fix: 修正内容"

# 3. リモートにプッシュ
git push origin main

# 4. Vercelのデプロイ状況を確認（重要！）
# → Vercelダッシュボードで最新コミットがデプロイされているか確認
```

### Vercelダッシュボードでの確認事項

1. **デプロイ日時の確認**
   - 最新のデプロイがいつ行われたか確認
   - GitHubの最新コミット日時と一致しているか
   - **日付がずれている場合は自動デプロイが機能していない**

2. **デプロイステータスの確認**
   - ✅ Ready: 正常にデプロイ完了
   - 🔄 Building: ビルド中
   - ❌ Error: ビルド失敗（ログを確認）
   - ⏸️ Queued: 待機中

3. **GitHubとの連携確認**
   - Settings → Git → Connected Git Repository
   - Production Branch が `main` になっているか
   - Auto-deploy が有効になっているか

### 自動デプロイが動かない場合の対処

1. **Vercelダッシュボードで手動Redeploy**
   - Deployments → 最新のデプロイ → 「...」→ Redeploy

2. **GitHubとの再連携**
   - Settings → Git → Disconnect → 再接続

3. **ビルドキャッシュのクリア**
   - Settings → General → Build Cache → Clear

### 本番確認の習慣化

**修正作業完了時の確認フロー:**
```
1. ローカルで動作確認 ✓
2. git status で未コミット確認 ✓
3. git commit + git push ✓
4. Vercelダッシュボードでデプロイ確認 ✓  ← これを忘れがち！
5. 本番サイトで動作確認 ✓
```

### Vercel関連URL
- ダッシュボード: https://vercel.com/dashboard
- プロジェクト: ai-consulting-zero
- 本番サイト: https://ai-consulting-zero.vercel.app

---

## 💡 重要な教訓（今回の事例から）

### ミドルウェアの重要性
- `middleware.ts`は認証管理の要
- 削除や移動は慎重に
- 存在確認を習慣化

### キャッシュ問題への対処
- エラーが解決しない → キャッシュクリア
- `rm -rf .next`は強力な武器

### Git管理の重要性
- 頻繁にコミット
- 問題時はすぐに戻せる
- `git restore .`は最後の砦

### 段階的な変更
- 一度に多くを変更しない
- 小さな変更を積み重ねる
- 各ステップで動作確認

### Vercelデプロイの確認（2024-12-23追加）
- **ローカル修正 → コミット → プッシュ → Vercel確認** を必ずセットで行う
- 「ローカルでは動くのに本番で動かない」→ まずVercelのデプロイ日時を確認
- Vercelダッシュボードで最新コミットがデプロイされているか必ず確認
- 自動デプロイが止まっている場合は手動でRedeployまたはGitHub連携を再確認

---

## 📞 サポート

問題が発生した場合は、以下のドキュメントを参照：
- `docs/troubleshooting/server-crash-analysis.md`: サーバークラッシュ分析
- `docs/setup/README-SETUP.md`: セットアップガイド
- `docs/guides/`: 各種ガイド

---

## 🔄 このルールの更新

新しい教訓や改善点があれば、このファイルに追加してください。
バージョン: 1.2
最終更新: 2024-12-23

### 更新履歴
- v1.2 (2024-12-23): コミット前の必須確認（git add忘れ防止）を追加
- v1.1 (2024-12-23): Vercelデプロイ管理セクション追加
- v1.0 (2024-12-17): 初版作成

