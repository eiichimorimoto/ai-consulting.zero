# AI Consulting Zero - 開発ルール（Superpowers統合版）

> バージョン: 4.1 | 最終更新: 2026-01-23
> 統合: プロジェクト固有ルール + Superpowers開発規律

---

## 🎯 ルール適用の優先順位

### 優先度（必ず遵守）
1. **セキュリティ・安全性**: 最優先（絶対禁止事項）
2. **プロジェクト固有要件**: 技術スタック、ファイル保護レベル
3. **開発プロセス**: Superpowers 4段階プロセス
4. **コード品質**: テスト、型安全性、ドキュメント

### 競合時の解決原則
- セキュリティ > すべて
- プロジェクト固有 > 一般ルール
- 明示的指示 > 暗黙の改善
- 不明な場合は必ずユーザーに確認

---

# ===========================================
# SECTION 1: プロジェクト固有ルール
# ===========================================

## 1.1 プロジェクト情報

### 基本情報
- **プロジェクト名**: AI Consulting Zero
- **技術スタック**: Next.js 16 + TypeScript + Supabase
- **開発環境**: Cursor + Claude Code
- **バンドラー**: Turbopack（Next.js 16でstableでデフォルト）

### 【重要】このファイルはあなた（Cursor AI）への指示書です

あなたは以下のルールに**絶対に**従わなければなりません。

---

## 1.2 ファイル保護レベル（厳格遵守）

### レベル1: 絶対変更禁止（触る前に必ず確認）
```
middleware.ts          # 認証の根幹（Next.js 16でdeprecated）
.env.local            # 機密情報
next.config.js        # ビルド設定
package.json          # 依存関係
package-lock.json     # ロックファイル
```

### 【重要】Next.js 16でのmiddleware.ts

**現状（このプロジェクト）**:
- 現在は`middleware.ts`を使用中
- Next.js 16で動作するが**deprecated（非推奨）**
- 将来のバージョンで削除される予定

**Next.js 16の公式推奨**:
- `proxy.ts`への移行が推奨される
- `proxy.ts`はNode.js runtimeで動作（Edge非対応）
- より明確なネットワーク境界の表現

**このプロジェクトでの方針**:
- 当面は`middleware.ts`を継続使用
- 移行は慎重に計画的に実施

**移行するべきタイミング**:
- ✅ プロジェクトが安定している時
- ✅ テストカバレッジが十分な時
- ✅ 時間的余裕がある時
- ❌ 緊急の機能実装中
- ❌ 本番環境でトラブル発生中

**移行する場合の厳守手順**:
```bash
# Step 1: 事前準備
git add -A
git commit -m "chore: middleware.ts移行前のバックアップ"

# Step 2: codemod実行
npx @next/codemod@canary middleware-to-proxy .

# Step 3: 関数名変更確認
# middleware.ts → proxy.ts
# export function middleware() → export function proxy()

# Step 4: クリーンビルド（必須）
pkill -f "next"
sleep 10
rm -rf .next node_modules/.cache
npm run dev

# Step 5: 全ページ動作確認
# 認証フロー、保護ルート、リダイレクトを確認

# Step 6: 問題があればロールバック
git reset --hard HEAD~1
```

**注意事項**:
- Edge Runtimeが必要な場合は`middleware.ts`を維持
- `proxy.ts`はNode.js runtimeのみ（Edge非対応）
- 認証ロジックの移行先も検討（layout.tsx、Server Actions等）

**教訓（2026-01-20）**: middleware.ts関連の変更でキャッシュ問題発生
- ファイル名変更・移行時は**必ず**クリーンビルド
- キャッシュが古い状態で動作すると認証が不安定化
- 段階的な確認が必須

### レベル2: 慎重に扱う（変更前に影響範囲報告）
```
lib/supabase.ts       # DB接続
lib/auth.ts           # 認証ロジック
app/layout.tsx        # グローバルレイアウト
app/api/**            # APIルート
```

### レベル3: 変更可能（ただし1ファイルずつ、承認後）
```
app/**/page.tsx       # 個別ページ
components/**         # UIコンポーネント
```

---

## 1.3 絶対禁止事項（セキュリティ・安全性）

### コード変更での禁止
| 行為 | 理由 | 例外 |
|------|------|------|
| インポート文の自動整理 | 依存関係破壊 | ユーザー明示指示のみ |
| 未使用変数の自動削除 | 将来使う予定かも | 明示的指示があれば可 |
| ファイル名変更 | インポートパス破壊 | 不可 |
| 複数ファイル同時変更 | 原因特定困難 | 不可 |
| TypeScriptの`any`を勝手に修正 | 型エラー多発 | 新規コードのみ可 |

### ファイル操作での禁止
| 行為 | 理由 |
|------|------|
| `middleware.ts`の無計画な移行 | キャッシュ問題で認証が不安定化 |
| `.backup`ファイルの放置 | ビルドプロセスに影響 |
| `.env.local`の表示・コミット | セキュリティ違反 |
| `node_modules`削除 | 事前確認必須 |
| `git push --force` | 履歴破壊 |

### セキュリティ禁止事項
- `.env.local`は**絶対に**表示・コミット禁止
- APIキーのハードコード禁止
- `console.log`に機密情報を出力禁止
- `NEXT_PUBLIC_*`以外の環境変数はサーバーサイドのみ

---

## 1.4 変更前の必須プロトコル

### 【重要】変更前の宣言義務
```
【変更通知】
ファイル: src/xxx.tsx
箇所: 15-30行目
理由: ログイン処理のバグ修正
影響: なし（このファイルのみ）

この変更を実行してよろしいですか？
```

### スコープ制限の厳守
1. 指示されたファイル以外は**参照のみ**
2. 「ついでに」「改善のため」の変更は**全て禁止**
3. リファクタリングは明示的指示がない限り禁止

### 段階的実行（必須）
```
1ファイル変更 → 動作確認待ち → 次のファイル
```

- 複数ファイルの同時変更は禁止
- バッチ処理も禁止

### 差分確認の義務
コード生成前に必ず：
- 変更前後の差分を表示
- 削除される行がある場合は理由を説明
- インポート文の変更も報告

---

## 1.5 サーバー操作プロトコル

### Cursorサンドボックス権限（重要）
```bash
# 開発サーバー起動時は必ず
npm run dev
required_permissions: ["all"]
```

**理由**: Next.jsは`os.networkInterfaces()`を使用
→ `["network"]`だけでは`SystemError`が発生

### 起動前チェック（自動実行禁止 - 報告のみ）
```bash
# 1. Nextプロセス確認
ps aux | grep "[n]ext"

# 2. ポート使用状況（macOS/Linux）
lsof -i :3000

# 3. .nextフォルダ状態
ls -la .next

# 4. キャッシュサイズ
du -sh node_modules/.cache
```

**重要**: これらは**報告のみ**、勝手に実行しない

### 安全な起動手順（ユーザー承認後のみ実行）
```bash
# Step 1: プロセス停止
pkill -f "next"

# Step 2: 待機（必須）
sleep 10

# Step 3: ポート確認
lsof -i :3000

# Step 4: 必要に応じてキャッシュ削除
rm -rf .next

# Step 5: 起動
npm run dev

# Step 6: 起動確認
sleep 15 && curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/
```

---

## 1.6 キャッシュ管理とクリーンビルド

### 【重要】キャッシュ問題の教訓（2026-01-20）

**問題**: `middleware.ts`関連の変更後、古いキャッシュで動作
→ キャッシュクリア後に問題顕在化

**原因**:
- `.next/dev`に古いビルド結果が残存
- Turbopackのファイルシステムキャッシュが古い状態
- `.backup`ファイルがビルドプロセスに影響

### クリーンビルドが必要なタイミング

**必須実施**:
```bash
pkill -f "next"
rm -rf .next node_modules/.cache
npm run dev
```

**推奨タイミング**:
- ✅ middleware.ts、next.config.js、package.json変更後
- ✅ 原因不明のエラー発生時
- ✅ デプロイ前の最終確認
- ✅ 週1回（定期メンテナンス）

**通常時は不要**:
- ❌ 毎回の起動時
- ❌ UIコンポーネントの変更時
- ❌ 通常のコード変更時

### Turbopack File System Caching（Next.js 16.1+）

**情報**: Next.js 16.1以降、Turbopackのファイルシステムキャッシュは**stableでデフォルト有効**

- 開発サーバー再起動時のコンパイル時間が大幅短縮
- 大規模プロジェクトやモノレポで特に効果的
- 設定不要（自動的に有効）

**以前の設定（Next.js 16.0）**:
```javascript
// next.config.js - Next.js 16.0ではexperimentalフラグが必要だった
const nextConfig = {
  experimental: {
    turbopackFileSystemCacheForDev: true,
  },
};
```

**現在の設定（Next.js 16.1+）**:
```javascript
// next.config.js - 設定不要（デフォルトで有効）
// 無効化したい場合のみ設定
const nextConfig = {
  experimental: {
    turbopackFileSystemCacheForDev: false, // 明示的に無効化する場合
  },
};
```

### キャッシュトラブル診断フロー
```
1. エラー発生
   ↓
2. 単純再起動（pkill + npm run dev）
   ↓ ダメなら
3. キャッシュクリア（rm -rf .next）
   ↓ ダメなら
4. 拡張キャッシュクリア（rm -rf .next node_modules/.cache）
   ↓ ダメなら
5. Git復元（git restore .）
   ↓ ダメなら
6. 完全リセット（要承認）
```

### バックアップファイルの正しい扱い
- ❌ プロジェクトルートに`.backup`放置
- ✅ `backups/`フォルダに移動
- ✅ Gitのコミット履歴活用（`git show [commit]:file`）

---

## 1.7 エラー対応プロトコル

### エラー発生時の行動フロー（必須）
```
1. 【報告】「〇〇エラーが発生しました」
2. 【分析】最近の変更を確認
3. 【原因特定】推測ではなく事実を報告
4. 【対策提案】「Step Xを試しますか？」
5. 【承認待ち】勝手に実行しない
```

### 段階的トラブルシューティング

#### Step 1: 単純再起動（軽度エラー）
```bash
pkill -f "next"
sleep 5
npm run dev
```

#### Step 2: キャッシュクリア（ENOENT系）
```bash
pkill -f "next"
sleep 10
rm -rf .next
npm run dev
```

#### Step 3: 拡張キャッシュクリア（MODULE_NOT_FOUND）
```bash
pkill -f "next"
sleep 10
rm -rf .next node_modules/.cache
npm run dev
```

#### Step 4: Git復元（コード起因）
```bash
git status
git restore .
rm -rf .next
npm run dev
```

#### Step 5: 完全リセット（最終手段・要承認）
```bash
# ⚠️ ユーザー承認必須
git stash
rm -rf node_modules .next
npm install
npm run dev
```

### エラー別自動判定マトリクス

| エラーメッセージ | 推奨Step | 自動実行可否 |
|----------------|---------|------------|
| `ENOENT: .next/dev/*` | Step 2 | 可（報告後） |
| `MODULE_NOT_FOUND` | Step 3 | 可（報告後） |
| `Internal Server Error` | Step 1→2 | 可（報告後） |
| TypeScriptエラー | 報告のみ | 不可 |
| `port already in use` | ポート確認 | 可（報告後） |
| `SystemError: uv_interface_addresses` | 権限説明 | 不可 |

---

## 1.8 構文検証ルール（絶対遵守）

### JSX/HTML構造のチェック（必須）

**問題**: 途中で処理終了 → タグ開閉不一致

**対策（必須実施）**:

#### 1. タグカウントは2-3回繰り返して検証
```bash
# 1回目: 全体をカウント
grep -o "<div" file.tsx | wc -l
grep -o "</div>" file.tsx | wc -l

# 2回目: return以降をカウント
# 3回目: 手動で構造確認
```

#### 2. 数が合わない場合の対応
- ❌ 「1回カウントして終了」は禁止
- ✅ 最低2回、できれば3回異なる方法で検証
- ✅ 最後まで処理を完了
- ✅ 推測せず確実に確認

#### 3. 検証方法（3段階）
```
【検証1】正規表現カウント
  - 開きタグ: <div, <span
  - 閉じタグ: </div>, </span>

【検証2】構造解析
  - インデントで階層確認
  - 各開きタグに対応する閉じタグ特定

【検証3】手動確認
  - ファイル全体を目視
  - return文以降のJSX構造を精査
```

---

## 1.9 ライブラリ使用ルール

### pdfjs-dist の正しい実装（必須知識）

**Vercel環境でのワーカーエラー対策**:

#### 1. ワーカーファイル配置
```bash
cp node_modules/pdfjs-dist/build/pdf.worker.min.mjs public/
```

#### 2. クライアントサイド実装
```typescript
// lib/ocr/pdf-to-image-client.ts
const pdfjsLib = await import('pdfjs-dist')

if (typeof window !== 'undefined') {
  pdfjsLib.GlobalWorkerOptions.workerSrc = '/pdf.worker.min.mjs'
}
```

#### 3. コミット
```bash
git add public/pdf.worker.min.mjs
git commit -m "feat: pdfjs-distワーカーファイル追加"
```

### 重要原則
- 30分ルール: 解決しなければ別アプローチ
- クライアント優先: pdfjs-distはブラウザで使用
- public配置: ワーカーは静的アセット

---

## 1.10 コードスタイル（変更時に適用）

### TypeScript
- `any`は最小限（既存のanyは変更しない）
- 型推論を活用
- 明示的な型が必要な場合のみ記述

### React
- コンポーネント: デフォルトエクスポート
- Hooks: ファイル上部に配置
- useEffect: 依存配列を必ず記述

### ファイル命名（新規作成時のみ）
- コンポーネント: `PascalCase.tsx`
- ユーティリティ: `kebab-case.ts`
- ページ: `page.tsx`, `layout.tsx`

### Git運用（コミットメッセージ規約）
```bash
feat: 新機能追加
fix: バグ修正
refactor: リファクタリング
chore: 設定変更
docs: ドキュメント更新
```

---

## 1.11 ディレクトリ構造
```
app/           # Next.js App Router
components/    # 共通コンポーネント
lib/           # ユーティリティ
middleware.ts  # 認証ミドルウェア（deprecated、当面使用継続）
backups/       # バックアップファイル置き場
docs/          # ドキュメント（Superpowers用）
```

---

# ===========================================
# SECTION 2: Superpowers開発規律
# ===========================================

## 2.1 基本原則

あなたは「エンジニアリングの規律」を重視するAIアシスタントです。
コードを書く前に、必ず思考・設計・計画のフェーズを経てください。

**プロジェクト固有ルールとの統合**:
- SECTION 1の技術スタック、ファイル保護レベルを遵守
- その上でSuperpowersの4段階プロセスを適用
- セキュリティ・安全性は常に最優先

---

## 2.2 必須プロセス（4段階）

### Phase 1: BRAINSTORM（要件分析）15分

**目的**: 要件を完全に理解する

**実施内容**:
ユーザーから要件を受け取ったら、**いきなりコードを書かない**。

#### 逆質問の観点（プロジェクト固有考慮）
1. **機能要件**: 何ができればいいか？
2. **技術要件**: Next.js 16 + Supabaseとの整合性は？
3. **セキュリティ**: 認証・環境変数の扱いは？
4. **ファイル保護**: レベル1-3のどのファイルに影響？
5. **パフォーマンス**: キャッシュ戦略は？
6. **スコープ**: どこまでやるか？やらないことは？

#### 出力先
`docs/architecture/brainstorm_[YYYYMMDD]_[機能名].md`

#### テンプレート
```markdown
# 🧠 Brainstorm: [機能名]

## プロジェクトコンテキスト
- 技術スタック: Next.js 16 + TypeScript + Supabase
- ファイル保護レベル: [レベル1/2/3]
- 関連ファイル: [影響を受けるファイル]

## 要件サマリー
[ユーザーの要望を1〜2段落で]

## 逆質問リスト
1. **機能要件**: [...]
2. **技術整合性**: Next.js/Supabaseとの統合方法は？
3. **セキュリティ**: 環境変数、認証への影響は？
4. **ファイル影響**: middleware.ts等の保護ファイルへの影響は？
5. **その他**: [...]

## 回答サマリー
[ユーザーからの回答]

## 確定要件
- [確定要件1]
- [確定要件2]

## スコープ外
- [やらないこと1]
- [やらないこと2]

## ファイル影響範囲
- 変更対象: [ファイルリスト]
- 参照のみ: [ファイルリスト]
- 保護レベル確認: [レベル1/2/3の該当確認]
```

---

### Phase 2: DESIGN（設計）30分

**目的**: システムの青写真を作る

**実施内容**:

#### 1. アーキテクチャ設計
- システム全体図（ASCIIアート推奨）
- レイヤー分割（API、ビジネスロジック、データ）
- 外部依存関係（Supabase、認証など）

#### 2. モジュール設計
- 各モジュールの責務
- インターフェース定義
- 依存関係グラフ

#### 3. 技術選定（プロジェクト制約考慮）
- Next.js 16機能の活用（App Router、Server Actions等）
- Supabase機能の活用（RLS、Real-time等）
- 代替案との比較

#### 4. セキュリティ設計
- 環境変数の使い分け（`NEXT_PUBLIC_*` vs サーバー専用）
- 認証フロー（middleware.tsへの影響）
- データ保護

#### 出力先
`docs/architecture/design_[YYYYMMDD]_[機能名].md`

#### テンプレート
```markdown
# 🎨 Design: [機能名]

## アーキテクチャ図
[ASCIIアートまたはMermaid図]

## モジュール構成
### 1. [モジュール名]
- **責務**: [...]
- **依存**: [...]
- **保護レベル**: [レベル1/2/3]

## 技術選定（プロジェクト制約考慮）
| カテゴリ | 選定技術 | 理由 | 制約 |
|---------|---------|------|------|
| 認証 | Supabase Auth | 既存システム | middleware.ts変更慎重 |
| キャッシュ | Next.js Cache | 標準機能 | Turbopack最適化 |

## データフロー
1. クライアント → API Route
2. API Route → Supabase
3. Supabase → Response
4. キャッシュ戦略

## セキュリティ考慮点
- 環境変数の扱い: [NEXT_PUBLIC_* or サーバー専用]
- 認証フロー: [middleware.tsへの影響]

## ファイル変更計画
### 新規作成
- [ファイルパス]: [目的]

### 変更対象
- [ファイルパス]: [変更内容] - 保護レベル[X]

### 参照のみ
- [ファイルパス]: [参照目的]
```

---

### Phase 3: PLAN（実装計画）20分

**目的**: 実装をタスクに分解する

**実施内容**:

#### 1. ディレクトリ構造の確定
```
app/
  ├── [new-feature]/
  │   ├── page.tsx
  │   └── components/
components/
  └── [new-components]/
lib/
  └── [new-utils]/
```

#### 2. タスク分解（原子タスク化）
- 1タスク = 1機能 = 200行以内
- 依存関係の明示
- 保護レベルの確認

#### 3. 実装順序の決定
- ボトムアップ（低レベル→高レベル）
- 保護レベル3 → 2 → 1の順（安全性優先）

#### 出力先
`docs/plans/implementation_plan_[YYYYMMDD]_[機能名].md`

#### テンプレート
```markdown
# 📝 Implementation Plan: [機能名]

## プロジェクト構造
```
[既存構造 + 追加ファイル]
```

## タスクリスト

### Task 1: [タスク名]
- **目的**: [...]
- **依存**: なし
- **成果物**: 
  - `components/NewComponent.tsx` (保護レベル3)
- **見積もり**: 20分
- **優先度**: 高
- **変更通知必須**: いいえ

### Task 2: [タスク名]
- **目的**: [...]
- **依存**: Task 1
- **成果物**:
  - `lib/auth.ts` 修正 (保護レベル2)
- **見積もり**: 30分
- **優先度**: 最高
- **変更通知必須**: はい（レベル2ファイル）

### Task 3: [タスク名]
- **目的**: [...]
- **依存**: Task 2
- **成果物**:
  - `middleware.ts` 修正 (保護レベル1)
- **見積もり**: 45分
- **優先度**: 最高
- **変更通知必須**: はい（レベル1ファイル）
- **注意**: middleware.ts変更後は必ずクリーンビルド

## 実装順序
1. Task 1（レベル3） → 動作確認
2. Task 2（レベル2） → 変更通知 → 承認待ち → 動作確認
3. Task 3（レベル1） → 変更通知 → 承認待ち → クリーンビルド → 動作確認

## 総見積もり時間
合計: 約1時間35分

## リスク管理
- Task 3: middleware.ts変更によるキャッシュ問題
  - 対策: クリーンビルド必須
```

---

### Phase 4: IMPLEMENT（実装）

**目的**: 計画に基づいて堅牢なコードを書く

**TDD原則**:
1. **Red**: 失敗するテストを書く
2. **Green**: テストをパスする最小限のコードを書く
3. **Refactor**: コードを改善する

**実施内容（各タスクごと）**:

#### Task実装フロー
```markdown
### Step 1: 変更通知（レベル1-2の場合必須）
【変更通知】
ファイル: [ファイルパス]
箇所: [行番号]
理由: [変更理由]
影響: [影響範囲]
保護レベル: [レベル]

この変更を実行してよろしいですか？

### Step 2: テストファイル作成（可能な場合）
- 失敗するテストを先に書く

### Step 3: 最小実装
- テストをパスする最小限のコード
- プロジェクト固有の規約遵守

### Step 4: 構文検証（JSX/HTML）
- タグカウント2-3回実施
- 開閉一致確認

### Step 5: コミット
git add [ファイル]
git commit -m "feat: [タスク名]"

### Step 6: 動作確認待ち
- ユーザーの確認を待つ
- 次のタスクには進まない
```

**コード品質基準**:
```typescript
// ✅ 良い例
export default function UserProfile({ userId }: { userId: string }) {
  const [user, setUser] = useState<User | null>(null)
  
  useEffect(() => {
    fetchUser(userId).then(setUser)
  }, [userId])
  
  if (!user) return <div>Loading...</div>
  
  return <div>{user.name}</div>
}
```

---

## 2.3 禁止事項（統合版）

### セキュリティ・安全性（最優先）
SECTION 1.3の絶対禁止事項を厳守

### 開発プロセス禁止事項
1. **フェーズスキップ禁止**
   - Brainstorm → Design → Plan → Implement の順を必ず守る
   - 「簡単だから」という理由でスキップ不可

2. **複数ファイル同時変更禁止**
   - 1タスク = 1ファイル
   - 動作確認してから次へ

3. **保護レベル無視禁止**
   - レベル1-2は必ず変更通知
   - レベル1は変更後クリーンビルド

4. **テストなし実装禁止**
   - できる限りテストを書く
   - E2Eテストが難しい場合は手動確認手順を記載

5. **ドキュメント後回し禁止**
   - Brainstorm/Design/Planドキュメント必須

---

## 2.4 品質チェックリスト（統合版）

### 各タスク開始前
- [ ] Brainstorm/Design/Planドキュメント作成済み？
- [ ] タスクの依存関係を確認したか？
- [ ] 影響を受けるファイルの保護レベルを確認したか？

### 各タスク実装時
- [ ] **【レベル1-2】変更通知を表示したか？**
- [ ] **【レベル1-2】ユーザーの承認を得たか？**
- [ ] 変更範囲は指示された箇所のみか？
- [ ] インポート文を勝手に変更していないか？
- [ ] 削除する行がある場合、理由は明確か？
- [ ] **【JSX/HTML】タグの開閉を2-3回検証したか？**

### 各タスク完了時（プロジェクト固有）
- [ ] プロジェクト固有の規約に準拠しているか？
- [ ] セキュリティ禁止事項を回避しているか？
- [ ] 型ヒントを記述したか？（新規コード）
- [ ] コミットメッセージは規約に従っているか？

### 各タスク完了時（Superpowers規律）
- [ ] テストを書いたか？（可能な場合）
- [ ] docstring/コメントを記述したか？
- [ ] エラーハンドリングを実装したか？

### 実装完了時
- [ ] **【レベル1変更】クリーンビルドを実施したか？**
- [ ] すべてのタスクが完了したか？
- [ ] 動作確認を実施したか？
- [ ] ドキュメントを更新したか？

---

## 2.5 応答スタイル

### 基本ルール
- **言語**: 日本語で応答
- **説明**: 詳細な箇条書き
- **手順**: ステップバイステップ
- **図表**: 必要に応じてASCIIアート使用

### フェーズごとの応答例

**Brainstormフェーズ**:
```
🧠 Brainstormフェーズを開始します

要件を理解するために、以下を確認させてください：

1. **機能要件**: [...]
2. **技術整合性**: Next.js/Supabaseとの統合は？
3. **ファイル影響**: どのファイルに影響しますか？
   - middleware.ts（保護レベル1）への影響は？
   - lib/auth.ts（保護レベル2）への影響は？
4. **セキュリティ**: 環境変数の扱いは？

[続く...]
```

---

# ===========================================
# SECTION 3: よくある質問（FAQ）
# ===========================================

## Q1: プロジェクト固有ルールとSuperpowersが矛盾したら？
**A**: SECTION 1（プロジェクト固有）が優先。ただし4段階プロセスは守る。

例: middleware.ts変更時
- Superpowers: テスト駆動で実装
- プロジェクト固有: 変更通知 → 承認待ち → クリーンビルド
→ **両方を守る**: 変更通知 → 承認 → テスト作成 → 実装 → クリーンビルド

## Q2: 既存コードの軽微な修正時は4段階プロセス必要？
**A**: 
- Typo修正: 不要（ただし変更通知は必須）
- 機能追加・変更: 必要（簡略版でも可）
- レベル1ファイル: 常に必要

## Q3: 緊急時でもBrainstormから始める？
**A**:
- セキュリティ緊急対応: 最小限（事後ドキュメント化）
- その他: できる限り4段階を守る
- レベル1ファイルは常に慎重に

## Q4: テストが書けない場合は？
**A**:
- E2Eテストが難しい場合: 手動確認手順を記載
- APIテスト: Postman/Insomnia等の手順を記載
- 最低限: 動作確認の手順をドキュメント化

## Q5: middleware.ts → proxy.ts移行はいつすべき？
**A**:
- Next.js 16で必須ではないが、推奨される
- タイミング: プロジェクト安定時、テスト充実時
- 移行しない選択肢: Edge Runtimeが必要な場合
- 詳細はSECTION 1.2を参照

---

# ===========================================
# SECTION 4: バージョン履歴
# ===========================================

## v4.1 (2026-01-23) - ファクトチェック後修正版
- **middleware.ts情報を修正**: Next.js 16でdeprecatedであることを明記
- **proxy.ts移行ガイドを追加**: 公式推奨の移行手順を詳細化
- **Turbopack File System Caching情報を更新**: Next.js 16.1でstableでデフォルト有効
- **ファイル操作禁止事項を修正**: 表現をより正確に
- **middleware vs proxy の詳細セクション追加**: 現状と移行方針を明確化

## v4.0 (2026-01-23)
- **Superpowers開発規律を統合**
- セクション構造で整理（プロジェクト固有 + Superpowers）
- 優先順位を明確化
- 4段階プロセス（Brainstorm → Design → Plan → Implement）追加
- 統合チェックリスト作成

## v3.3 (2026-01-21)
- 構文検証ルール追加（JSX/HTMLタグチェック必須化）

## v3.2 (2026-01-20)
- キャッシュ管理の教訓追加
- middleware.ts変更時の注意事項を強化

## v3.1 (2025-01-10)
- Turbopack情報を最新化

## v3.0 (2025-01-10)
- AI制御に最適化、明確な命令形式に変更

---

## 🎯 まとめ：このルールの使い方（AI向け）

### 変更依頼を受けたら
```
1. SECTION 1で保護レベルを確認
2. SECTION 2で4段階プロセス開始
   - Brainstorm: 要件確認
   - Design: 設計
   - Plan: タスク分解
   - Implement: 実装
3. 各ステップでSECTION 1の制約を遵守
4. チェックリストで最終確認
```

### 不明な点があれば
- 推測せず質問する
- 複数の選択肢を提示
- ユーザーに判断を仰ぐ

### ルールと指示が矛盾したら
1. セキュリティ > すべて
2. プロジェクト固有 > 一般ルール
3. ユーザーに確認して判断

---

**あなた（Cursor AI）は、このルールに従うことで、安全で品質の高いコードを提供できます。**