# AI Consulting Zero - Cursor AI制御ルール

> バージョン: 3.2（キャッシュ管理の教訓追加）| 最終更新: 2026-01-20

---

## 🤖 Cursor AIへの直接命令

### 【重要】このファイルはあなた（Cursor AI）への指示書です

あなたは以下のルールに**絶対に**従わなければなりません：

1. **変更前の宣言義務**
   ```
   【変更通知】
   ファイル: src/xxx.tsx
   箇所: 15-30行目
   理由: ログイン処理のバグ修正
   影響: なし（このファイルのみ）
   
   この変更を実行してよろしいですか？
   ```

2. **スコープ制限の厳守**
   - 指示されたファイル以外は**参照のみ**
   - 「ついでに」「改善のため」の変更は**全て禁止**
   - リファクタリングは明示的指示がない限り禁止

3. **段階的実行**
   - 1ファイル変更 → 動作確認待ち → 次のファイル
   - 複数ファイルの同時変更は禁止
   - バッチ処理も禁止

4. **差分確認の義務**
   コード生成前に必ず：
   - 変更前後の差分を表示
   - 削除される行がある場合は理由を説明
   - インポート文の変更も報告

---

## 🔒 ファイル保護レベル

### レベル1: 絶対変更禁止（触る前に必ず確認）
```
middleware.ts          # 認証の根幹（削除厳禁）
.env.local            # 機密情報
next.config.js        # ビルド設定
package.json          # 依存関係
package-lock.json     # ロックファイル
```

### レベル2: 慎重に扱う（変更前に影響範囲報告）
```
lib/supabase.ts       # DB接続
lib/auth.ts           # 認証ロジック
app/layout.tsx        # グローバルレイアウト
app/api/**            # APIルート
```

### レベル3: 変更可能（ただし1ファイルずつ、承認後）
```
app/**/page.tsx       # 個別ページ
components/**         # UIコンポーネント
```

---

## 🚫 絶対禁止事項

### コード変更での禁止
| 行為 | 理由 |
|------|------|
| インポート文の自動整理 | 依存関係破壊の原因 |
| 未使用変数の自動削除 | 将来使う予定かも |
| ファイル名変更 | インポートパス破壊 |
| 複数ファイル同時変更 | 原因特定困難 |
| TypeScriptの`any`を勝手に修正 | 型エラー多発 |

### ファイル操作での禁止
| 行為 | 理由 |
|------|------|
| `middleware.ts`削除 | 認証が壊れる |
| `middleware.ts`のリネーム・移行 | キャッシュ問題で動作不能になる（教訓: 2026-01-20） |
| `.backup`ファイルの放置 | ビルドプロセスに影響する可能性 |
| `.env.local`の表示 | セキュリティ違反 |
| `node_modules`削除 | 長時間かかる |
| `git push --force` | 履歴破壊 |

---

## 🔧 サーバー操作プロトコル

### 起動前チェック（自動実行禁止 - 報告のみ）
```bash
# 1. Nextプロセス確認
ps aux | grep "[n]ext"

# 2. ポート使用状況（macOS/Linux）
lsof -i :3000

# 3. .nextフォルダ状態
ls -la .next

# 4. devフォルダ確認
ls -la .next/dev

# 5. キャッシュサイズ
du -sh node_modules/.cache
```

**重要**: これらは**報告のみ**、勝手に実行しない

### 異常パターンの報告テンプレート
```
【サーバー異常検出】
症状: .nextフォルダが空
診断: キャッシュ破損の可能性
推奨対応: Step 2（.next削除）
実行してよろしいですか？
```

### 安全な起動手順（ユーザー承認後のみ実行）
```bash
# Step 1: プロセス停止
pkill -f "next"

# Step 2: 待機（必須）
sleep 10

# Step 3: ポート確認（macOS/Linux）
lsof -i :3000

# Step 4: 必要に応じてキャッシュ削除
rm -rf .next

# Step 5: 起動
npm run dev

# Step 6: 起動確認
sleep 15 && curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/
```

### Next.js 16のバンドラー設定

**現状（2025-01-10時点）:**
- ✅ **Turbopackは安定版** - Next.js 16でデフォルト
- ✅ 開発・本番の両方で使用可能
- ✅ 設定不要（自動で有効）

**推奨:**
```bash
# デフォルト（Turbopack使用）
npm run dev

# Webpackを使う場合（カスタム設定がある場合のみ）
npm run dev -- --webpack
npm run build -- --webpack
```

**Turbopackの利点:**
- 開発時のFast Refreshが最大10倍高速
- 本番ビルドが2-5倍高速
- ファイルシステムキャッシュが自動有効（16.1+）

**Webpackを使うべき場合:**
- カスタムwebpack設定がある
- webpackプラグインに依存している
- Turbopackで互換性問題が発生

### Cursorサンドボックス権限（重要）

**開発サーバー起動時は必ず:**
```bash
npm run dev
required_permissions: ["all"]
```

**理由**: Next.jsは`os.networkInterfaces()`でローカルIPを取得
→ `["network"]`だけでは`SystemError`が発生

**その他のコマンド:**
- ファイル操作のみ: 権限不要
- Git操作: `["git_write", "network"]`
- API呼び出し: `["network"]`
- システム情報取得: `["all"]`

---

## 📦 キャッシュ管理とクリーンビルド

### 【重要】キャッシュ問題の教訓（2026-01-20）

**問題**: `middleware.ts` → `proxy.ts`移行後、古いキャッシュのおかげで動作していたが、キャッシュクリア後に問題が顕在化

**原因**:
- `.next/dev`に古いビルド結果が残っていた
- Next.jsは新しいビルドをせず、キャッシュを使っていた
- `.backup`ファイルがビルドプロセスに影響していた

### クリーンビルドが必要なタイミング

**必須実施（問題発生時）:**
```bash
pkill -f "next"
rm -rf .next node_modules/.cache
npm run dev
```

**推奨実施（定期的）:**
- ✅ 大きな変更後（middleware、next.config.js、package.jsonなど）
- ✅ 原因不明のエラーが発生した時
- ✅ デプロイ前の最終確認
- ✅ 週1回（金曜日の終業前など）

**通常時は不要（時間がかかるため）:**
- ❌ 毎回の起動時
- ❌ UIコンポーネントの変更時
- ❌ 通常のコード変更時

### キャッシュトラブル診断フロー

```
1. エラー発生
   ↓
2. まず単純再起動（Step 1）
   ↓ ダメなら
3. キャッシュクリア（rm -rf .next）
   ↓ ダメなら
4. 拡張キャッシュクリア（rm -rf .next node_modules/.cache）
   ↓ ダメなら
5. Git復元（git restore .）
   ↓ ダメなら
6. 完全リセット（要承認）
```

### バックアップファイルの正しい扱い方

**❌ 禁止:**
- プロジェクトルートに`.backup`ファイルを放置
- 使わない`middleware.ts.backup`のような重要ファイルのバックアップ

**✅ 推奨:**
- バックアップは`backups/`フォルダに移動
- または、Gitのコミット履歴を活用（`git show [commit]:file`）
- タグ付けで安定版を明示（例: `stable-20250121`）

---

## 📁 ファイル操作ルール

### 変更時の手順（必須）
1. **変更宣言** - 上記テンプレート使用
2. **影響範囲確認** - インポート先を調査
3. **バックアップ提案** - Gitコミットまたは`backups/`フォルダに保存
4. **差分表示** - 変更前後を明示
5. **承認待ち** - ユーザーの「実行」を待つ

### Git運用（コミットメッセージ規約）
```bash
feat: 新機能追加
fix: バグ修正
refactor: リファクタリング
chore: 設定変更
docs: ドキュメント更新
```

### ディレクトリ構造
```
app/           # Next.js App Router
components/    # 共通コンポーネント
lib/           # ユーティリティ
middleware.ts  # 認証ミドルウェア（削除厳禁）
```

---

## 🚨 エラー対応プロトコル

### エラー発生時の行動フロー
```
1. 【報告】「〇〇エラーが発生しました」
2. 【分析】最近の変更を確認
3. 【原因特定】推測ではなく事実を報告
4. 【対策提案】「Step Xを試しますか？」
5. 【承認待ち】勝手に実行しない
```

### 段階的トラブルシューティング

#### Step 1: 単純再起動（軽度エラー時）
```bash
pkill -f "next"
sleep 5
npm run dev
```

#### Step 2: キャッシュクリア（ENOENT系）
```bash
pkill -f "next"
sleep 10
rm -rf .next
npm run dev
```

#### Step 3: 拡張キャッシュクリア（MODULE_NOT_FOUND）
```bash
pkill -f "next"
sleep 10
rm -rf .next node_modules/.cache
npm run dev
```

#### Step 4: Git復元（コード起因のエラー）
```bash
git status  # まず状態確認
git restore .
rm -rf .next
npm run dev
```

#### Step 5: 完全リセット（最終手段・要承認）
```bash
# ⚠️ ユーザー承認必須
# ⚠️ 進行中のコードが消える可能性
git stash
rm -rf node_modules .next
npm install
npm run dev
```

### エラー別自動判定マトリクス

| エラーメッセージ | 推奨Step | 自動実行可否 |
|----------------|---------|------------|
| `ENOENT: .next/dev/*` | Step 2 | 可（報告後） |
| `MODULE_NOT_FOUND` | Step 3 | 可（報告後） |
| `Internal Server Error` | Step 1→2 | 可（報告後） |
| TypeScriptエラー | 報告のみ | 不可 |
| `port already in use` | ポート確認 | 可（報告後） |
| `CORS error` | 設定確認 | 不可 |
| `SystemError: uv_interface_addresses` | 権限設定 | 不可（説明のみ） |

### 禁止事項（エラー時）
- ❌ エラーを見たら関連ファイルを勝手に修正
- ❌ 推測で複数の変更を同時実行
- ❌ Stack Overflowのコードをコピペ
- ❌ Step 5を勝手に実行

---

## 📚 ライブラリ使用ルール

### pdfjs-dist の正しい実装（必須知識）

**問題**: Vercel環境でワーカーエラー
```
No "GlobalWorkerOptions.workerSrc" specified
```

**解決方法（10分で完了）:**

1. **ワーカーファイル配置**
```bash
cp node_modules/pdfjs-dist/build/pdf.worker.min.mjs public/
```

2. **クライアントサイド実装**
```typescript
// lib/ocr/pdf-to-image-client.ts
const pdfjsLib = await import('pdfjs-dist')

if (typeof window !== 'undefined') {
  pdfjsLib.GlobalWorkerOptions.workerSrc = '/pdf.worker.min.mjs'
}
```

3. **コミット**
```bash
git add public/pdf.worker.min.mjs
git commit -m "feat: pdfjs-distワーカーファイル追加"
```

### 重要原則
| 原則 | 説明 |
|------|------|
| 30分ルール | 解決しなければ別アプローチ |
| クライアント優先 | pdfjs-distはブラウザで使用 |
| public配置 | ワーカーは静的アセット |
| 絶対パス | `/filename` で参照 |

---

## 🎨 コードスタイル（変更時に適用）

### TypeScript
- `any`は最小限（ただし既存のanyは変更しない）
- 型推論を活用
- 明示的な型が必要な場合のみ記述

### React
- コンポーネント: デフォルトエクスポート
- Hooks: ファイル上部に配置
- useEffectは依存配列を必ず記述

### ファイル命名（新規作成時のみ）
- コンポーネント: `PascalCase.tsx`
- ユーティリティ: `kebab-case.ts`
- ページ: `page.tsx`, `layout.tsx`

---

## 🔐 セキュリティ（絶対遵守）

### 環境変数の扱い
- `.env.local`は**絶対に**表示・コミット禁止
- `NEXT_PUBLIC_*`: ブラウザ公開OK
- その他: サーバーサイドのみ

### 機密情報チェック
- APIキーのハードコード禁止
- `console.log`に機密情報を出力禁止
- コミット前にセンシティブ情報を検索

---

## 📋 プロンプト対応ガイド

### 良いプロンプトの例
```
【変更依頼】
ファイル: app/api/auth/login/route.ts
箇所: 20-25行目
内容: エラーハンドリングを追加
理由: 現在は500エラーしか返さない

【変更禁止】
- 他のファイル
- インポート文
- 関数名
```

### 悪いプロンプトの例（対応方法）
```
プロンプト: "認証周りを改善して"
→ 「具体的にどのファイルのどの部分を変更しますか？」と確認
```

---

## 🔍 構文検証ルール（必須）

### JSX/HTML構造のチェック（絶対遵守）

**問題**: 途中で処理を終了すると、タグの開閉が不一致になる

**対策（必須実施）**:
1. **タグカウントは2-3回繰り返して検証**
   ```bash
   # 1回目: 全体をカウント
   grep -o "<div" file.tsx | wc -l
   grep -o "</div>" file.tsx | wc -l
   
   # 2回目: return以降をカウント
   # 3回目: 手動で構造を確認
   ```

2. **数が合わない場合の対応**
   - ❌ 「1回カウントして終了」は禁止
   - ✅ 最低2回、できれば3回異なる方法で検証
   - ✅ 最後まで処理を完了させる
   - ✅ 途中で推測せず、確実に確認

3. **検証方法（3段階）**
   ```
   【検証1】正規表現カウント
     - 開きタグ: <div, <span, など
     - 閉じタグ: </div>, </span>, など
   
   【検証2】構造解析
     - インデントレベルで階層確認
     - 各開きタグに対応する閉じタグを特定
   
   【検証3】手動確認
     - ファイル全体を目視で確認
     - 特に return 文以降のJSX構造を精査
   ```

4. **チェックリスト**
   - [ ] タグカウントを2回以上実施したか？
   - [ ] 結果が一致したか？
   - [ ] 不一致の場合、3回目の検証を実施したか？
   - [ ] 構造を手動で確認したか？
   - [ ] 途中で処理を終了していないか？

---

## ✅ 変更前チェックリスト（AIが自己確認）

変更実行前に必ず確認：

- [ ] 変更対象ファイルは指示されたものか？
- [ ] 変更範囲は指示された箇所のみか？
- [ ] 他のファイルに影響がないか確認したか？
- [ ] 削除する行がある場合、理由は明確か？
- [ ] インポート文を変更する必要があるか？
- [ ] ユーザーに差分を見せたか？
- [ ] 承認を得たか？
- [ ] **【新規】JSX/HTMLタグの開閉を2-3回検証したか？**

---

## 🎯 このルールファイルの使い方（AI向け）

1. **変更依頼を受けたら**:
   - このファイルを読み直す
   - 該当するルールを確認
   - ルールに従って行動

2. **不明な点があれば**:
   - 推測せず質問する
   - 複数の選択肢を提示
   - ユーザーに判断を仰ぐ

3. **ルールと指示が矛盾したら**:
   - ユーザーに確認
   - 安全な方を選択
   - 理由を説明

---

## 🔄 バージョン履歴

- v3.3 (2026-01-21): **構文検証ルール追加** - JSX/HTMLタグの開閉チェックを必須化
  - タグカウントは2-3回繰り返して検証（必須）
  - 途中終了を防ぐための多段階検証プロセス
  - チェックリストに構文検証を追加
- v3.2 (2026-01-20): **キャッシュ管理の教訓追加** - middleware.ts移行問題から学んだ教訓を追加
  - キャッシュクリアのタイミング明記
  - バックアップファイルの正しい扱い方
  - middleware.ts変更の禁止を強化
- v3.1 (2025-01-10): ファクトチェック実施、Turbopack情報を最新化
- v3.0 (2025-01-10): AI制御に最適化、明確な命令形式に変更
- v2.0 (2024-12-31): トラブルシューティング強化
- v1.0 (2024-12-01): 初版作成
