# AI Consulting Zero - 開発ルール

## 🎯 基本方針
- **安全第一**: 破壊的な変更を行う前に必ず確認
- **段階的実装**: 小さな変更を積み重ねる
- **動作確認**: 各変更後に必ずテスト
- **Git管理**: 重要な変更前にコミット
- **機能単位の最小変更**: コード追加・修正は対象機能に必要なファイルのみで完結させ、無関係なコードには手を加えない（関連が明確な場合のみ例外）

---

## 📋 実行前の必須チェック

### サーバー操作時
1. **ミドルウェアの存在確認**
   - `middleware.ts`が存在することを確認
   - 削除や移動の際は必ず理由を説明

1.5. **安定優先（devサーバーのエンジン統一）**
   - 開発中は **Webpack を優先**（Turbopackは環境/キャッシュ依存で不安定になりやすい）
   - **devサーバーは常に1つだけ起動**（二重起動はロック/ポートずれ/環境反映漏れの原因）
   - Turbopackエラーが出たら、まずキャッシュ削除（`rm -rf .next .turbo`）→再起動
   - 本リポジトリの `npm run dev` は既定で Webpack 起動（Turbopackを使う場合のみ `NEXT_DEV_ENGINE=turbopack`）

2. **キャッシュ状態の確認**
   - エラーが解決しない場合は`rm -rf .next`を提案
   - 変更が反映されない場合はキャッシュクリアを検討

3. **プロセスの確認**
   - サーバー起動前に既存プロセスを確認
   - ポート競合を事前にチェック

### ファイル操作時
1. **バックアップの作成**
   - 重要なファイル削除・変更前にバックアップ
   - バックアップファイル名は`.backup`または`.old`

2. **Git状態の確認**
   - 大きな変更前に`git status`で現在の状態を確認
   - 変更内容を明示的に説明

3. **エクスポート/インポートの統一**
   - コンポーネントはデフォルトエクスポートを優先
   - ユーティリティ関数は名前付きエクスポート

### コミット前の必須確認（重要！）

**新しいファイルを作成した場合、`git add`を忘れるとVercelでビルドエラーになる**

```bash
# 1. 未追跡ファイル（??マーク）がないか確認
git status

# 出力例:
# ?? components/NewComponent.tsx  ← これは追跡されていない！
# ?? lib/new-module/              ← フォルダごと追跡されていない！

# 2. 新しいファイルがあれば追加
git add components/NewComponent.tsx
git add lib/new-module/

# 3. 追加されたことを確認（A = Added）
git status
# A  components/NewComponent.tsx  ← 追加済み

# 4. コミット
git commit -m "feat: 新機能追加"
```

**よくあるミス:**
- 新しいコンポーネントを作成 → importを追加 → `git add`忘れ → Vercelでエラー
- 新しいフォルダ（lib/ocr/など）を作成 → `git add`忘れ → Vercelでエラー

**対策:**
- コミット前に必ず`git status`で`??`マークのファイルを確認
- 必要なファイルはすべて`git add`してからコミット

---

## 🚫 禁止事項

### 絶対にしてはいけないこと
1. **ミドルウェアファイルの削除**
   - `middleware.ts`は認証管理に必須
   - 削除する場合は必ず代替案を提示

2. **複数ファイルの同時大規模変更**
   - 1つずつ変更し、動作確認してから次へ
   - トラブルの原因特定を困難にする

3. **package.jsonの無計画な変更**
   - スクリプト変更時は必ず理由を説明
   - 元の設定をコメントで残す

4. **強制的なGit操作**
   - `git push --force`は禁止（明示的に要求された場合のみ）
   - `git reset --hard`は慎重に

5. **環境変数の削除**
   - `.env.local`の内容を削除しない
   - 変更前に必ず確認

---

## ✅ 推奨事項

### コード変更時
1. **段階的な実装**
   ```
   Step 1: 1つのファイルを変更
   Step 2: 動作確認
   Step 3: 問題なければ次のファイル
   ```

2. **明確なコミットメッセージ**
   ```
   feat: 新機能追加
   fix: バグ修正
   refactor: リファクタリング
   docs: ドキュメント更新
   style: コードスタイル変更
   test: テスト追加
   chore: ビルド・設定変更
   ```

3. **エラー発生時の対応**
   - エラーメッセージを完全に読み取る
   - キャッシュクリアを試す
   - Git履歴から原因を特定
   - 最悪の場合は`git restore`で戻す

### ファイル構成
1. **重複ファイルの管理**
   - `ComponentName.tsx`のみ使用
   - `ComponentName 2.tsx`等は削除
   - バックアップは`.backup`拡張子

2. **ディレクトリ構造の遵守**
   ```
   app/              # Next.js App Router
   components/       # 共通コンポーネント
   lib/              # ユーティリティ・ヘルパー
   public/           # 静的ファイル
   docs/             # ドキュメント
   middleware.ts     # 必須: 認証ミドルウェア
   ```

---

## 🔄 ポート管理の徹底

### サーバー起動前の必須チェック
```bash
# 1. ポート3000の使用状況を確認
lsof -i :3000

# 2. 使用中の場合、プロセスを特定
ps aux | grep "next dev"

# 3. 安全に停止（推奨）
pkill -f "next"

# 4. 強制停止（プロセスが残っている場合）
lsof -i :3000 | grep LISTEN | awk '{print $2}' | xargs kill -9
```

### ポート競合の予防策
- **開発終了時は必ずサーバーを停止**
- **新しいターミナルで起動する前に必ずチェック**
- **複数プロジェクトを切り替える場合は特に注意**

---

## 🔧 トラブルシューティング標準手順

### Phase 1: 状況確認
```bash
# 1. 現在の状態
git status
ps aux | grep "next dev"
lsof -i :3000

# 2. エラーログ確認
# ターミナル出力を注意深く読む
```

### Phase 2: 基本対応
```bash
# 1. プロセス停止
pkill -f "next dev"

# 2. キャッシュクリア
rm -rf .next

# 3. サーバー再起動
npm run dev
```

### Phase 3: 復旧手順
```bash
# うまくいかない場合
git restore .
rm -rf .next
npm run dev
```

### Phase 4: 完全リセット（最終手段）
```bash
git stash
git pull origin main
rm -rf node_modules .next
npm install
npm run dev
```

---

## 🚨 緊急時の復旧手順

### レベル1: サーバーが起動しない
```bash
# 1. 既存プロセスを全て停止
pkill -f "next"

# 2. キャッシュを完全削除
rm -rf .next .turbo node_modules/.cache

# 3. ポートが解放されたことを確認
lsof -i :3000
# 何も表示されなければOK

# 4. 再起動
npm run dev
```

### レベル2: 変更後に動かなくなった
```bash
# 1. 現在の変更を一時退避
git stash save "トラブル発生時の変更"

# 2. 最後に動いていた状態を確認
git log --oneline -10
git tag  # タグがあれば確認

# 3. 動いていた時点に戻る（コミットIDまたはタグ）
git checkout <コミットID または タグ名>

# 4. キャッシュクリアして動作確認
rm -rf .next
npm run dev

# 5. 動いたら、変更を再度慎重に適用
git checkout -  # 元のブランチに戻る
git stash pop   # 退避した変更を戻す（慎重に）
```

### レベル3: Git履歴から特定のファイルだけ復元
```bash
# 特定のファイルだけ前の状態に戻す
git restore --source=HEAD~1 <ファイルパス>

# 例：ミドルウェアが壊れた場合
git restore --source=HEAD~1 middleware.ts
```

### レベル4: 完全リセット（最終手段）
```bash
# 1. 現在の状態をバックアップブランチに保存
git branch backup-emergency-$(date +%Y%m%d-%H%M)

# 2. 最後に確実に動いていたタグに戻る
git tag  # タグ一覧
git checkout tags/working-xxxxxxxx

# 3. 新しいブランチを作成
git checkout -b recovery-$(date +%Y%m%d)

# 4. 完全クリーンインストール
rm -rf node_modules .next .turbo
npm ci

# 5. 環境変数を確認
cat .env.local

# 6. 動作確認
npm run dev
```

---

## 📦 依存関係管理

### パッケージ追加時
1. **必要性を確認**
   - 既存パッケージで代用できないか
   - バンドルサイズへの影響

2. **インストール方法**
   ```bash
   npm install <package-name>
   # または
   npm install -D <package-name>  # devDependencies
   ```

3. **package.jsonの確認**
   - バージョンを固定するか検討
   - `package-lock.json`もコミット

---

## 🔐 セキュリティ

### 環境変数の取り扱い
1. **絶対にコミットしない**
   - `.env.local`は`.gitignore`で除外済み
   - 環境変数の値は絶対に表示しない

2. **公開情報との区別**
   - `NEXT_PUBLIC_*`: ブラウザに公開される
   - その他: サーバーサイドのみ

3. **APIキーの管理**
   - 開発環境と本番環境で分ける
   - 定期的にローテーション

---

## 🎨 コードスタイル

### TypeScript/React
1. **型安全性**
   - `any`の使用は最小限に
   - 適切なインターフェース定義

2. **コンポーネント設計**
   ```typescript
   // Good
   export default function MyComponent() {
     return <div>...</div>
   }
   
   // Import
   import MyComponent from './MyComponent'
   ```

3. **ファイル命名**
   - コンポーネント: `PascalCase.tsx`
   - ユーティリティ: `kebab-case.ts`
   - ページ: `page.tsx`, `layout.tsx`

---

## 📊 パフォーマンス

### 最適化の原則
1. **画像最適化**
   - Next.jsの`<Image>`コンポーネント使用
   - 適切なサイズとフォーマット

2. **コンポーネントの遅延読み込み**
   ```typescript
   const HeavyComponent = dynamic(() => import('./HeavyComponent'))
   ```

3. **不要な再レンダリング防止**
   - `useMemo`, `useCallback`の適切な使用
   - `React.memo`でコンポーネントをメモ化

---

## 🧪 テスト

### 動作確認項目
1. **基本動作**
   - [ ] トップページが表示される
   - [ ] ヘッダーが正しく表示される
   - [ ] ナビゲーションが機能する

2. **認証機能**
   - [ ] ログインできる
   - [ ] ログアウトできる
   - [ ] 保護されたページにリダイレクトされる

3. **主要機能**
   - [ ] お問い合わせフォームが表示される
   - [ ] 料金ページが表示される
   - [ ] ダッシュボードにアクセスできる

---

## 📝 ドキュメント

### 更新が必要な場合
1. **README.md**: セットアップ手順の変更
2. **docs/**: 新機能やトラブルシューティング
3. **コード内コメント**: 複雑なロジックの説明

---

## 🚀 デプロイ前チェック

### 本番環境へのデプロイ前
1. **ビルド確認**
   ```bash
   npm run build
   npm run start
   ```

2. **環境変数の確認**
   - 本番用の`.env.production`を設定
   - すべての必須環境変数が設定されているか

3. **セキュリティチェック**
   - APIキーが漏れていないか
   - 不要なログ出力を削除

---

## 🌐 Vercelデプロイ管理（重要）

### ⚠️ よくある問題: ローカル修正が本番に反映されない

**原因パターン:**
1. **コミット忘れ**: ローカルで修正したがgit commitしていない
2. **プッシュ忘れ**: コミットしたがgit pushしていない
3. **自動デプロイ停止**: VercelとGitHubの連携が切れている
4. **ビルドエラー**: Vercelでビルドが失敗している

### 修正後の必須チェックリスト

```bash
# 1. 未コミットの変更を確認
git status

# 2. 変更をコミット
git add <変更したファイル>
git commit -m "fix: 修正内容"

# 3. リモートにプッシュ
git push origin main

# 4. Vercelのデプロイ状況を確認（重要！）
# → Vercelダッシュボードで最新コミットがデプロイされているか確認
```

### Vercelダッシュボードでの確認事項

1. **デプロイ日時の確認**
   - 最新のデプロイがいつ行われたか確認
   - GitHubの最新コミット日時と一致しているか
   - **日付がずれている場合は自動デプロイが機能していない**

2. **デプロイステータスの確認**
   - ✅ Ready: 正常にデプロイ完了
   - 🔄 Building: ビルド中
   - ❌ Error: ビルド失敗（ログを確認）
   - ⏸️ Queued: 待機中

3. **GitHubとの連携確認**
   - Settings → Git → Connected Git Repository
   - Production Branch が `main` になっているか
   - Auto-deploy が有効になっているか

### 自動デプロイが動かない場合の対処

1. **Vercelダッシュボードで手動Redeploy**
   - Deployments → 最新のデプロイ → 「...」→ Redeploy

2. **GitHubとの再連携**
   - Settings → Git → Disconnect → 再接続

3. **ビルドキャッシュのクリア**
   - Settings → General → Build Cache → Clear

### 本番確認の習慣化

**修正作業完了時の確認フロー:**
```
1. ローカルで動作確認 ✓
2. git status で未コミット確認 ✓
3. git commit + git push ✓
4. Vercelダッシュボードでデプロイ確認 ✓  ← これを忘れがち！
5. 本番サイトで動作確認 ✓
```

### Vercel関連URL
- ダッシュボード: https://vercel.com/dashboard
- プロジェクト: ai-consulting-zero
- 本番サイト: https://ai-consulting-zero.vercel.app

---

## 📌 コミット駆動開発ワークフロー

### 変更前の必須手順

#### Step 1: 現状の動作確認
```bash
# サーバーが起動していない場合は起動
npm run dev

# ブラウザで以下を確認：
# ✓ トップページ（http://localhost:3000）
# ✓ ログイン機能
# ✓ 主要な機能ページ
# ✓ API動作（該当する場合）
```

#### Step 2: 安全なポイントの作成
```bash
# 未コミットの変更がある場合
git add .
git commit -m "変更前: [機能名]が正常動作中"

# タグをつけて「戻れるポイント」を明確化（推奨）
git tag working-$(date +%Y%m%d-%H%M) -m "動作確認済み"
```

#### Step 3: 変更範囲を明確に指示
AI Agentへの指示例：
```
【変更対象】
- ファイル: app/api/ocr/route.ts のみ
- 目的: PDFアップロード機能の追加

【変更禁止】
- middleware.ts
- app/layout.tsx
- next.config.mjs
- package.json（新規パッケージ追加なし）

【確認事項】
変更後、以下の既存機能が影響を受けないこと：
- 認証フロー
- トップページ表示
- 既存のAPI動作
```

### 変更後の必須手順

#### Step 1: 変更内容の確認
```bash
# 何が変更されたか必ず確認
git diff

# 変更されたファイル一覧
git status

# 意図しないファイルが変更されていないか確認
```

#### Step 2: ビルドエラーチェック
```bash
# TypeScriptエラーがないか
npm run build

# エラーがある場合、即座に修正またはロールバック
```

#### Step 3: 動作確認（変更機能 + 既存機能）
```bash
# 開発サーバー起動（キャッシュクリア推奨）
rm -rf .next
npm run dev

# ブラウザで確認：
# ✓ 新機能が動作するか
# ✓ 既存機能が壊れていないか（特に認証、ナビゲーション）
# ✓ コンソールエラーがないか（F12で開発者ツール）
```

#### Step 4: 問題なければコミット
```bash
git add .
git commit -m "feat: [機能名]を追加 - 既存機能の動作確認済み"

# または修正の場合
git commit -m "fix: [問題]を修正 - 動作確認済み"
```

---

## 🤖 AI Agent制御のための指示テンプレート

### 変更時に必ず含めるべき情報

```markdown
## 変更リクエスト

### 目的
[何を実現したいか]

### 変更対象ファイル（これだけを変更）
- app/api/xxx/route.ts
- components/xxx/YyyComponent.tsx

### 変更禁止ファイル
- middleware.ts
- app/layout.tsx
- next.config.mjs
- package.json（事前確認なしの変更禁止）
- .env.local

### 新規パッケージの追加
- [ ] 不要
- [ ] 必要（事前に確認してください）

### 期待される動作
[変更後にどうなるべきか]

### 影響を受けない既存機能
以下の機能は絶対に壊さないこと：
- 認証フロー（ログイン/ログアウト）
- トップページ表示
- ヘッダー/フッター
- [その他の重要機能]

### 確認手順
変更後、以下を実行して確認してください：
1. `npm run build` - ビルドエラーがないこと
2. `npm run dev` - サーバーが起動すること
3. ブラウザで既存機能が動作すること
```

---

## 🎯 AI Agentが守るべきコード変更の原則

### 原則1: 最小変更の原則
- **1機能 = 1ファイル**（可能な限り）
- 複数ファイルに跨る場合、影響範囲を事前に明示

### 原則2: 後方互換性の原則
- 既存のAPIインターフェースは変更しない
- 新機能は既存機能に影響を与えない設計

### 原則3: 段階的実装の原則
```
ステップ1: 基本機能のみ実装
 ↓ 動作確認 → コミット
ステップ2: エラーハンドリング追加
 ↓ 動作確認 → コミット
ステップ3: UI/UX改善
 ↓ 動作確認 → コミット
```

### 原則4: 実験は別ブランチの原則
- 新しい手法を試す場合は`experiment/`ブランチで
- 失敗しても mainブランチは安全

---

## 📊 日々の運用チェックシート

### 毎日の開発開始時（5分）
```bash
# 1. Git状態確認
git status
# → 未コミットがあれば理由を確認

# 2. ポート確認
lsof -i :3000
# → 使用中なら停止

# 3. 環境変数確認
ls -la | grep .env
# → .env.local が存在するか

# 4. ブランチ確認
git branch
# → 作業用ブランチにいるか
```

### 機能追加・修正の開始時（3分）
```bash
# 1. 現在の動作確認
npm run dev
# → ブラウザで主要機能をテスト

# 2. 安全なポイント作成
git add .
git commit -m "変更前: 動作確認済み"
git tag working-$(date +%Y%m%d-%H%M)
```

### コード変更後（5分）
```bash
# 1. 変更内容確認
git diff
# → 意図しない変更がないか

# 2. ビルドチェック
npm run build
# → エラーがないか

# 3. 動作確認
npm run dev
# → 新機能 + 既存機能の両方

# 4. コミット
git add .
git commit -m "feat: [説明] - 動作確認済み"
```

### 毎日の開発終了時（2分）
```bash
# 1. 全ての変更をコミット
git status
# → 未コミットがないことを確認

# 2. タグをつける
git tag daily-$(date +%Y%m%d)

# 3. サーバー停止
pkill -f "next"

# 4. GitHub にバックアップ
git push origin main
```

---

## 💡 成功パターンと失敗パターン

### ✅ 成功パターン

#### パターン1: 小さく頻繁にコミット
```bash
# 1ファイル変更 → 動作確認 → コミット
# 次のファイル変更 → 動作確認 → コミット
# 常に「戻れるポイント」を維持
```

#### パターン2: 変更前の動作確認
```bash
# 必ず現在の動作を確認してからコミット
# 「何が壊れたか」ではなく「何が動いていたか」を記録
```

#### パターン3: 限定的な変更指示
```
「app/api/ocr/route.tsのみを変更してください」
→ AI Agentが他のファイルに触らない
```

### ❌ 失敗パターン

#### パターン1: 複数ファイルの同時変更
```bash
# 5ファイルを一度に変更
# → どのファイルが原因でエラーが出たか不明
# → 全部戻すしかない
```

#### パターン2: 変更前にコミットしない
```bash
# 動いている状態でコミットせず変更開始
# → 壊れた時に戻れない
# → 「前は動いていた」が証明できない
```

#### パターン3: 曖昧な指示
```
「PDFアップロード機能を追加して」
→ AI Agentが勝手に複数ファイルを変更
→ 意図しない設定変更が含まれる
```

---

## 🔧 プロジェクト固有の注意事項

### 本プロジェクト（AI Consulting Zero）固有

#### 重要ファイル（特に注意）
1. **middleware.ts** - 認証の要。削除・移動は絶対禁止
2. **app/layout.tsx** - 全ページに影響
3. **lib/supabase/client.ts** - DB接続
4. **lib/supabase/server.ts** - サーバー側DB接続

#### ポート設定
- 開発: 3000（デフォルト）、使用中の場合は3001
- 本番: Vercelが自動管理

---

## 💡 重要な教訓（今回の事例から）

### ミドルウェアの重要性
- `middleware.ts`は認証管理の要
- 削除や移動は慎重に
- 存在確認を習慣化

### キャッシュ問題への対処
- エラーが解決しない → キャッシュクリア
- `rm -rf .next`は強力な武器

### Git管理の重要性
- 頻繁にコミット
- 問題時はすぐに戻せる
- `git restore .`は最後の砦

### 段階的な変更
- 一度に多くを変更しない
- 小さな変更を積み重ねる
- 各ステップで動作確認

### Vercelデプロイの確認（2024-12-23追加）
- **ローカル修正 → コミット → プッシュ → Vercel確認** を必ずセットで行う
- 「ローカルでは動くのに本番で動かない」→ まずVercelのデプロイ日時を確認
- Vercelダッシュボードで最新コミットがデプロイされているか必ず確認
- 自動デプロイが止まっている場合は手動でRedeployまたはGitHub連携を再確認

---

## 📞 サポート

問題が発生した場合は、以下のドキュメントを参照：
- `docs/troubleshooting/server-crash-analysis.md`: サーバークラッシュ分析
- `docs/setup/README-SETUP.md`: セットアップガイド
- `docs/guides/`: 各種ガイド

---

## 🔄 このルールの更新

新しい教訓や改善点があれば、このファイルに追加してください。
バージョン: 2.0
最終更新: 2024-12-23

### 更新履歴
- v2.0 (2024-12-23): 大幅拡充 - ポート管理、コミット駆動ワークフロー、AI Agent制御、緊急復旧手順、日々のチェックシート、成功/失敗パターンを追加
- v1.2 (2024-12-23): コミット前の必須確認（git add忘れ防止）を追加
- v1.1 (2024-12-23): Vercelデプロイ管理セクション追加
- v1.0 (2024-12-17): 初版作成

