# AI Consulting Zero - 開発ルール

## 🎯 基本方針
- **安全第一**: 破壊的な変更を行う前に必ず確認
- **段階的実装**: 小さな変更を積み重ねる
- **動作確認**: 各変更後に必ずテスト
- **Git管理**: 重要な変更前にコミット
- **機能単位の最小変更**: コード追加・修正は対象機能に必要なファイルのみで完結させ、無関係なコードには手を加えない（関連が明確な場合のみ例外）

---

## 📋 実行前の必須チェック

### サーバー操作時
1. **ミドルウェアの存在確認**
   - `middleware.ts`が存在することを確認
   - 削除や移動の際は必ず理由を説明

1.5. **安定優先（devサーバーのエンジン統一）**
   - 開発中は **Webpack を優先**（Turbopackは環境/キャッシュ依存で不安定になりやすい）
   - **devサーバーは常に1つだけ起動**（二重起動はロック/ポートずれ/環境反映漏れの原因）
   - Turbopackエラーが出たら、まずキャッシュ削除（`rm -rf .next .turbo`）→再起動
   - 本リポジトリの `npm run dev` は既定で Webpack 起動（Turbopackを使う場合のみ `NEXT_DEV_ENGINE=turbopack`）

2. **キャッシュ状態の確認**
   - エラーが解決しない場合は`rm -rf .next`を提案
   - 変更が反映されない場合はキャッシュクリアを検討

3. **プロセスの確認**
   - サーバー起動前に既存プロセスを確認
   - ポート競合を事前にチェック

### ファイル操作時
1. **バックアップの作成**
   - 重要なファイル削除・変更前にバックアップ
   - バックアップファイル名は`.backup`または`.old`

2. **Git状態の確認**
   - 大きな変更前に`git status`で現在の状態を確認
   - 変更内容を明示的に説明

3. **エクスポート/インポートの統一**
   - コンポーネントはデフォルトエクスポートを優先
   - ユーティリティ関数は名前付きエクスポート

---

## 🚫 禁止事項

### 絶対にしてはいけないこと
1. **ミドルウェアファイルの削除**
   - `middleware.ts`は認証管理に必須
   - 削除する場合は必ず代替案を提示

2. **複数ファイルの同時大規模変更**
   - 1つずつ変更し、動作確認してから次へ
   - トラブルの原因特定を困難にする

3. **package.jsonの無計画な変更**
   - スクリプト変更時は必ず理由を説明
   - 元の設定をコメントで残す

4. **強制的なGit操作**
   - `git push --force`は禁止（明示的に要求された場合のみ）
   - `git reset --hard`は慎重に

5. **環境変数の削除**
   - `.env.local`の内容を削除しない
   - 変更前に必ず確認

---

## ✅ 推奨事項

### コード変更時
1. **段階的な実装**
   ```
   Step 1: 1つのファイルを変更
   Step 2: 動作確認
   Step 3: 問題なければ次のファイル
   ```

2. **明確なコミットメッセージ**
   ```
   feat: 新機能追加
   fix: バグ修正
   refactor: リファクタリング
   docs: ドキュメント更新
   style: コードスタイル変更
   test: テスト追加
   chore: ビルド・設定変更
   ```

3. **エラー発生時の対応**
   - エラーメッセージを完全に読み取る
   - キャッシュクリアを試す
   - Git履歴から原因を特定
   - 最悪の場合は`git restore`で戻す

### ファイル構成
1. **重複ファイルの管理**
   - `ComponentName.tsx`のみ使用
   - `ComponentName 2.tsx`等は削除
   - バックアップは`.backup`拡張子

2. **ディレクトリ構造の遵守**
   ```
   app/              # Next.js App Router
   components/       # 共通コンポーネント
   lib/              # ユーティリティ・ヘルパー
   public/           # 静的ファイル
   docs/             # ドキュメント
   middleware.ts     # 必須: 認証ミドルウェア
   ```

---

## 🔧 トラブルシューティング標準手順

### Phase 1: 状況確認
```bash
# 1. 現在の状態
git status
ps aux | grep "next dev"
lsof -i :3000

# 2. エラーログ確認
# ターミナル出力を注意深く読む
```

### Phase 2: 基本対応
```bash
# 1. プロセス停止
pkill -f "next dev"

# 2. キャッシュクリア
rm -rf .next

# 3. サーバー再起動
npm run dev
```

### Phase 3: 復旧手順
```bash
# うまくいかない場合
git restore .
rm -rf .next
npm run dev
```

### Phase 4: 完全リセット（最終手段）
```bash
git stash
git pull origin main
rm -rf node_modules .next
npm install
npm run dev
```

---

## 📦 依存関係管理

### パッケージ追加時
1. **必要性を確認**
   - 既存パッケージで代用できないか
   - バンドルサイズへの影響

2. **インストール方法**
   ```bash
   npm install <package-name>
   # または
   npm install -D <package-name>  # devDependencies
   ```

3. **package.jsonの確認**
   - バージョンを固定するか検討
   - `package-lock.json`もコミット

---

## 🔐 セキュリティ

### 環境変数の取り扱い
1. **絶対にコミットしない**
   - `.env.local`は`.gitignore`で除外済み
   - 環境変数の値は絶対に表示しない

2. **公開情報との区別**
   - `NEXT_PUBLIC_*`: ブラウザに公開される
   - その他: サーバーサイドのみ

3. **APIキーの管理**
   - 開発環境と本番環境で分ける
   - 定期的にローテーション

---

## 🎨 コードスタイル

### TypeScript/React
1. **型安全性**
   - `any`の使用は最小限に
   - 適切なインターフェース定義

2. **コンポーネント設計**
   ```typescript
   // Good
   export default function MyComponent() {
     return <div>...</div>
   }
   
   // Import
   import MyComponent from './MyComponent'
   ```

3. **ファイル命名**
   - コンポーネント: `PascalCase.tsx`
   - ユーティリティ: `kebab-case.ts`
   - ページ: `page.tsx`, `layout.tsx`

---

## 📊 パフォーマンス

### 最適化の原則
1. **画像最適化**
   - Next.jsの`<Image>`コンポーネント使用
   - 適切なサイズとフォーマット

2. **コンポーネントの遅延読み込み**
   ```typescript
   const HeavyComponent = dynamic(() => import('./HeavyComponent'))
   ```

3. **不要な再レンダリング防止**
   - `useMemo`, `useCallback`の適切な使用
   - `React.memo`でコンポーネントをメモ化

---

## 🧪 テスト

### 動作確認項目
1. **基本動作**
   - [ ] トップページが表示される
   - [ ] ヘッダーが正しく表示される
   - [ ] ナビゲーションが機能する

2. **認証機能**
   - [ ] ログインできる
   - [ ] ログアウトできる
   - [ ] 保護されたページにリダイレクトされる

3. **主要機能**
   - [ ] お問い合わせフォームが表示される
   - [ ] 料金ページが表示される
   - [ ] ダッシュボードにアクセスできる

---

## 📝 ドキュメント

### 更新が必要な場合
1. **README.md**: セットアップ手順の変更
2. **docs/**: 新機能やトラブルシューティング
3. **コード内コメント**: 複雑なロジックの説明

---

## 🚀 デプロイ前チェック

### 本番環境へのデプロイ前
1. **ビルド確認**
   ```bash
   npm run build
   npm run start
   ```

2. **環境変数の確認**
   - 本番用の`.env.production`を設定
   - すべての必須環境変数が設定されているか

3. **セキュリティチェック**
   - APIキーが漏れていないか
   - 不要なログ出力を削除

---

## 🔒 動作確認済み処理の固定化戦略（重要）

### 問題: 毎日同じ機能が壊れる

**現状の問題:**
- 昨日動いていたOCRが今日動かない
- 新機能追加で既存機能が壊れる
- 毎日同じ問題が発生

**解決策: 動作確認済みの処理を固定し、安全に更新する仕組み**

---

### 📌 タグ付けによる固定化

#### 動作確認済みの状態にタグをつける

```bash
# 1. 全ての機能が正常動作することを確認
npm run dev
# → ブラウザで以下をテスト：
#   ✓ トップページ
#   ✓ ログイン/ログアウト
#   ✓ OCR機能（名刺読み取り）
#   ✓ プロフィール登録
#   ✓ 会社情報取得

# 2. 動作確認済みの状態をコミット
git add .
git commit -m "stable: 全機能動作確認済み - $(date +%Y%m%d)"

# 3. 安定版タグをつける（重要！）
git tag stable-ocr-$(date +%Y%m%d) -m "OCR機能動作確認済み"
git tag stable-$(date +%Y%m%d) -m "全機能動作確認済み"

# 4. タグをリモートにプッシュ
git push origin main
git push origin --tags
```

#### タグの命名規則

| タグ名 | 用途 | 例 |
|--------|------|-----|
| `stable-YYYYMMDD` | 全機能動作確認済み | `stable-20241223` |
| `stable-ocr-YYYYMMDD` | OCR機能のみ動作確認済み | `stable-ocr-20241223` |
| `stable-auth-YYYYMMDD` | 認証機能のみ動作確認済み | `stable-auth-20241223` |
| `working-YYYYMMDD-HHMM` | 一時的な動作確認ポイント | `working-20241223-1430` |

---

### 🔄 新機能追加時の安全な更新フロー

#### Step 1: 現在の安定版を確認

```bash
# 現在の安定版タグを確認
git tag | grep stable | sort -V | tail -5

# 最新の安定版に切り替えて動作確認
git checkout stable-20241223
npm run dev
# → 動作確認
```

#### Step 2: 新機能用ブランチを作成

```bash
# 最新の安定版から新機能ブランチを作成
git checkout -b feature/pdf-back-side-ocr stable-20241223

# または、mainブランチから作成（mainが最新の安定版の場合）
git checkout main
git checkout -b feature/pdf-back-side-ocr
```

#### Step 3: 新機能を実装（段階的に）

```bash
# 小さな変更 → 動作確認 → コミット
# 1ファイル変更
git add app/api/ocr-business-card/route.ts
git commit -m "feat: PDF裏面読み取り機能を追加（実験的）"

# 動作確認
npm run build  # ビルドエラーがないか
npm run dev    # サーバーが起動するか
# → ブラウザでOCR機能をテスト
```

#### Step 4: 既存機能への影響を確認

```bash
# 新機能だけでなく、既存機能も必ずテスト
# ✓ OCR機能（新機能）
# ✓ ログイン/ログアウト（既存）
# ✓ プロフィール登録（既存）
# ✓ 会社情報取得（既存）

# 問題があれば即座にロールバック
git reset --hard HEAD~1
```

#### Step 5: 問題なければマージ

```bash
# mainブランチに戻る
git checkout main

# 新機能ブランチをマージ
git merge feature/pdf-back-side-ocr --no-ff -m "feat: PDF裏面読み取り機能を追加"

# 再度全機能をテスト
npm run dev
# → 全機能をテスト

# 問題なければ新しい安定版タグ
git tag stable-$(date +%Y%m%d) -m "PDF裏面読み取り機能追加 - 全機能動作確認済み"
git push origin main --tags
```

---

### 🚨 問題発生時の即座ロールバック

#### パターン1: 特定のファイルだけ前の安定版に戻す

```bash
# OCR機能だけ前の安定版に戻す
git restore --source=stable-ocr-20241223 -- app/api/ocr-business-card/route.ts

# 動作確認
npm run dev
# → OCR機能をテスト

# 問題なければコミット
git add app/api/ocr-business-card/route.ts
git commit -m "fix: OCR処理を安定版(stable-ocr-20241223)に戻す"
git push origin main
```

#### パターン2: 全体を前の安定版に戻す

```bash
# 現在のブランチ名を記録
CURRENT_BRANCH=$(git branch --show-current)

# 最新の安定版タグを確認
git tag | grep stable | sort -V | tail -1

# 安定版に切り替え
git checkout stable-20241223

# 動作確認
npm run dev
# → 全機能をテスト

# 動いたら、mainブランチに戻してリセット
git checkout $CURRENT_BRANCH
git reset --hard stable-20241223

# リモートに強制プッシュ（慎重に！）
git push origin $CURRENT_BRANCH --force
```

---

### 📋 機能別の固定化チェックリスト

#### OCR機能の固定化

```bash
# OCR機能が正常動作することを確認
# → 名刺画像（JPEG/PNG）の読み取り
# → PDFの読み取り
# → エラーハンドリング

# 確認後、OCR専用タグ
git tag stable-ocr-$(date +%Y%m%d) -m "OCR機能動作確認済み"
```

#### 認証機能の固定化

```bash
# 認証機能が正常動作することを確認
# → ログイン
# → ログアウト
# → メール認証
# → プロフィール登録へのリダイレクト

# 確認後、認証専用タグ
git tag stable-auth-$(date +%Y%m%d) -m "認証機能動作確認済み"
```

---

### 🔧 Vercelでの固定化

#### 特定のコミット/タグに固定する

1. **Vercelダッシュボードで設定**
   - Settings → Git → Production Branch
   - 特定のタグを指定することはできないが、ブランチで管理可能

2. **安定版ブランチを作成**

```bash
# 安定版専用ブランチを作成
git checkout -b stable-release stable-20241223

# リモートにプッシュ
git push origin stable-release

# VercelでこのブランチをProduction Branchに設定
```

3. **更新時は慎重に**

```bash
# stable-releaseブランチを更新する場合
git checkout stable-release
git merge main --no-ff -m "stable: mainから安定版を更新"
# → 全機能をテスト
git push origin stable-release
```

---

### 📊 日々の運用フロー（固定化版）

#### 毎日の開発開始時

```bash
# 1. 最新の安定版タグを確認
git tag | grep stable | sort -V | tail -3

# 2. 現在の状態を確認
git status
git log --oneline -5

# 3. 問題があれば最新の安定版に戻す
git checkout stable-$(date +%Y%m%d)  # 最新の安定版
```

#### 機能追加・修正時

```bash
# 1. 新機能ブランチを作成（安定版から）
git checkout -b feature/xxx stable-$(date +%Y%m%d)

# 2. 変更を実装
# ... コード変更 ...

# 3. 動作確認（新機能 + 既存機能）
npm run build
npm run dev
# → 全機能をテスト

# 4. 問題なければコミット
git add .
git commit -m "feat: xxx機能を追加 - 全機能動作確認済み"

# 5. mainにマージ
git checkout main
git merge feature/xxx --no-ff

# 6. 再度全機能をテスト
npm run dev
# → 全機能をテスト

# 7. 問題なければ新しい安定版タグ
git tag stable-$(date +%Y%m%d) -m "xxx機能追加 - 全機能動作確認済み"
git push origin main --tags
```

#### 問題発生時

```bash
# 1. 最新の安定版タグを確認
LATEST_STABLE=$(git tag | grep stable | sort -V | tail -1)
echo "最新の安定版: $LATEST_STABLE"

# 2. 問題のファイルだけ戻す
git restore --source=$LATEST_STABLE -- <問題のファイル>

# 3. 動作確認
npm run dev
# → 問題が解決したか確認

# 4. コミット
git add .
git commit -m "fix: $LATEST_STABLEに戻す - 問題解決"
git push origin main
```

---

### 🎯 ベストプラクティス

#### ✅ やるべきこと

1. **機能追加前に必ず安定版タグを確認**
   ```bash
   git tag | grep stable | sort -V | tail -1
   ```

2. **新機能は別ブランチで開発**
   ```bash
   git checkout -b feature/xxx stable-YYYYMMDD
   ```

3. **動作確認は新機能 + 既存機能の両方**
   - 新機能だけテストするのではなく、既存機能も必ずテスト

4. **問題発生時は即座にロールバック**
   ```bash
   git restore --source=stable-YYYYMMDD -- <ファイル>
   ```

5. **動作確認済みの状態にタグをつける**
   ```bash
   git tag stable-$(date +%Y%m%d) -m "全機能動作確認済み"
   ```

#### ❌ やってはいけないこと

1. **mainブランチで直接実験**
   - 必ず別ブランチで開発

2. **新機能だけテストして既存機能を無視**
   - 必ず全機能をテスト

3. **動作確認せずにコミット**
   - 必ず動作確認してからコミット

4. **タグをつけ忘れる**
   - 動作確認済みの状態には必ずタグ

5. **複数の機能を一度に追加**
   - 1機能ずつ追加して動作確認

---

### 📝 タグ管理スクリプト（オプション）

`.scripts/tag-stable.sh` を作成：

```bash
#!/bin/bash
# 動作確認済みの状態にタグをつけるスクリプト

echo "🔍 現在の状態を確認中..."
git status

echo "📋 最新のコミット:"
git log --oneline -3

read -p "全機能が正常動作していますか？ (y/n): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "❌ 動作確認を先に完了してください"
    exit 1
fi

TAG_NAME="stable-$(date +%Y%m%d)"
echo "🏷️  タグを作成: $TAG_NAME"

git tag $TAG_NAME -m "全機能動作確認済み - $(date +%Y-%m-%d)"
git push origin main --tags

echo "✅ タグ $TAG_NAME を作成しました"
```

---

## 💡 重要な教訓（今回の事例から）

### ミドルウェアの重要性
- `middleware.ts`は認証管理の要
- 削除や移動は慎重に
- 存在確認を習慣化

### キャッシュ問題への対処
- エラーが解決しない → キャッシュクリア
- `rm -rf .next`は強力な武器

### Git管理の重要性
- 頻繁にコミット
- 問題時はすぐに戻せる
- `git restore .`は最後の砦

### 段階的な変更
- 一度に多くを変更しない
- 小さな変更を積み重ねる
- 各ステップで動作確認

### 動作確認済み処理の固定化（新規追加）
- **動作確認済みの状態には必ずタグをつける**
- **新機能は別ブランチで開発し、既存機能も必ずテスト**
- **問題発生時は即座に安定版タグに戻す**
- **毎日の問題を防ぐため、安定版タグを活用**

---

## 📞 サポート

問題が発生した場合は、以下のドキュメントを参照：
- `docs/troubleshooting/server-crash-analysis.md`: サーバークラッシュ分析
- `docs/setup/README-SETUP.md`: セットアップガイド
- `docs/guides/`: 各種ガイド

---

## 🔄 このルールの更新

新しい教訓や改善点があれば、このファイルに追加してください。
バージョン: 2.2
最終更新: 2024-12-23

### 更新履歴
- v2.2 (2024-12-23): 動作確認済み処理の固定化戦略を追加 - タグ管理、スクリプト、運用フローを実装
- v1.0 (2024-12-17): 初版作成
