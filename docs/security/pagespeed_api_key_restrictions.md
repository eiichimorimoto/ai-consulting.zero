# PageSpeed API キーの制限設定（セキュリティ強化）

## 🔒 なぜ制限が必要か

```
制限なし:
- どのウェブサイトからでも使える
- 他のAPIでも使える
- APIキーが漏洩した場合、悪用されやすい
- セキュリティリスク: 高

制限あり:
- 指定したウェブサイトからのみ使える
- 指定したAPIのみ使える
- APIキーが漏洩しても悪用されにくい
- セキュリティリスク: 低
```

---

## 📋 制限設定手順（5分）

### Step 1: Google Cloud Console にアクセス

```
https://console.cloud.google.com/apis/credentials
```

### Step 2: 作成したAPIキーをクリック

```
キー一覧から:
AIzaSy********************* # 作成したキー

をクリック
```

### Step 3: アプリケーションの制限を設定

#### オプション1: HTTPリファラー（推奨・開発環境）

```
☑ HTTPリファラー（ウェブサイト）

ウェブサイトの制限を追加:
- http://localhost:3000/*
- http://localhost:3001/*
- https://ai-consulting-zero.vercel.app/*
- https://*.vercel.app/*
```

**メリット**:
- 開発環境（localhost）で使える
- 本番環境（Vercel）で使える

**デメリット**:
- Server-side（API Routes）からは使えない可能性

#### オプション2: なし（開発中のみ推奨）

```
☑ なし

※ 一時的にこのまま使用し、本番デプロイ前に制限追加
```

---

### Step 4: API の制限を設定（必須）

```
☑ キーを制限

APIを選択:
✓ PageSpeed Insights API

※ 他のAPIはチェックを外す
```

**効果**:
- このキーはPageSpeed Insights APIでのみ使える
- 他のAPI（Custom Search等）では使えない
- APIキーが漏洩しても被害を最小限に

---

### Step 5: 保存

```
「保存」ボタンをクリック
```

**注意**: 設定が反映されるまで数分かかる場合があります

---

## 🧪 制限追加後の動作確認

### 1. 5分待つ

設定反映を待ちます

### 2. 開発サーバー再起動

```bash
pkill -f "next"
npm run dev
```

### 3. Web サイト分析を実行

```
http://localhost:3000/dashboard/website-analysis
↓
URLを入力して分析
↓
エラーが出ないか確認
```

### 4. エラーが出た場合

**エラー例**:
```
403 Forbidden
API key not valid
```

**原因**:
- HTTPリファラー設定が間違っている
- Server-sideからのリクエストが制限されている

**解決策**:
- 制限を「なし」に戻す
- または「IPアドレス」制限に変更

---

## 🎯 推奨設定（環境別）

### 開発環境（localhost）

```
アプリケーションの制限: なし
API の制限: PageSpeed Insights API のみ

理由:
- 開発中は柔軟性が必要
- API制限だけでも十分な保護
```

### 本番環境（Vercel）

```
アプリケーションの制限: HTTPリファラー
- https://ai-consulting-zero.vercel.app/*
- https://*.vercel.app/*

API の制限: PageSpeed Insights API のみ

理由:
- 本番環境は厳密に制限
- 漏洩時の被害を最小化
```

---

## 📊 セキュリティレベル比較

| 設定 | セキュリティ | 柔軟性 | 推奨度 |
|-----|------------|-------|--------|
| 制限なし | ⭐☆☆ | ⭐⭐⭐ | ❌ |
| API制限のみ | ⭐⭐☆ | ⭐⭐⭐ | ✅ 開発環境 |
| HTTPリファラー | ⭐⭐⭐ | ⭐⭐☆ | ✅ 本番環境 |
| IPアドレス | ⭐⭐⭐ | ⭐☆☆ | △ Server-side専用 |

---

## 💡 ベストプラクティス

### 1. 開発環境と本番環境で別のキーを使う

```
.env.local（開発）:
GOOGLE_PAGESPEED_API_KEY=AIzaSy********************* # 開発用キー

Vercel環境変数（本番）:
GOOGLE_PAGESPEED_API_KEY=AIzaSy********************* # 本番用キー（別のキーを推奨）
```

### 2. 定期的にキーをローテーション

```
3ヶ月に1回:
- 新しいキーを作成
- 古いキーを削除
```

### 3. キー漏洩時の対応

```
1. すぐに古いキーを削除
2. 新しいキーを作成
3. .env.local を更新
4. Vercel環境変数を更新
5. デプロイ
```

---

## 📝 まとめ

**今すぐやること（優先度順）**:

1. ✅ **動作確認**（制限なしのまま）
2. ⏰ **API制限を追加**（PageSpeed APIのみ）
3. 📅 **本番デプロイ前にHTTPリファラー追加**

**今はまず動作確認を優先してください！**
