# Dify検索要約ワークフロー作成手順

**ワークフロー名**: `search-summarizer`  
**目的**: Web検索結果を箇条書き形式で要約

---

## Step 1: ワークフロー作成

1. Dify管理画面にログイン
2. 左メニュー「ワークフロー」をクリック
3. 「新規作成」→「ワークフロー」を選択
4. 名前: `search-summarizer`
5. 説明: `Web検索結果の要約生成`

---

## Step 2: 入力変数定義

「入力」ノードをクリックし、以下の変数を追加：

| 変数名 | 型 | 必須 | 説明 |
|--------|---|------|------|
| `query` | テキスト | ✓ | 検索クエリ |
| `result1_title` | テキスト | ✓ | 検索結果1のタイトル |
| `result1_desc` | テキスト | ✓ | 検索結果1の説明 |
| `result1_url` | テキスト | ✓ | 検索結果1のURL |
| `result2_title` | テキスト | ✓ | 検索結果2のタイトル |
| `result2_desc` | テキスト | ✓ | 検索結果2の説明 |
| `result2_url` | テキスト | ✓ | 検索結果2のURL |
| `result3_title` | テキスト | ✓ | 検索結果3のタイトル |
| `result3_desc` | テキスト | ✓ | 検索結果3の説明 |
| `result3_url` | テキスト | ✓ | 検索結果3のURL |

---

## Step 3: LLMノード追加

1. 「+」ボタン → 「LLM」を選択
2. モデル: **GPT-4-turbo** または **Claude 3.5 Sonnet**推奨
3. プロンプト設定:

```
あなたは情報要約の専門家です。
以下の検索結果を、ビジネスコンサルティングの文脈で箇条書き形式で要約してください。

検索キーワード: {{query}}

検索結果1:
タイトル: {{result1_title}}
説明: {{result1_desc}}
URL: {{result1_url}}

検索結果2:
タイトル: {{result2_title}}
説明: {{result2_desc}}
URL: {{result2_url}}

検索結果3:
タイトル: {{result3_title}}
説明: {{result3_desc}}
URL: {{result3_url}}

要件:
- 箇条書き形式（3-5個のポイント）
- 各ポイントは簡潔に（30-50文字）
- 重要な数値やデータを含める
- ビジネス判断に役立つ情報を優先
- 各ポイントは「•」（中黒）で始める

出力形式:
• ポイント1
• ポイント2
• ポイント3
• ポイント4（オプション）
• ポイント5（オプション）

注意: 参考URLは含めないでください（別途処理します）
```

4. 温度: **0.7** （バランス型）
5. 最大トークン: **500**

---

## Step 4: 出力変数定義

「出力」ノードをクリックし、以下の変数を追加：

| 変数名 | 型 | ソース |
|--------|---|--------|
| `summary` | テキスト | LLMノードの出力 |

---

## Step 5: テスト実行

1. 右上の「テスト」ボタンをクリック
2. サンプルデータ入力:

```json
{
  "query": "中小企業 売上向上",
  "result1_title": "中小企業の売上向上に効果的な5つの施策",
  "result1_desc": "中小企業が売上を伸ばすために実践すべき具体的な施策を紹介します。新規顧客獲得、既存顧客の単価向上、リピート率改善など。",
  "result1_url": "https://example.com/sales-improvement",
  "result2_title": "2026年版 業界別成長率レポート",
  "result2_desc": "各業界の平均成長率と市場動向を詳しく分析。製造業15%、サービス業18%、小売業12%など。",
  "result2_url": "https://example.com/growth-report-2026",
  "result3_title": "コスト削減の成功事例10選",
  "result3_desc": "実際の企業が実践したコスト削減施策とその効果を紹介。固定費削減で年間500万円、業務効率化で人件費20%削減など。",
  "result3_url": "https://example.com/cost-reduction-cases"
}
```

3. 期待される出力:

```
• 新規顧客獲得が最も効果的（年間+15%成長）
• デジタルマーケティング活用で成長率18%実現
• 既存顧客の単価向上で安定的な増収が可能
• 業界平均は12-15%の成長率（2026年）
• コスト削減と併用で効果最大化（年間500万円削減）
```

---

## Step 6: 公開とAPIエンドポイント取得

1. 右上の「公開」ボタンをクリック
2. 「API」タブに移動
3. **APIエンドポイントURL**をコピー:
   ```
   https://api.dify.ai/v1/workflows/run/[workflow-id]
   ```

4. **APIキー**を確認（既存のDIFY_API_KEYを使用）

---

## Step 7: .env.localに追加

コピーしたAPIエンドポイントURLを`.env.local`に追加：

```env
# Dify Search Summarizer Workflow
DIFY_SEARCH_SUMMARIZER_URL=https://api.dify.ai/v1/workflows/run/[実際のworkflow-id]
```

---

## トラブルシューティング

### エラー: "Variable not found"
→ 入力変数名のスペルミスを確認

### エラー: "Prompt too long"
→ 最大トークンを増やす（500 → 1000）

### 要約が箇条書きにならない
→ プロンプトの「出力形式」セクションを強調
→ 温度を下げる（0.7 → 0.3）

### 要約が長すぎる
→ 「各ポイントは簡潔に（30-50文字）」を強調
→ 最大トークンを減らす（500 → 300）

---

## 完了！

ワークフロー作成が完了したら、APIエンドポイントURLを提供してください。
