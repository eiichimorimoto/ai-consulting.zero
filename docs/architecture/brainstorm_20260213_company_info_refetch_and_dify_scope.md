# 🧠 Brainstorm: 会社情報の再取得とDifyコンテキスト拡張

> 作成日: 2026-02-13  
> 目的: 再取得UI・履歴の要否・Dify送信範囲（会社＋業界＋世界情勢）を整理し、戦略を立てる

---

## 1. 要件の整理

### 1.1 会社情報の再取得

| 項目 | 内容 |
|------|------|
| **やりたいこと** | 新規登録時と同様の「会社情報の収集」を、既存ユーザーが任意のタイミングで実行できるようにする |
| **再取得時の扱い** | 分析項目（SWOT・マーケット・地域情報など）および会社への提言を**すべて更新**する |
| **UIの候補** | (A) ダッシュボードにボタンを追加 (B) アカウント／設定の「会社情報」セクションに再取得ボタンを追加 |

**現状の実装**

- **初回取得**: `auth/complete-profile` で Web 検索・HP クロール等 → `POST /api/company-intel` → 結果を `companies` に保存（`retrieved_info` 含む）
- **会社情報の編集**: 設定画面（`SettingsContent`）で手動編集 → `companies` を UPDATE（上書き）
- **履歴**: **取っていない**。`companies` は 1 会社 1 行で、`retrieved_info` も「直近 1 回分」のみ（再取得で上書き）

---

### 1.2 履歴を取る場合の検討

| 観点 | 内容 |
|------|------|
| **何を残すか** | 取得回数（何度目か）、取得日時、その時点のスナップショット（会社情報＋必要なら `retrieved_info`） |
| **AI相談での利用** | 原則**最新 1 件**をコンテキストとして利用 |
| **比較** | ユースケースによっては「前回と今回の差分」「過去と最新の状況比較」が必要になる可能性あり |
| **コスト** | ストレージ増、スナップショット設計・API・UI の実装が増える |

---

### 1.3 Dify に送る情報の範囲（現状と課題）

| 種類 | 現状 | 課題・要望 |
|------|------|------------|
| **会社情報** | ✅ 送っている（`getBaseContext` の company） | 再取得で更新すればそのまま最新が渡る |
| **業界情報** | ⚠️ 一部のみ（マーケット・地域は `dashboard_data` 経由で利用）／業界動向・業界予測は仕様書で「未実装」 | 業界トレンド・業界予測を Dify コンテキストに含めたい |
| **世界情勢** | ❌ 世界ニュース等は仕様書で「未実装」 | 世界情勢を勘案した相談にしたい |

**重さについて**

- 会社＋業界＋世界情勢を毎回 live 取得すると、**API 呼び出し数・レイテンシ・トークン数が増える**
- キャッシュ（`dashboard_data` のような「一定時間は再利用」）や、Dify 側のプロンプト設計（長文を要約して渡す等）の検討が必要

---

## 2. 現状の技術メモ

- **会社情報の保存**: `companies` 1 行、`retrieved_info` JSONB で「直近 1 回」のみ
- **再取得の実体**: `POST /api/company-intel` を再度叩き、返却を `companies`（＋`retrieved_info`）に反映する流れで足りる
- **分析・提言**: ダッシュボードの各種 API（market, local-info, swot-analysis, industry-trends, world-news 等）や `dashboard_data` に依存。再取得後に「分析を更新」するには、これらの再実行またはキャッシュ無効化が必要
- **Dify コンテキスト**: `getExternalInformation` で market / local_info を `dashboard_data` から取得。業界・世界は未統合

---

## 3. 戦略案（フェーズ分け）

### Phase 1: 再取得の実装（履歴なし・Dify は現状のまま）

**目的**: 再取得したいニーズにまず応える。

1. **UI**
   - **推奨**: **設定の「会社情報」に「再取得」ボタン**を追加  
     - 会社情報を編集する画面と同一なので、「今の会社情報を Web から再取得して上書きする」が分かりやすい  
   - ダッシュボードにボタンを増やす案は、設定にまとめたうえで「ダッシュボードから設定の会社情報へ誘導」でも可
2. **処理**
   - 再取得 = `POST /api/company-intel`（既存）を呼び、返却で `companies` を UPDATE（新規登録時と同様）
   - 再取得完了後は「分析項目・提言を更新する」ために、  
     - **案 A: キャッシュ無効化** … 該当会社の `dashboard_data` を削除し、次回ダッシュボードを開いたときに再計算  
     - **案 B: 即時再実行** … 再取得完了直後に分析 API を一括で呼び、`dashboard_data` を更新  
   - どちらにするかは負荷・UX で決定（下記「分析更新の2案」参照）
3. **履歴**
   - Phase 1 では**履歴は作らない**（現行の 1 行上書きのまま）。  
     - 「何度目か」「過去との比較」は Phase 2 以降で検討

---

#### 分析更新の2案：意味とメリット・デメリット

**背景**  
再取得で `companies` と `retrieved_info` は最新になるが、SWOT・マーケット・地域情報・業界動向・世界情勢・業界予測などは `dashboard_data` に**キャッシュ**されている。そのキャッシュは「古い会社情報」を元にした分析なので、再取得後は「更新する」必要がある。

|  | **案 A: キャッシュ無効化** | **案 B: 即時再実行** |
|---|---------------------------|----------------------|
| **意味** | 再取得が終わったら、その会社の `dashboard_data`（分析キャッシュ）を**削除するだけ**。分析の再計算はしない。 | 再取得が終わったら、**その場で** マーケット・地域・SWOT・業界動向・世界情勢・業界予測などの API を順番に呼び、結果を `dashboard_data` に保存する。 |
| **ユーザー体験** | 再取得ボタンは比較的すぐ終わる。次にダッシュボードを開いたとき「キャッシュがない」ので、そのタイミングで分析が再実行され、表示される。 | 再取得ボタンを押すと「再取得＋分析更新」の間（数十秒〜1分程度）待つことになる。終わればダッシュボードを開いたときにはすでに最新の分析が並んでいる。 |
| **メリット** | 実装が軽い（再取得 API のあとに該当 `dashboard_data` を削除するだけ）。再取得完了時のサーバー負荷が増えない。再取得のレスポンスが早い。 | 再取得を1回やれば「会社情報も分析もまとめて最新」になる。ダッシュボードを開いたときは待たずに最新分析が見られる。 |
| **デメリット** | 再取得直後にダッシュボードを開くと、その時点で分析の再計算が走るため「読み込み中」で待つことになる。 | 再取得完了まで時間がかかる。複数 API を連続で叩くため、レート制限・サーバー負荷・タイムアウトのリスクがある。実装が重い（各分析 API の呼び出し・エラーハンドリング・ローディング表示が必要）。 |

**選び方の目安**  
- まずは**案 A（キャッシュ無効化）**で進め、「再取得のあとすぐダッシュボードで待ち時間が気になる」という声が出たら、案 B や「バックグラウンドで再実行して完了したら通知」などの拡張を検討するのが現実的。

---

#### UX の整理：ボタン配置・キャッシュ・定期更新

**1. キャッシュ無効化 ＋ 再取得ボタンを「設定」に置く場合**

- 再取得ボタンを押す → 会社情報を更新し、**その会社の分析キャッシュ（`dashboard_data`）を消すだけ**。
- **次にダッシュボードを開いたとき**だけ、キャッシュがないので新規登録時と同じように分析を一括取得する。
- 他ページ（設定・相談など）からダッシュボードに**戻ってきただけ**のときは、すでにキャッシュがあるので**再取得は走らない**。何度も「帰ってくるたびに全部再計算」にはならない。
- **UX**: 「設定で再取得した → 次にダッシュボードを開くと最新になる」と説明しやすく、挙動も分かりやすい。

**2. 再取得ボタンを「ダッシュボード」に置く場合**

- キャッシュ無効化**だけ**だと、ボタンを押しても**今表示しているダッシュボードの内容は古いまま**（すでに読み込んだキャッシュを表示しているため）。ユーザーは「更新されたのか分からない」「押したのに何も変わらない」と不満になりやすい。
- そのため、**ダッシュボードに再取得ボタンを置くなら**、次のどちらかが必要：
  - **即時再実行**: 押したら会社情報更新＋分析 API をその場で実行し、完了したら**現在の画面を更新**する（ローディング表示必須）。
  - または「再取得しました。画面を更新しますか？」と促し、**画面リロード or ダッシュボード用データの再取得**で表示を書き換える。
- キャッシュ無効化のみで、ダッシュボード上に「再取得」だけ置くのは **UX 的に避ける**のがよい。

**3. 定期更新（月次バッチなど）**

- 会社情報や分析を**定期的に更新**する（例：月1回バッチで再取得＋分析の再実行）という選択肢もある。
- **メリット**: ユーザーがボタンを押さなくても、ある程度最新が保たれる。「いつ更新されたか」をダッシュボードに表示すれば透明性も出る。
- **デメリット**: 実行タイミング・コスト・外部 API のレート制限・「今の表示はいつ時点のデータか」の説明が必要。実装はバッチ・キュー・エラー通知などが増える。
- **位置づけ**: Phase 1 では必須にせず、**Phase 2 以降の拡張**として「月次でキャッシュ更新」などを検討するのが現実的。

**4. 結論（UX 方針）**

| 方針 | 内容 |
|------|------|
| **再取得ボタン** | **設定の会社情報**に置く。キャッシュ無効化と組み合わせる。 |
| **ダッシュボード** | 再取得ボタンは置かない（Phase 1）。置く場合は「押したら即時更新 or 明示的な画面更新」を必須とする。 |
| **他ページから戻る** | キャッシュがある限り再取得は繰り返さない（ダッシュボード初回表示時のみ、キャッシュが空なら一括取得）。 |
| **定期更新** | 月次バッチ等は Phase 2 で検討。 |

---

**成果物イメージ**

- 設定の会社情報に「会社情報を再取得」ボタン
- 再取得 API 呼び出し → `companies` 更新 → 分析の更新（上記 A or B）
- ドキュメント（どこにボタンがあるか、再取得後に何が更新されるか）

---

### Phase 2: 会社情報の履歴（任意）

**目的**: 「何度目の取得か」「最新を相談に使う」「将来の比較」に備える。

1. **スキーマ**
   - 例: `company_info_snapshots`（`company_id`, `fetched_at`, `fetch_number`, `snapshot` JSONB）  
     - または `companies` は「最新のみ」のまま、履歴だけ別テーブルに格納
2. **ルール**
   - 再取得のたびに 1 行 insert（`fetch_number` は連番 or 日時ベース）
   - AI 相談・Dify コンテキストは**常に最新 1 件**（`companies` または最新スナップショット）を使用
3. **比較**
   - 「前回と今回の差分」「過去と最新の比較」は、履歴が溜まってから UI／API で追加検討

---

### Phase 3: Dify コンテキストの拡張（会社＋業界＋世界情勢）

**目的**: Dify に「会社情報だけではなく業界・世界情勢も勘案した相談」をさせる。

1. **追加する情報**
   - **業界**: 業界動向（`/api/dashboard/industry-trends`）、業界予測（`/api/dashboard/industry-forecast`）など  
     - 既存の `dashboard_data` があれば流用、なければ context 取得時に API を叩く
   - **世界**: 世界ニュース（`/api/dashboard/world-news`）など  
     - 同上
2. **重さへの対策**
   - **キャッシュ**: 業界・世界も `dashboard_data` のように「種別ごとにキャッシュし、有効期限内は再利用」
   - **要約**: 長文は要約してから Dify に渡す、または Dify 側で「コンテキストの優先度・長さ」を設計
   - **遅延ロード**: 相談開始時に必須にするのではなく、必要に応じて Dify ワークフロー側で「業界・世界を追加取得」する分岐も検討
3. **実装**
   - `getExternalInformation`（または別関数）で industry-trends / industry-forecast / world-news を取得  
   - `ExternalInformation` 型を拡張して業界・世界のブロックを追加  
   - 既存の market / local_info と同様、キャッシュキー・TTL を決める

---

## 4. まとめ（優先度と判断）

| 優先度 | 内容 | 備考 |
|--------|------|------|
| **高** | 会社情報の再取得（設定の会社情報にボタン） | 新規登録と同じ収集フローで実装可能。履歴なしでよいなら Phase 1 のみで完結 |
| **高** | 再取得後の「分析・提言の更新」 | キャッシュ削除 or 分析 API 再実行のどちらかで一貫させる |
| **中** | 会社情報の履歴 | 「何度目か」「過去 vs 最新」が必要になったら Phase 2 で設計 |
| **中〜高** | Dify に業界・世界情勢を渡す | 仕様として「結構重い」ので、キャッシュ・要約・段階的ロードで Phase 3 として計画 |

**次のアクション案**

1. Phase 1 の UI 配置を確定する（設定の会社情報に再取得ボタンのみか、ダッシュボードから誘導も入れるか）
2. 再取得後の分析更新を「キャッシュ無効化」か「即時再実行」か決める
3. 履歴が必要かどうか、 product 側で一度判断する（必要なら Phase 2 のスキーマ案を詳細化）
4. Dify の業界・世界は、Phase 3 として「どの API をいつ叩くか」「キャッシュキー」を設計ドキュメントに落とす

---

## 5. ファイル影響範囲（Phase 1 想定）

| 種別 | パス | 変更内容 |
|------|------|----------|
| UI | `components/SettingsContent.tsx` または 設定の会社情報セクション | 再取得ボタン、ローディング、成功／失敗メッセージ |
| API | 既存 `POST /api/company-intel` | 再利用（変更なし or 軽微） |
| 保存 | `companies` の UPDATE | complete-profile と同様の項目を更新 |
| 分析の更新 | `dashboard_data` の削除 or 再計算トリガー | 新規 API または既存分析 API の呼び出し |
| ドキュメント | 本ファイル、必要なら design_*.md | 仕様の確定内容を追記 |

---

以上、整理と戦略案です。Phase 1 の UI と「分析の更新」のどちらにするかを決めれば、実装計画に落とし込めます。
