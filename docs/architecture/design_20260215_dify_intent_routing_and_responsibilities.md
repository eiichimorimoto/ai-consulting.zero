# Dify の意図分岐と責務一覧

**日付**: 2026-02-15  
**目的**: ユーザーの回答・要望に応じて Dify 側の対応を変える設計と、Dify で担うべき役割の整理。

---

## 1. ユーザー回答に応じた分岐（意図ルーティング）

「財務分析してほしい」「補助金を調べて」など、**ユーザーの発言内容で処理を切り替えたい**場合の判断は Dify 内で行うのがよい。

### 1.1 分岐の例と対応

| ユーザーの意図（例） | Dify でやること | 備考 |
|---------------------|-----------------|------|
| **財務分析してほしい** | 添付ファイルの有無を確認し、あればファイル内容を読み取り対象に含める。数値・表の扱いが重要なら **Claude（数値に強い）** を選択。 | アプリから「添付あり」フラグやファイル要約を Dify に渡す前提。 |
| **数字の文責が強い分析** | モデルを **Claude** に切り替える（またはサブワークフローで Claude を呼ぶ）。 | Dify のワークフローで「意図＝数値分析」のときだけ Claude ノードを使う。 |
| **レポーティングを綺麗にまとめたい** | 回答フォーマットを「レポート形式」に統一（見出し・箇条書き・表）。必要なら **レポート用テンプレート** をプロンプトに持たせる。 | 既存の「回答フォーマット」を強化するか、意図に応じてテンプレを切り替え。 |
| **RAG を使いたい** | 意図が「社内資料に基づく」「ナレッジベースを参照」などなら **RAG ノード** を実行。対象データセットは相談カテゴリや事前設定に応じて選択。 | Dify の Knowledge ノード／RAG ブロックで実装。 |
| **最近の補助金を教えて** | **Web 検索** を実行。可能なら「その地域の公的 HP」に絞る（検索クエリに地域・省庁サイトを含める）。 | Dify の Web Search ツール／カスタムツール（公的サイト用）を呼ぶ。 |

### 1.2 実装の考え方（Dify 内）

- **意図分類（Intent）**  1
  - 最初のノードで「ユーザー発言＋会話履歴」から意図を判定する。  
  - 例: `財務分析` / `数値分析` / `レポート作成` / `ナレッジ参照` / `最新情報・補助金等` / `一般相談`。
- **分岐**  
  - 意図に応じてサブワークフローやツールの組み合わせを変える。  
    - 財務・数値 → 添付利用＋Claude  
    - レポート → レポート用プロンプト／テンプレ  
    - ナレッジ → RAG ノード  
    - 補助金・最新情報 → Web 検索（必要なら地域・公的サイト指定）
- **判断は Dify 内に集約**  
  - 「いつファイルを見るか」「いつ RAG か」「いつ Web 検索か」は、すべて Dify のワークフロー／プロンプトで決める。アプリは「メッセージ・添付・コンテキスト」を渡すだけにする。

---

## 2. 各能力の実装メモ

### 2.1 添付ファイルの処理（財務分析など）

- **アプリ**: 相談画面で添付されたファイルを、要約やテキスト化したうえで Dify に渡す（またはファイル ID と要約を渡す）。  
  - 既存の `attachedFiles` やメッセージに紐づくファイルを、Dify の inputs に含める。
- **Dify**:  
  - 「添付あり」かつ「財務／数値分析」系の意図のとき、その内容をコンテキストに含めて回答。  
  - 必要なら「ファイル要約」用の LLM ノードを前段に置く。

### 2.2 数字に強い Claude の利用

- **Dify**:  
  - ワークフローに「LLM ノード」を複数用意し、意図に応じて使い分ける。  
  - 例: 意図が `数値分析` / `財務分析` のときは **Claude**、それ以外は現行のモデル。  
  - または「数値チェック用」に Claude を後段で使う（メインは現行モデル、数値部分だけ Claude に検証させる）など。

### 2.3 レポーティングを綺麗にまとめる

- **Dify**:  
  - プロンプトで「見出し・箇条書き・表・重要ポイントは太字」を指定（現状の拡張）。  
  - 意図が「レポート」「まとめ」のときは、**レポート用のテンプレート**（章立てや文言）をプロンプトに差し込む。  
  - 必要なら「レポート用」の専用 LLM ノードを分け、フォーマット指示を強くする。

### 2.4 RAG

- **Dify**:  
  - Knowledge ノード／Document 検索ノードで RAG を実行。  
  - 意図が「社内資料参照」「ナレッジベースで調べて」などになったときだけ RAG を有効にする。  
  - データセットは「全社共通」「カテゴリ別」など、Dify 側で設定・選択。

### 2.5 Web 検索（補助金・公的情報など）

- **Dify**:  
  - **Web Search** ツール（またはカスタムツール）をワークフローに組み込む。  
  - 意図が「補助金」「制度」「最新情報」などなら検索を実行。  
  - 「その地域の公的 HP」に寄せるには、  
    - ユーザー入力や会社情報の「地域」から検索クエリを組み立てる、  
    - または検索対象を「gov ドメイン」「都道府県サイト」に限定するツールを用意する。

---

## 3. Dify でやるべきこと一覧（その他）

上記に加え、Dify に寄せておくとよい責務を整理する。

| 責務 | 内容 |
|------|------|
| **会話の一貫性** | 過去メッセージを参照し、文脈を踏まえた回答。会話履歴は Dify の conversation で保持するか、アプリから毎回渡す。 |
| **曖昧な質問の明確化** | 「それ」「あれ」「〜日」などを、プロンプトで「意図を確認してから答える」と明示（現状どおり）。 |
| **回答フォーマット** | 見出し・箇条書き・太字・日本語など。意図に応じて「通常」と「レポート」を切り替え可能にする。 |
| **質問形式の出し分け** | 文書で質問するか、選択肢（`app_choices`）を付けるかは Dify の出力で制御（別ドキュメント参照）。 |
| **コンテキストの組み立て** | 会社情報・担当者情報・課題（カテゴリ/サブカテゴリ）・添付要約・会話履歴を、意図に応じて必要なだけ LLM に渡す。 |
| **ステップ進行の示唆（任意）** | 「課題のヒアリング」「現状分析」など、現在の STEP に応じた質問の仕方や、次の STEP への誘導をプロンプトで指示。 |
| **外部情報の利用判断** | 業界・世界情勢・補助金など、**いつ**どの外部情報（ダッシュボード API 結果・Web 検索・RAG）を参照するかは Dify 内で判定。 |
| **モデル・ツールの選択** | 意図に応じた LLM（Claude / 現行モデル）の切り替え、および RAG / Web 検索 / コード実行などのツール起動。 |

---

## 4. ワークフロー構成イメージ（Dify）

```
[開始]
   ↓
[ユーザー発言 + 会社情報・課題・添付有無 を inputs で受け取る]
   ↓
[意図分類ノード]  ← LLM で「財務分析 / 数値分析 / レポート / RAG / Web検索 / 一般」などを判定
   ↓
[条件分岐]
   ├─ 財務・数値 → [添付をコンテキストに含める] → [Claude ノード] → [回答]
   ├─ レポート   → [レポート用プロンプト] → [LLM ノード] → [回答]
   ├─ ナレッジ   → [RAG ノード] → [LLM ノード] → [回答]
   ├─ 補助金等   → [Web 検索ノード]（必要なら地域・公的サイト指定）→ [LLM ノード] → [回答]
   └─ 一般       → [LLM ノード]（現行）→ [回答]
   ↓
[回答を整形・フォーマット]
   ↓
[アプリに返す]
```

- 意図分類は「プロンプト＋選択肢」で LLM にさせてもよいし、Dify の「条件分岐」でキーワードベースにしてもよい（まずは LLM で柔軟に判定するのがおすすめ）。
- 補助金の「地域」は、会社情報の住所やユーザー入力から Dify の変数にし、検索クエリに組み込む。

---

## 5. まとめ

- **ユーザーの回答で LLM の対応を変える** → Dify 内で「意図分類 → 分岐」し、添付利用・Claude・レポート・RAG・Web 検索を出し分ける。
- **財務分析** → 添付の扱いと数値重視なので、添付コンテキスト＋Claude。
- **数字の文責** → 該当意図のときだけ Claude を利用。
- **レポーティング** → レポート用プロンプト／テンプレを意図に応じて適用。
- **RAG** → 意図が「ナレッジ参照」のときだけ RAG ノードを実行。
- **Web 検索（補助金など）** → 意図が「最新情報・制度」のとき Web 検索を実行し、必要なら地域・公的サイトを指定。判断は Dify 内。
- **その他 Dify でやるべきこと** → 会話一貫性・曖昧さの明確化・回答フォーマット・質問形式の出し分け・コンテキスト組み立て・（任意で）ステップ進行・外部情報の利用判断・モデル・ツールの選択。

アプリ側は「メッセージ・添付要約・会社情報・課題」を渡し、Dify が「何をしてどう返すか」を一括して決める形にすると、役割分担がはっきりする。
