# 設計: Dify提示コンテンツのレポートPDFエクスポート

> 要件: 会話そのものではなく、**Difyが提示した内容**をレポート形式に整え、個別にPDF化する

---

## 1. 要件の整理

### 現状（実装済み）のイメージ
- **対象**: 画面の会話（ユーザー＋AIのやり取り）
- **単位**: 「会話全体」「SWOT分析」「業界動向」などキーワードで抽出したセクション
- **出力**: 会話ログ風 or 簡易抽出テキストをそのままPDF化

### 望ましい姿
- **対象**: **Difyが提示してきた内容だけ**（AIの回答・分析・提言など）
- **体裁**: レポートらしく整える（タイトル・見出し・箇条書き・余白など、きれいなフォーマット）
- **単位**: **個別の内容**＝「この1本のDify回答を1本のレポートPDFにする」または「選んだ複数本を1つのPDFにまとめる」

つまり:
- 画面の会話ログをそのまま出すのではなく、
- **Difyの1回（または1ブロック）の出力 = 1つのレポート**として扱い、
- それをレポート用レイアウトで成型してPDFにする。

---

## 2. 用語とデータの対応

| 用語 | 意味 | データ上の対応 |
|------|------|----------------|
| Difyが提示した内容 | AI（Dify）が返した1回分の回答・分析・提言など | `messages` のうち `role === 'assistant'` の1件、またはその中の1ブロック |
| 個別の内容 | エクスポートの1単位 | 上記の「1件」または「1ブロック」 |
| レポートらしくモディファイ | 見出し・段落・リストなどを整えた体裁 | テンプレート＋Markdown/テキストのパースでHTML→PDF |

---

## 3. データモデル（案）

### 3.1 エクスポート対象アイテム（Dify提示コンテンツ1件）

```
DifyContentItem = {
  id: string;              // 一意ID（例: message.id または `${sessionId}-${index}`）
  type: 'analysis' | 'recommendation' | 'summary' | 'other';  // 内容の種類（表示用）
  title: string;           // レポートのタイトル（例: 「SWOT分析」「経営提言」または先頭行から生成）
  body: string;           // Difyの生テキスト（Markdown想定）
  sourceMessageIndex?: number;  // 元メッセージのインデックス（紐付け用）
  createdAt?: string;      // 元メッセージの日時
}
```

- **取得元**: `messages` を走査し、`role === 'assistant'` かつ `content` が空でないものを「Difyが提示した内容」として列挙。
- 必要なら、1件の長い回答を「見出し」で分割して複数アイテムにしてもよい（将来拡張）。

### 3.2 エクスポート操作の単位

- **個別エクスポート**: 1つの `DifyContentItem` → 1つのPDF（表紙＋その1本の内容のみ）。
- **まとめてエクスポート**: ユーザーが選んだ複数の `DifyContentItem` → 1つのPDF（表紙＋目次＋各アイテムをセクションとして連ねる）。

---

## 4. UIイメージ

### 4.1 「レポートをエクスポート」を開いたとき

- **現状**: 「会話全体」「SWOT分析」「業界動向」などのセクション選択。
- **変更後**: 「Difyが提示した内容」の一覧を表示。
  - 各項目: タイトル（または先頭数十文字）、種類（分析/提言/サマリー等）、日時。
  - チェックボックスで「この内容をPDFに含める」を選択。
  - 「1件だけ選択 → その1本をレポートPDFに」「複数選択 → 1つのPDFにまとめる」の両方に対応。

### 4.2 プレビュー・ダウンロード

- プレビューは「レポート形式に成型した結果」を表示（会話ログではなく、見出し・段落が整ったレポート風）。
- ダウンロードは、選択した「個別の内容」だけをレポートPDFに成型して出力。

---

## 5. レポート形式の成型（モディファイ）

- **入力**: Difyのテキスト（Markdown的な改行・見出し・リストを想定）。
- **処理**:
  - 見出し（# ## ###）→ レポートの見出しスタイル
  - 箇条書き・番号リスト → レポートのリストスタイル
  - 段落・改行 → 適切な余白・フォント
- **出力**: HTML（既存のPuppeteer PDF生成の入力）としてレポート用レイアウトを適用。
- 表紙・ヘッダー・フッター・ページ番号などは既存の「カッコ良いフォーマット」の要件に合わせてデザイン。

---

## 6. 実装の段階案

| 段階 | 内容 |
|------|------|
| Phase 1 | 型・データ: `DifyContentItem` を定義し、`messages` から「Dify提示コンテンツ」一覧を生成する関数を追加 |
| Phase 2 | エクスポートUI: 会話セクションの代わりに「Dify提示コンテンツ」一覧を表示し、個別選択でPDFに含める |
| Phase 3 | レポート成型: Difyの本文をMarkdown的にパースし、レポート用HTMLテンプレートで整形してからPDF生成 |
| Phase 4 | 1件だけ選択時は「その1本だけのレポート」、複数選択時は「表紙＋目次＋複数セクション」の1本のPDF |

---

## 7. 現行実装との関係

- **会話全体をそのまま出す**現在の「会話履歴」エクスポートは、要件として不要（または「レポート」とは別のオプションとして残すかは要確認）。
- **キーワードで抽出したSWOT/業界動向など**は、「Difyが提示した内容」のうち、種類（type）やタイトルで「SWOT分析」「業界動向」と判別できるようにし、同じ「個別の内容」リストに載せる形に寄せるのが自然。

---

## 8. まとめ

- **PDFにしたいもの**: 画面の会話ではなく、**Difyが提示してきた内容**。
- **形**: レポートらしく整え、**きれいなフォーマット**で成型したもの。
- **エクスポート**: **個別の内容**単位（1本＝1レポート、または複数本を1つのPDFにまとめる）。

この設計に沿って、Phase 1 から順に実装していく形を推奨する。
