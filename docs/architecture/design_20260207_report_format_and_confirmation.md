# 設計: レポート確認フロー・フォーマット・美しいレイアウト

> 要件: (1) A4横で成型を正しく表示 (2) 「Dify提示」ではなくAIとして表示 (3) ユーザーがレポートを求める場合に「このようなレポートでよろしいですか？」と確認してから作成 (4) レポートフォーマットに沿ってDifyの回答を埋め込む (5) 美しいレポートレイアウトの採用

---

## 1. 要件サマリー

### 1.1 今回対応した点（実装済み・本設計の前提）

- **A4横**: プレビュー・PDFともに `A4 landscape` に統一（縦表示だった問題を解消）
- **表記**: UI・レポート内とも「Dify提示」ではなく「AIの回答」「AI」として表示

### 1.2 これから実装する流れ

1. **レポート依頼の検知**
   - ユーザーが「レポートを作って」「この内容でレポートを」等と発言した場合、または Dify の回答に「レポートとしてまとめます」等が含まれる場合に「レポート作成モード」とみなす。

2. **確認フロー**
   - 「このようなレポートでよろしいですか？」と依頼内容を復唱し、ユーザーが OK したらレポートを作成する。
   - OK でない場合は修正依頼を受け、再度確認する。

3. **レポートフォーマット（テンプレート）**
   - 固定の「レポートの型」を定義する（例: 表紙 → エグゼクティブサマリー → 分析 → 提言 → まとめ）。
   - Dify の回答をそのフォーマットの各セクションに**割り当て・要約して埋め込む**（PPTのスライド構成に近い）。

4. **美しいレイアウト**
   - 表紙・セクション見出し・余白・フォント・フッター（ページ番号・ロゴ）を整えた「コンサル風」レポートレイアウトを採用する。

---

## 2. レポート確認フロー（案）

### 2.1 トリガー

- **パターンA**: ユーザーが「レポートを作成して」「この内容でレポートを出して」「まとめてレポートにして」等と明示的に依頼。
- **パターンB**: Dify が「レポートとしてまとめます」「以下の形式でご報告します」等と返答し、その直後のユーザー発言が肯定（「お願い」「OK」等）または無言で送信。

### 2.2 フロー

```
[ユーザー or Dify がレポート依頼]
    ↓
[システムが「レポートフォーマット」のプレビューを提示]
  - 例: 「表紙 / エグゼクティブサマリー / 分析 / 提言 / まとめ」の見出しのみ、または簡易プレビュー
    ↓
[「このようなレポートでよろしいですか？」＋ 修正希望の有無を聞く]
    ↓
[ユーザーが OK] → レポート生成（フォーマットにDify回答を埋め込み）→ PDF/PPT 出力
[ユーザーが修正希望] → 希望を聞き、Dify に再生成 or 手動でセクション選択に誘導
```

### 2.3 UIの置き場所（案）

- **案1**: 相談チャット内で、レポート依頼検知時に「レポートプレビュー（フォーマット）」をメッセージとして表示し、その下に「この内容でレポートを作成する」「修正したい」ボタンを出す。
- **案2**: 既存の「レポートをエクスポート」ダイアログを開いたとき、最初のステップとして「レポートの構成（フォーマット）」を表示し、「この構成でOK」なら次にセクション・AI回答の選択へ進む。

どちらも「依頼の復唱＋フォーマット提示→OK→作成」を満たせる。

---

## 3. レポートフォーマット（テンプレート）

### 3.1 フォーマットの定義

レポートは**固定のセクション構成**を持ち、Dify の回答をそのセクションにマッピングする。

**推奨セクション（コンサルレポート風）**

| 順序 | セクションID | 表示名 | 内容の埋め込み元（Dify回答との対応） |
|------|----------------|--------|----------------------------------------|
| 0 | cover | 表紙 | セッション名・会社名・作成日（メタデータ） |
| 1 | executive_summary | エグゼクティブサマリー | 要約・結論系のAI回答、または最初のAI回答の要約 |
| 2 | analysis | 分析 | SWOT・業界動向・市場データ等の分析系 |
| 3 | recommendation | 提言・推奨 | 施策・アドバイス・提言系 |
| 4 | summary | まとめ・結論 | まとめ・サマリー系、または最後のAI回答 |

- Dify の各メッセージは `getDifyContentItems` で取得し、`type`（analysis / recommendation / summary / other）に応じて上記セクションに**割り当て**する。
- 複数ある場合は同じセクション内で順に並べる（例: 分析が2件あれば「分析」セクションに2ブロック）。

### 3.2 フォーマットと既存データの対応

- 既存: `ReportSection[]`（会話・SWOT・業界動向・市場・提言・**html**）。
- 新: **レポートフォーマット** = 上記5セクション（表紙＋4）の順序とラベルを定義し、`buildReportSectionsFromFormat(messages, format)` のような関数で、Dify の内容をフォーマットに沿って `ReportSection[]` を生成する。
- エクスポートダイアログでは「フォーマットに沿って自動で埋める」オプションと、「手動でセクション・AI回答を選ぶ」オプションの両方を持てる（まずは手動のみでも可）。

---

## 4. 美しいレポートレイアウト

### 4.1 方針

- **用紙**: A4 横（landscape）で統一（済）。
- **体裁**: コンサル・ビジネスレポートでよく使われる「表紙＋目次＋セクション＋フッター」を採用。

### 4.2 レイアウト要素（推奨）

| 要素 | 内容 |
|------|------|
| 表紙 | タイトル（例: AI経営コンサルティングレポート）、サブタイトル（セッション名）、会社名・担当・作成日。余白を大きめに、中央または左寄せ。 |
| フォント | 見出し: ゴシック系・太字・インディゴ系色。本文: 可読性の高いゴシック、10–11pt。 |
| セクション | 各セクションに明確な見出し（下線または左ボーダー）、余白 20–40px。 |
| ページ番号 | フッター中央または右下に「- 2 -」形式。表紙は番号なし or 表紙を1として2から。 |
| ロゴ・ブランド | フッターに小さく「AI経営コンサルティング」等のテキストまたはロゴ（任意）。 |

### 4.3 実装の置き場所

- **PDF**: `lib/report/pdf-generator.ts` の `generateReportHTML` 内の CSS と HTML 構造を、上記に合わせて調整する。
- **プレビュー**: `components/consulting/ReportPreview.tsx` の表紙・セクションのスタイルを、PDF とできるだけ同一になるよう揃える（同じ class 名・レイアウト）。

### 4.4 参考にしやすいパターン

-  McKinsey / BCG 風: 表紙がシンプル、中身は見出し・箇条書き・図表スペースが明確。
- 社内報告書風: 表紙＋目次＋各セクション＋フッター。A4横でスライドに近い構成。

「美しいレポートレイアウトを探して活用」については、OSS のテンプレートや CSS フレームワーク（例: Paged.js のサンプル、または一般的な HTML/CSS のレポートテンプレート）を参照し、プロジェクトの `pdf-generator` 用 HTML/CSS に取り込む形が現実的。必要に応じてデザインリソースを選定し、`docs/architecture/` に「採用レイアウトの参照元」を追記する。

---

## 5. 実装タスク分解（案）

| # | タスク | 成果物 | 依存 |
|---|--------|--------|------|
| 1 | A4横・表記修正 | プレビュー/PDFのlandscape、「AIの回答」表記 | 済 |
| 2 | レポートフォーマット定義 | セクションID・表示名の定数、型定義 | なし |
| 3 | フォーマットに沿ったセクション構築 | `buildReportSectionsFromFormat`（Dify内容をフォーマットにマッピング） | 2 |
| 4 | PDF/プレビューのレイアウト改善 | 表紙・見出し・フッター・ページ番号のCSS/HTML | なし |
| 5 | 確認フローUI | 「このようなレポートでよろしいですか？」＋ OK/修正 ボタン | 2, 3 |
| 6 | レポート依頼検知（オプション） | ユーザー/Dify発言から「レポート依頼」を検知するロジック | 5 |

まずは **2・3・4** でフォーマットとレイアウトを整え、その後に **5** で確認フローを追加する順序を推奨する。

---

## 6. スコープ外（現時点）

- 目次の自動生成（セクションが固定なら将来追加しやすい）
- 図表・画像のレポートへの埋め込み（将来拡張）
- 多言語対応

---

## 7. まとめ

- **表示**: A4横に統一し、「Dify提示」ではなく「AIの回答」として表示（対応済み）。
- **フロー**: レポート依頼時に「このようなレポートでよろしいですか？」と復唱し、OK でフォーマットに沿って作成する。
- **フォーマット**: 表紙・エグゼクティブサマリー・分析・提言・まとめの5部構成で、Dify の回答を type に応じて割り当てる。
- **レイアウト**: 表紙・見出し・余白・フッター・ページ番号を整えたコンサル風レポートにし、必要に応じて外部の美しいテンプレートを参照して CSS/HTML に取り込む。
