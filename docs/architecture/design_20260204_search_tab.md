# 🎨 Design: SearchTab本格実装（Web検索+AI要約）

**日付**: 2026-02-04  
**機能名**: Start画面右パネル「検索」タブの本格実装

---

## アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────┐
│                    SearchTab (Client)                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  1. ユーザー入力 (検索クエリ)                        │   │
│  └─────────────────┬───────────────────────────────────┘   │
│                    │                                         │
│                    ▼                                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  2. API呼び出し: /api/consulting/search             │   │
│  │     POST { query: "中小企業 売上向上" }             │   │
│  └─────────────────┬───────────────────────────────────┘   │
└────────────────────┼─────────────────────────────────────────┘
                     │
                     │ HTTP POST
                     │
┌────────────────────▼─────────────────────────────────────────┐
│            /api/consulting/search (Server)                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  3. Brave Search API呼び出し                        │   │
│  │     braveWebSearch(query, 3)                        │   │
│  └─────────────────┬───────────────────────────────────┘   │
│                    │                                         │
│                    ▼                                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  4. 検索結果を返却 (3件)                            │   │
│  │     [ { url, title, description }, ... ]            │   │
│  └─────────────────┬───────────────────────────────────┘   │
└────────────────────┼─────────────────────────────────────────┘
                     │
                     │ JSON Response
                     │
┌────────────────────▼─────────────────────────────────────────┐
│                    SearchTab (Client)                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  5. 検索結果を表示（折りたたみ可能）                 │   │
│  │     - タイトル + スニペット                          │   │
│  │     - 「別タブで開く」リンク                         │   │
│  └─────────────────┬───────────────────────────────────┘   │
│                    │                                         │
│                    ▼                                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  6. ユーザーが「要約を生成」ボタンをクリック         │   │
│  └─────────────────┬───────────────────────────────────┘   │
│                    │                                         │
│                    ▼                                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  7. API呼び出し: /api/consulting/search/summarize   │   │
│  │     POST { query, results }                         │   │
│  └─────────────────┬───────────────────────────────────┘   │
└────────────────────┼─────────────────────────────────────────┘
                     │
                     │ HTTP POST
                     │
┌────────────────────▼─────────────────────────────────────────┐
│        /api/consulting/search/summarize (Server)              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  8. Dify API呼び出し（検索要約ワークフロー）        │   │
│  │     - 入力: query + results[]                       │   │
│  │     - 出力: 箇条書き要約 + 参考URL                  │   │
│  └─────────────────┬───────────────────────────────────┘   │
│                    │                                         │
│                    ▼                                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  9. 要約結果を返却                                   │   │
│  │     { summary: "• ポイント1\n• ポイント2...",       │   │
│  │       sources: ["url1", "url2", "url3"] }           │   │
│  └─────────────────┬───────────────────────────────────┘   │
└────────────────────┼─────────────────────────────────────────┘
                     │
                     │ JSON Response
                     │
┌────────────────────▼─────────────────────────────────────────┐
│                    SearchTab (Client)                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  10. 要約を表示                                      │   │
│  │      「チャットに挿入」ボタン表示                    │   │
│  └─────────────────┬───────────────────────────────────┘   │
│                    │                                         │
│                    ▼                                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  11. ユーザーが「チャットに挿入」クリック           │   │
│  │      → onInsertToChat(summary + sources)             │   │
│  └─────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────┘
```

---

## モジュール構成

### 1. SearchTab.tsx (Client Component)
**責務**: UI表示、ユーザー操作、API呼び出し

**状態管理**:
```typescript
- query: string                    // 検索クエリ
- results: SearchResult[]          // 検索結果（生データ）
- summary: string | null           // AI要約結果
- isSearching: boolean             // 検索中フラグ
- isSummarizing: boolean           // 要約生成中フラグ
- searchHistory: string[]          // 検索履歴（localStorage）
- error: string | null             // エラーメッセージ
- retryCount: number               // リトライ回数
```

**主要メソッド**:
- `handleSearch()`: 検索実行（自動リトライ付き）
- `handleSummarize()`: 要約生成
- `handleInsertToChat()`: チャットに挿入
- `handleRetry()`: 手動リトライ

**依存**: なし（独立したコンポーネント）

**保護レベル**: レベル3（変更可能）

---

### 2. /api/consulting/search/route.ts (Server API)
**責務**: Web検索の実行

**入力**:
```typescript
POST /api/consulting/search
{
  query: string  // 検索クエリ
}
```

**処理**:
1. 入力検証（queryが空でないか、長さ制限）
2. Brave Search API呼び出し（3件取得）
3. 結果の整形

**出力**:
```typescript
{
  success: boolean
  results: Array<{
    url: string
    title: string
    description: string
  }>
  error?: string
}
```

**エラーハンドリング**:
- Brave API失敗 → 500エラー + リトライ可能フラグ
- 検索結果0件 → 200 + 空配列

**依存**: `lib/brave-search.ts`

**保護レベル**: レベル3（新規作成）

---

### 3. /api/consulting/search/summarize/route.ts (Server API)
**責務**: 検索結果のAI要約

**入力**:
```typescript
POST /api/consulting/search/summarize
{
  query: string
  results: Array<{
    url: string
    title: string
    description: string
  }>
}
```

**処理**:
1. 入力検証
2. Dify API呼び出し（検索要約ワークフロー）
3. 要約結果の整形（箇条書き形式）

**出力**:
```typescript
{
  success: boolean
  summary: string  // 箇条書き形式の要約
  sources: string[] // 参考URL
  error?: string
}
```

**エラーハンドリング**:
- Dify API失敗 → 500エラー + リトライ可能フラグ
- タイムアウト → 504エラー + 再試行メッセージ

**依存**: Dify API（新規ワークフロー作成必要）

**保護レベル**: レベル3（新規作成）

---

### 4. Dify検索要約ワークフロー (新規作成)
**責務**: 検索結果の要約生成

**入力変数**:
```
- query: string          // 検索クエリ
- result1_title: string
- result1_desc: string
- result1_url: string
- result2_title: string
- result2_desc: string
- result2_url: string
- result3_title: string
- result3_desc: string
- result3_url: string
```

**プロンプト**:
```
あなたは情報要約の専門家です。
以下の検索結果を、ビジネスコンサルティングの文脈で箇条書き形式で要約してください。

検索キーワード: {{query}}

検索結果1:
タイトル: {{result1_title}}
説明: {{result1_desc}}

検索結果2:
タイトル: {{result2_title}}
説明: {{result2_desc}}

検索結果3:
タイトル: {{result3_title}}
説明: {{result3_desc}}

要件:
- 箇条書き（3-5個のポイント）
- 各ポイントは簡潔に（30-50文字）
- 重要な数値やデータを含める
- ビジネス判断に役立つ情報を優先

出力形式:
• ポイント1
• ポイント2
• ポイント3

参考URL:
- {{result1_url}}
- {{result2_url}}
- {{result3_url}}
```

**出力変数**:
```
- summary: string  // 箇条書き要約
```

---

## データフロー

### シーケンス図

```
User          SearchTab        API: /search      Brave API      API: /summarize    Dify
 |                |                  |                |                |              |
 |--input query-->|                  |                |                |              |
 |                |---POST query---->|                |                |              |
 |                |                  |--search------->|                |              |
 |                |                  |<--results------|                |              |
 |                |<--results--------|                |                |              |
 |                |                  |                |                |              |
 |<-display-------|                  |                |                |              |
 |                |                  |                |                |              |
 |--click summarize->|               |                |                |              |
 |                |---POST query+results------------>|                |              |
 |                |                  |                |---workflow---->|              |
 |                |                  |                |<--summary------|              |
 |                |<--summary-------------------------|                |              |
 |                |                  |                |                |              |
 |<-display summary-|                |                |                |              |
 |                |                  |                |                |                |
 |--insert to chat->|                |                |                |              |
 |                |--onInsertToChat(summary)-->      |                |              |
 |                |                  |                |                |              |
```

---

## 技術選定（プロジェクト制約考慮）

| カテゴリ | 選定技術 | 理由 | 制約 |
|---------|---------|------|------|
| Web検索 | Brave Search API | 既存実装あり、高品質 | APIキー必要 |
| AI要約 | Dify API | 既存統合、カスタマイズ可 | ワークフロー作成必要 |
| 状態管理 | React useState | シンプル、コンポーネント内完結 | なし |
| 検索履歴 | localStorage | クライアント側で完結 | ブラウザ依存 |
| エラーハンドリング | 自動リトライ(2回) + 手動 | UX向上 | なし |
| UI表示 | アコーディオン | 折りたたみで省スペース | shadcn/ui使用 |

---

## セキュリティ考慮点

### 環境変数の扱い
- ✅ `BRAVE_SEARCH_API_KEY`: サーバー専用（.env.local）
- ✅ `DIFY_API_KEY`: サーバー専用（.env.local）
- ❌ クライアントには露出しない

### 入力検証
```typescript
// /api/consulting/search/route.ts
if (!query || typeof query !== 'string') {
  return NextResponse.json({ error: 'Invalid query' }, { status: 400 })
}
if (query.length > 500) {
  return NextResponse.json({ error: 'Query too long' }, { status: 400 })
}
```

### レート制限
```typescript
// 簡易的なレート制限（将来的に強化）
const MAX_REQUESTS_PER_MINUTE = 10
// Redis等で実装を検討
```

### XSS対策
- 検索結果のHTML表示時はエスケープ
- URLは`target="_blank" rel="noopener noreferrer"`で安全に開く

---

## UI/UX設計

### 検索前（初期状態）
```
┌──────────────────────────────────────┐
│ 検索                                 │
│ Web検索で情報を調べる                │
├──────────────────────────────────────┤
│ 🔍 [キーワードを入力...]  [検索]   │
├──────────────────────────────────────┤
│ 🕒 検索履歴                          │
│   ・中小企業 売上向上 施策          │
│   ・コスト削減 成功事例              │
│   ・業界平均 成長率 2026            │
└──────────────────────────────────────┘
```

---

### 検索中
```
┌──────────────────────────────────────┐
│ 検索中... ⏳                         │
│ [=============>            ] 60%    │
└──────────────────────────────────────┘
```

---

### 検索完了（要約前）
```
┌──────────────────────────────────────┐
│ 検索結果 (3件)                       │
├──────────────────────────────────────┤
│ 📄 中小企業の売上向上に効果的な5つ... │
│    中小企業が売上を伸ばすために...    │
│    🔗 別タブで開く                   │
├──────────────────────────────────────┤
│ 📄 2026年版 業界別成長率レポート      │
│    各業界の平均成長率と市場動向...    │
│    🔗 別タブで開く                   │
├──────────────────────────────────────┤
│ 📄 コスト削減の成功事例10選          │
│    実際の企業が実践したコスト削減...   │
│    🔗 別タブで開く                   │
├──────────────────────────────────────┤
│        [✨ 要約を生成]               │
└──────────────────────────────────────┘
```

---

### 要約生成中
```
┌──────────────────────────────────────┐
│ AI要約生成中... 🤖                   │
│ [================>        ] 75%     │
└──────────────────────────────────────┘
```

---

### 要約完了
```
┌──────────────────────────────────────┐
│ 📝 要約結果                          │
├──────────────────────────────────────┤
│ 検索キーワード「中小企業 売上向上」  │
│                                      │
│ • 新規顧客獲得が最も効果的（+15%）  │
│ • デジタルマーケティング活用で18%成長│
│ • 既存顧客の単価向上で安定増収      │
│ • 業界平均は12-15%の成長率          │
│ • コスト削減と併用で効果最大化      │
│                                      │
│ 参考URL:                             │
│ • https://example.com/sales1 🔗     │
│ • https://example.com/growth 🔗     │
│ • https://example.com/cases 🔗      │
├──────────────────────────────────────┤
│      [💬 チャットに挿入]             │
│      [🔄 要約を再生成]               │
└──────────────────────────────────────┘
```

---

### エラー時
```
┌──────────────────────────────────────┐
│ ❌ エラーが発生しました              │
│                                      │
│ 検索に失敗しました。                 │
│ 自動で2回試行しましたが成功しませんでした。│
│                                      │
│ ネットワーク接続を確認してから       │
│ もう一度お試しください。             │
│                                      │
│      [🔄 再試行]                     │
└──────────────────────────────────────┘
```

---

## エラーハンドリング設計

### エラー分類

| エラー種別 | HTTP Status | 対応 | UI表示 |
|-----------|-------------|------|--------|
| 入力不正 | 400 | バリデーションメッセージ | 赤テキスト |
| 検索失敗 | 500 | 自動リトライ(2回) | ローディング継続 |
| タイムアウト | 504 | 手動リトライ促す | エラーダイアログ |
| API制限 | 429 | 1分待機後リトライ | 「しばらくお待ちください」 |
| 要約失敗 | 500 | 手動リトライ促す | エラーダイアログ |
| ネットワーク | - | 手動リトライ促す | 「接続を確認してください」 |

---

### リトライロジック

```typescript
async function searchWithRetry(query: string, maxRetries = 2) {
  let lastError: Error | null = null
  
  for (let i = 0; i < maxRetries; i++) {
    try {
      const response = await fetch('/api/consulting/search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query })
      })
      
      if (response.ok) {
        return await response.json()
      }
      
      // 429の場合は待機
      if (response.status === 429) {
        await new Promise(resolve => setTimeout(resolve, 60000))
        continue
      }
      
      throw new Error(`HTTP ${response.status}`)
      
    } catch (error) {
      lastError = error as Error
      console.error(`Retry ${i + 1}/${maxRetries} failed:`, error)
      
      // 最後のリトライでなければ少し待つ
      if (i < maxRetries - 1) {
        await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)))
      }
    }
  }
  
  throw lastError
}
```

---

## パフォーマンス最適化

### 検索速度
- Brave Search: 平均1-2秒
- 要約生成: 平均3-5秒
- **合計**: 4-7秒

### キャッシュ戦略
- ❌ 今回は実装しない（将来的に検討）
- 理由: リアルタイム性を優先

### ローディング表示
- 検索中: プログレスバー（擬似的）
- 要約中: アニメーション付きローディング

---

## ファイル変更計画

### 新規作成
1. `app/api/consulting/search/route.ts`
   - Brave Search API呼び出し
   - 検索結果返却

2. `app/api/consulting/search/summarize/route.ts`
   - Dify API呼び出し
   - 要約結果返却

3. Difyワークフロー: `search-summarizer`
   - 検索結果要約専用

### 変更対象
1. `components/consulting/SearchTab.tsx` (保護レベル3)
   - ダミー実装削除
   - 実際のAPI呼び出し実装
   - 要約機能追加
   - エラーハンドリング強化

### 参照のみ
- `lib/brave-search.ts`
- `app/api/company-intel/route.ts`

---

## 次のステップ

### ✅ Phase 2完了
このDesignドキュメント作成完了

### 🔜 Phase 3: PLAN
- タスク分解
- 実装順序決定
- 見積もり

---

**Phase 3: PLANに進みます！**
