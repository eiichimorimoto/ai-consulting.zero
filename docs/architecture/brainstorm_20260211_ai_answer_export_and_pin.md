# 🧠 Brainstorm: AI回答のダウンロード・ピン留めとレポートは節目のみ

## プロジェクトコンテキスト
- **技術スタック**: Next.js 16 + TypeScript + Supabase
- **現状**: 「〇〇をレポートに」→ 復唱 → 「はい」→ Dify でレポート生成。トピックの遡及が難しく別内容のレポートになりがち。

---

## 要件サマリー

### ユーザー要望
1. **現行の「これをレポートに」仕様はやめる**（復唱→確認→レポート生成フローを廃止）
2. **AI回答に印刷マークを付ける** → その回答をリッチテキストまたはマークダウンでダウンロードできるようにする
3. **ピン留め**でメッセージを固定できるようにする
4. **レポートは節目でしか使わない**（STEP 完了時など、節目でのみレポートを発行する）

---

## 確定要件

| 項目 | 内容 |
|------|------|
| 廃止するもの | レポート依頼の復唱、確認後の Dify レポート生成、`pending_report_query`、「これをレポートに」フロー。議論まとめレポートも廃止し節目に一本化。**エクスポートダイアログでの「AI回答」選択も削除**する。 |
| AI回答の印刷・ダウンロード | 各 AI メッセージにダウンロード用アイコンを表示。クリックでそのメッセージを **マークダウン（.md）** 等でダウンロード。（実装計画では後続フェーズでも可） |
| ピン留め | **AI メッセージのみ**ピン留め可能。ピン留めしたメッセージは一覧の上部に固定表示。 |
| レポートは節目のみ | **全 STEP（1〜5）** で、そのステップを**終了の意思表示**をした時点でコンセンサス用レポートを作成。**各ステップは勝手に終了しない**。終了時に当該ステップの会話全てを整理・要約し、保存に耐える体裁で保存。左メニューでステップ毎にレポートを作成・表示する。 |

---

## スコープ外（今回のブレインストームでは扱わない）

- 既存エクスポートダイアログ（レポート一覧・PDF/PPT/MD 出力）の存続は設計で判断
- 節目レポートの具体的なトリガー（STEP 完了ボタン押下時のみか、自動か）は設計で決定

---

## ファイル影響範囲（想定）

| 種別 | ファイル |
|------|----------|
| 変更・削除 | `app/api/consulting/sessions/[id]/messages/route.ts`（レポート依頼・復唱・確認分岐の削除または無効化）、`lib/consulting/report-request.ts`（復唱・pending 関連の参照削減）、`components/consulting/ChatArea.tsx`（印刷マーク・ピン留め UI 追加） |
| 新規・拡張 | メッセージ用ピン留め（DB カラム or 別テーブル）、ダウンロード用 API またはクライアント側 Blob 生成、節目レポート用トリガー・UI |
| 参照のみ | `ConsultingProgressBar`（STEP と節目の対応）、`ExportDialog` |

---

## 合意済み（ユーザー回答）

1. **議論まとめ**: 廃止して節目に一本化。
2. **ピン留め**: AI メッセージのみ。
3. **節目**: 全 STEP（1〜5）で、終了の意思表示をした時点で当該ステップのコンセンサスレポートを作成。ステップは勝手に終了しない。

---

## 次のアクション

- **実装**: `docs/plans/implementation_plan_20260211_report_milestone_only.md` に従い、Phase 0（バックアップ・Git）から順にステップバイステップで実施。必ずファクトチェックを行ってから次に進む。
