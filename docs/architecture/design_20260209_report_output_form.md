# レポート出力フォーム設計

**日付**: 2026-02-09  
**目的**: レポートPDF/PPTの表題・作成日時・ページ番号・文責を明示した正式なレポート体裁と、縦/横の選択を設計する。  
**参照**: 添付サンプルPDF（縦向き。横でも可、選択できるとよい）。

---

## 1. 要件整理

| 項目 | 現状 | あるべき姿 |
|------|------|------------|
| 表題 | 会話の見出しをそのまま使用 | ユーザーが「レポートにして」と言った内容を吟味し、適切なタイトルを付与 |
| 作成日時 | 表紙に「作成日」のみ | 表紙および必要に応じて各ページに作成日時を明示 |
| ページ番号 | なし | 全ページにページ番号（例: 1/5, 2/5）を記載 |
| 文責 | なし | 表紙または最終ページに文責（作成元・AI参謀等）を記載 |
| 用紙向き | A4横固定 | 縦/横を選択可能にする（デフォルトは横のままでも可） |

---

## 2. レポート構成案（フォーム的イメージ）

```
┌─────────────────────────────────────────────────────────┐
│ 【表紙】                                                  │
│                                                          │
│            （表題：吟味したタイトル）                       │
│                                                          │
│            サブタイトル（セッション名など）                  │
│                                                          │
│            作成日時: YYYY年MM月DD日 HH:MM                   │
│            文責: AI参謀 - AI経営コンサルティング            │
│            会社名・担当者（任意）                          │
│                                                          │
└─────────────────────────────────────────────────────────┘
                         （ページ番号: 1 / N）

┌─────────────────────────────────────────────────────────┐
│ 【本文 1 ページ目】                                        │
│                                                          │
│  （セクションタイトル）                                    │
│  作成日時: YYYY/MM/DD HH:MM（当該セクションの回答日時）     │
│                                                          │
│  （レポート本文）                                          │
│                                                          │
└─────────────────────────────────────────────────────────┘
                         （ページ番号: 2 / N）

... 以降、セクションごとにページを継ぎ ...

┌─────────────────────────────────────────────────────────┐
│ 【フッター（全ページ共通）】                                │
│  中央または右下: ページ番号（例: 2 / 5）                    │
│  文責を毎ページ入れる場合はフッターに短く記載               │
└─────────────────────────────────────────────────────────┘
```

- **表紙**: 表題（吟味したタイトル）、サブタイトル、作成日時、文責、任意で会社名・担当者。
- **本文**: 各セクションにセクションタイトル・当該部分の作成日時・本文。ページ番号は全ページに表示。
- **用紙**: 縦（portrait）／横（landscape）をエクスポート時に選択可能にする。

---

## 3. 表題の決め方

- **入力**: ユーザーが「レポートにして」と言った元メッセージ（例: 「この提案をレポートにして下さい」）。
- **方針**:
  - **案A**: 元メッセージを短くしたものを表題に（例: 「この提案をレポートに」→ 表題「提案レポート」）。
  - **案B**: Difyが生成したレポートの先頭見出し（# で始まる行）を表題に使う。
  - **案C**: 固定文言 + 作成日時（例: 「AI経営コンサルティングレポート（YYYY/MM/DD）」）。
- **推奨**: まずは **案B + フォールバックで案C**。Difyの回答に # 見出しがあればそれを表題に、なければセッション名＋作成日時を表題にする。

---

## 4. 文責の表記

- **文責**: 「AI参謀」「SolveWise AI経営コンサルティング」など、作成元を明示する短い文言。
- **配置**: 表紙の下部、および必要に応じて各ページのフッターに短く記載。

---

## 5. ページ番号

- **形式**: `現在ページ / 総ページ数`（例: 2 / 5）。
- **配置**: 各ページのフッター中央または右下。`@page` と CSS の `counter(page)` / `counter(pages)` または Puppeteer の footer テンプレートで実装。

---

## 6. 縦/横の選択

- **UI**: エクスポートダイアログの「エクスポート形式」近くに「用紙の向き: 横 / 縦」のラジオまたはドロップダウンを追加。
- **PDF**: `@page { size: A4 landscape; }` または `size: A4 portrait;` を選択に応じて切り替え。
- **PPT**: スライドの向きを横/縦で切り替え可能にする（実装方針は別途）。

---

## 7. ヘッダー・フッター・ブランディング

- **ヘッダー（全本文ページ）**
  - 色付きバー（ブランドカラー: インディゴ系グラデーション）。
  - 片隅に **SOLVE WISE** テキスト + **ロゴ**（`/logo.png`）を配置。右端推奨。
- **フッター（全ページ）**
  - 同系色のバーでページ番号（中央）と文責（右または中央）を表示。
- **表紙**
  - 表紙のみロゴ＋SOLVE WISE を右上など片隅に表示（任意）。
- **本番PDF**: ヘッダー・フッターは Puppeteer の `displayHeaderFooter` と `headerTemplate` / `footerTemplate` で出力し、`print-color-adjust: exact` で色を維持する。

---

## 8. 内容に応じた表現の自動選択（表・プロセス図・本文）

ユーザーが「表で」「図で」等の指示を**していない場合**は、内容に応じて自動で以下を使い分ける。

| 内容の種類 | 表現 | 判定の目安 |
|------------|------|------------|
| 比較・一覧・数値・複数項目の対比 | **表形式** | 見出し＋行/列の構造、SWOT・施策比較・指標一覧など |
| 手順・フロー・ステップ・プロセス | **プロセス図** | 順序のあるステップ、前後関係が重要な説明 |
| 上記以外（説明・考察・単一トピック） | **本文（段落・箇条書き）** | そのまま段落またはリストで表現 |

- **表形式**: レポート用のスタイル付きテーブル（ヘッダー色・偶数行ストライプ・角丸）で出力。
- **プロセス図**: 横並びのボックス＋矢印（例: 現状分析 → 課題整理 → 施策検討 → 実行計画 → PDCA）。必要に応じて縦積みや簡易図形（Mermaid 等）の検討も可。
- **実装方針**: Dify の出力をパースし、見出しとリストの構造から「表向き」「フロー向き」を判定するロジックをサーバー側（または Dify の出力フォーマット指示）で持つ。ユーザーが「表にまとめて」「フロー図で」等と指定した場合はその指示を優先する。

---

## 9. サンプルファイル

- **場所**: `public/report-form-sample.html`
- **内容**: 表紙（表題・作成日時・文責・ロゴ）、**ヘッダー（SOLVE WISE＋ロゴ・色付き）**、**フッター（ページ番号・文責・色付き）**、本文のほか**表形式**・**プロセス図**のサンプルセクションを含む。用紙の向きは画面上で切り替え可能。
- **本番PDF**: Puppeteer の `displayHeaderFooter` と `footerTemplate` で `pageNumber` / `totalPages` を渡し、全ページに同じヘッダー・フッターを出力する。

## 10. 実装の優先順位

1. **ヘッダー・フッター・表/プロセス図の本番実装**: サンプルに合わせて PDF 生成でヘッダー・フッター（SOLVE WISE＋ロゴ・色付き）および内容に応じた表・プロセス図の出力を行う。
2. **PDF生成の拡張**: `PDFGenerateOptions` に `orientation: 'portrait' | 'landscape'`、`reportTitle?: string`、`authorLabel?: string`（文責）を追加し、表紙・フッターを上記フォームに合わせて変更。
3. **表題の決定ロジック**: Dify回答の先頭見出し or 固定表題を `metadata.title` に渡す。
4. **エクスポートUI**: 用紙の向き選択を追加。レポート対象を「依頼された1件」に限定する表示・デフォルト選択は別設計（confirm_then_dify_and_report_flag / discussion_summary の「レポート用1件」と連携）。

---

## 11. 関連する他の要件（メモ）

- **レポート対象を「依頼された1件」だけにする**: 会話中の全AI回答ではなく、ユーザーが「レポートにして」と依頼し確認した結果の 1 件をレポート対象とする。エクスポート一覧のデフォルトや表示件数はこの方針に合わせて変更する。
- **「はい」への返答**: 「〇〇のレポートを作成しました。」とチャットに表示し、作成した旨を明示する。
- **チャットでの作成旨表示**: レポートをエクスポートボタンだけでなく、チャット内でも「レポートを作成しました」と分かるようにする。
