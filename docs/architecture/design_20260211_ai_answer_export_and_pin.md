# 🎨 Design: AI回答のダウンロード・ピン留めとレポートは節目のみ

## プロジェクトコンテキスト
- Next.js 16 + TypeScript + Supabase
- 現行の「これをレポートに」→ 復唱 → 確認 → Dify レポート生成を廃止し、代わりに「AI回答の印刷/ダウンロード」「ピン留め」「節目でのみレポート」に寄せる。

---

## 1. 方針サマリー

| 項目 | 方針 |
|------|------|
| 廃止 | レポート依頼判定・復唱・確認後の Dify レポート生成（`isReportRequest` → 復唱 → `pending_report_query` → 「はい」→ レポート作成）。議論まとめレポートも今回のスコープでは廃止し、節目レポートに一本化する。 |
| 追加 | (1) 各 AI メッセージに「ダウンロード」アイコンを付け、クリックで .md / .html でダウンロード。(2) AI メッセージをピン留め可能にし、一覧上部または専用エリアに固定表示。(3) 節目（STEP 完了、とくに STEP 5）でのみレポートを生成・出力する。 |

---

## 2. アーキテクチャ概要

```
┌─────────────────────────────────────────────────────────────────┐
│  ChatArea（チャット画面）                                         │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ [ピン留めメッセージ一覧]（あれば上部に固定表示）             │  │
│  └───────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ AI: 〇〇です。                    [🔊] [📥 DL] [📌 ピン]   │  │
│  │ ユーザー: 〇〇                                            │  │
│  │ AI: …                                    [🔊] [📥 DL] [📌] │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
         │                                    │
         │ ダウンロード                        │ ピン留め
         ▼                                    ▼
   Blob → .md / .html                    consulting_messages.is_pinned
   (クライアントで生成)                   または pinned_message_ids (session)
┌─────────────────────────────────────────────────────────────────┐
│  節目（STEP 5 など）                                              │
│  「レポートを作成」ボタン or STEP 完了時 → レポート生成・エクスポート │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 廃止する処理（実装タスクとしての削除・無効化）

- **API** `app/api/consulting/sessions/[id]/messages/route.ts`
  - `isReportRequest` / `isConfirmation` に基づく復唱分岐（`useReportEcho`）の削除またはスキップ
  - `pending_report_query` の保存・参照・`treatAsReportConfirm` によるレポート生成分岐の削除
  - 議論まとめ（`isDiscussionSummaryReportRequest`、`PENDING_DISCUSSION_SUMMARY_PREFIX`）の削除
- **lib** `lib/consulting/report-request.ts`
  - レポート依頼・復唱・議論まとめ・USER_TOPIC 関連の export は残してもよいが、API からは呼ばない（またはモジュールごと参照削除）
- **UI**
  - 「〇〇のレポートを作成しました。」の特別表示は、節目レポート用の表示に置き換えるか削除

---

## 4. AI 回答のダウンロード（印刷マーク）

### 4.1 仕様
- 各 **assistant** メッセージのヘッダー付近に **ダウンロード** アイコン（例: `Download` / `FileDown`）を配置
- クリックで **そのメッセージの content** をファイルでダウンロード
- 形式: **マークダウン（.md）** をデフォルトとし、オプションで **HTML（.html）** またはテキスト（.txt）を選べるようにする（初期は .md のみでも可）

### 4.2 実装方針
- **クライアント側で完結**: `content` は既にフロントに渡っているため、Blob を作成して `URL.createObjectURL` + `<a download>` でダウンロード
- ファイル名: `ai-answer-{messageId.slice(0,8)}.md` または `ai-answer-{日時}.md`
- HTML にする場合は、`formatAIMessage` 相当のマークダウン→HTML 変換結果を `text/html` で Blob 化

### 4.3 配置
- `ChatArea.tsx` 内の AI メッセージブロックで、既存の音声ボタン（🔊）の横に「ダウンロード」ボタンを追加

---

## 5. ピン留め

### 5.1 仕様
- **対象**: AI メッセージのみ（ユーザー発言はピン留め対象外でよい）
- 各 AI メッセージに **ピン** アイコンを表示。クリックでそのメッセージをピン留め / 解除
- ピン留めしたメッセージは、チャット一覧の **上部** にブロックで固定表示（「ピン留め」セクション）。同じセッション内で複数ピン可能

### 5.2 データ設計
- **案A**: `consulting_messages` に `is_pinned BOOLEAN DEFAULT false` を追加。セッション単位でメッセージをピン留め
- **案B**: `consulting_sessions` に `pinned_message_ids UUID[]` を追加。順序を配列で保持できる
- **推奨**: 案A（シンプルでクエリが容易）。表示順は `message_order` の昇順でピン留めのみフィルタすればよい

### 5.3 UI
- チャット上部に「ピン留め（N件）」のような見出しと、ピン留めしたメッセージのプレビュー（短いテキスト + 解除ボタン）
- メインのタイムラインでは、ピン留めしたメッセージにピンアイコンを「塗りつぶし」で表示し、クリックで解除

### 5.4 API
- `PATCH /api/consulting/sessions/[id]/messages/[messageId]` で `is_pinned: true/false` を更新（または既存メッセージ更新用エンドポイントを追加）
- GET でメッセージ一覧取得時に `is_pinned` を含める

---

## 6. レポートは節目のみ（全STEP・終了意思表示）

### 6.1 定義（ユーザー合意済み）
- **節目**: 各ステップでユーザーが**終了の意思表示**をしたタイミング。ステップは**勝手に終了しない**。
- **レポート生成**: **全 STEP（1〜5）** で、そのステップを終了した時点で**コンセンサス用レポート**を作成する。当該ステップの会話**全て**を使って整理・要約し、**保存に耐える綺麗なレイアウト**で保存する。

### 6.2 振る舞い
- 会話中の「これをレポートに」「〇〇についてレポートに」等の依頼は **廃止**（復唱も出さない）
- **各ステップは終了の意思表示がない限り続く**。ユーザーが「このステップを終了」等を押したときだけ次のステップに進み、**終了したステップのレポートを 1 件作成**する
- **エクスポート**: 「AI回答」を選択してエクスポートする機能は**削除**する。代わりに**左メニューでステップごとに作成したレポート**のみを一覧表示し、PDF/PPT/MD でエクスポートする

### 6.3 実装
- 詳細は **`docs/plans/implementation_plan_20260211_report_milestone_only.md`** に従い、Phase 0（バックアップ・Git）から順にステップバイステップで実施する。一気に実装せず、必ずファクトチェックを行ってから次に進む。

---

## 7. ファイル変更一覧

| ファイル | 変更内容 |
|----------|----------|
| `app/api/consulting/sessions/[id]/messages/route.ts` | レポート依頼・復唱・確認・議論まとめ・USER_TOPIC 分岐を削除。POST は通常メッセージ保存＋Dify 呼び出しのみに簡略化。 |
| `lib/consulting/report-request.ts` | 参照する側を減らしたうえで、必要なら残す（エクスポート時の「レポート作成しました」判定など）。または未使用 export を削除。 |
| `components/consulting/ChatArea.tsx` | AI メッセージにダウンロードボタン・ピン留めボタン追加。ピン留めセクションを上部に追加。 |
| DB | `consulting_messages` に `is_pinned` 追加（migration）。型定義更新。 |
| `app/api/consulting/sessions/[id]/messages/route.ts` (GET) または メッセージ取得 | `is_pinned` を返す。 |
| 新規 API | `PATCH .../messages/[messageId]` で `is_pinned` 更新（または既存 route に統合）。 |

---

## 8. 実装順序（推奨）

1. **DB**: `consulting_messages.is_pinned` カラム追加 + 型定義
2. **API**: メッセージ取得に `is_pinned` を含める。PATCH でピン留め更新を実装
3. **ChatArea**: AI メッセージにダウンロード（.md）ボタン追加 → クライアントで Blob ダウンロード
4. **ChatArea**: ピン留めボタン追加＋ピン留めメッセージを上部に表示
5. **API**: レポート依頼・復唱・確認・議論まとめ・USER_TOPIC の削除
6. （別タスク）節目（STEP 5）でのレポート生成・エクスポート UI と連携

---

## 9. 変更履歴

- 2026-02-11: 初版（レポート廃止・AI 回答 DL・ピン留め・節目レポート方針）
- 2026-02-11: 全STEPでレポート・終了意思表示のみ進行・エクスポートからAI回答削除を反映。実装計画は `implementation_plan_20260211_report_milestone_only.md` に集約。
