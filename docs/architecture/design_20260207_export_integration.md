# 🎨 Design: エクスポート統合機能（Phase A）

## プロジェクトコンテキスト
- **技術スタック**: Next.js 16 + TypeScript + Supabase
- **前提**: Phase C（プロトタイプ）完了
- **目的**: 既存の「レポートをエクスポート」ボタンと統合し、複数レポートのプレビュー＆ダウンロード機能を実装

---

## 要件サマリー

### Phase Cからの進化
- **Phase C**: 固定テンプレートでPPT生成（テストボタン）
- **Phase A**: 実際の会話データからレポート生成（既存ボタン統合）

### ユーザーストーリー
```
As a ユーザー
I want to AI相談の結果を選択してエクスポートしたい
So that 必要な情報だけをレポート化できる
```

### 機能要件

**1. エクスポート選択**
- ☑ 会話全体（テキスト）
- ☑ SWOT分析（該当セッションで実施した場合）
- ☑ 業界動向（該当セッションで実施した場合）
- ☑ 市場データ（該当セッションで実施した場合）
- ☑ 経営提言（該当セッションで実施した場合）

**2. 形式選択**
- PDF（優先）
- PPT（将来対応）

**3. プレビュー**
- HTML形式でプレビュー表示
- ページネーション
- 印刷スタイル適用

**4. ダウンロード**
- 選択されたセクションのみ生成
- Base64エンコード → ダウンロード

---

## スコープ外（Phase A）

- ❌ Excel/Word生成
- ❌ Supabase Storage保存
- ❌ 履歴管理
- ❌ テンプレートカスタマイズ
- ❌ Dify統合

---

## アーキテクチャ図

```
┌─────────────────────────────────────────┐
│  AI相談画面（左パネル）                  │
│  ┌─────────────────────────────────┐   │
│  │ [📄 レポートをエクスポート]      │   │ ← クリック
│  └─────────────────────────────────┘   │
└──────────────┬──────────────────────────┘
               ↓
┌─────────────────────────────────────────┐
│  ExportReportDialog（モーダル）          │
│  ┌─────────────────────────────────┐   │
│  │ エクスポート内容を選択           │   │
│  │ ☑ 会話全体                      │   │
│  │ ☑ SWOT分析                      │   │
│  │ □ 業界動向（未実施）            │   │
│  │                                 │   │
│  │ 形式: [PDF ▼]                   │   │
│  │                                 │   │
│  │ [プレビュー] [ダウンロード]     │   │
│  └─────────────────────────────────┘   │
└──────────────┬──────────────────────────┘
               ↓ プレビュー
┌─────────────────────────────────────────┐
│  ReportPreview（プレビュー表示）         │
│  ┌─────────────────────────────────┐   │
│  │ [1/3] 会話全体                  │   │
│  │ ユーザー: 〇〇について教えて     │   │
│  │ AI: 〇〇は...                    │   │
│  │                                 │   │
│  │ [← 前へ] [次へ →]               │   │
│  └─────────────────────────────────┘   │
│  [ダウンロード] [閉じる]                │
└──────────────┬──────────────────────────┘
               ↓ ダウンロード
┌─────────────────────────────────────────┐
│  API Route                               │
│  /api/tools/generate-report              │
│  ┌─────────────────────────────────┐   │
│  │ 1. セクションデータ受信         │   │
│  │ 2. レポートビルダー実行         │   │
│  │ 3. PDF生成（jsPDF）             │   │
│  │ 4. Base64エンコード             │   │
│  │ 5. JSON返却                     │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

---

## モジュール設計

### 1. **ExportReportDialog.tsx**
**責務**: エクスポート設定UI

**Props**:
```typescript
{
  isOpen: boolean;
  onClose: () => void;
  availableSections: ReportSection[];
  onExport: (config: ExportConfig) => Promise<void>;
}
```

**State**:
```typescript
{
  selectedSections: string[];   // ['chat', 'swot']
  format: 'pdf' | 'ppt';
  showPreview: boolean;
}
```

**UI要素**:
- チェックボックスリスト（セクション選択）
- ドロップダウン（形式選択）
- プレビューボタン
- ダウンロードボタン

---

### 2. **ReportPreview.tsx**
**責務**: プレビュー表示

**Props**:
```typescript
{
  sections: ReportSection[];
  format: 'pdf' | 'ppt';
  onClose: () => void;
  onDownload: () => void;
}
```

**機能**:
- ページネーション（各セクション1ページ）
- 印刷スタイル適用
- ダウンロードボタン

---

### 3. **lib/report/builder.ts**
**責務**: レポート構築ロジック

**関数**:
```typescript
// 会話データからレポートセクションを構築
function buildReportSections(
  messages: Message[],
  selectedSectionIds: string[]
): ReportSection[]

// SWOT分析をレポートセクションに変換
function buildSwotSection(messages: Message[]): ReportSection | null

// 業界動向をレポートセクションに変換
function buildTrendsSection(messages: Message[]): ReportSection | null
```

---

### 4. **lib/report/pdf-generator.ts**
**責務**: PDF生成（jsPDF使用）

**関数**:
```typescript
function generatePDFReport(sections: ReportSection[]): Promise<{
  base64: string;
  fileName: string;
  mimeType: string;
}>
```

**依存ライブラリ**:
- `jspdf` - PDF生成
- `jspdf-autotable` - テーブル生成（SWOT分析用）

---

### 5. **API Route: `/api/tools/generate-report/route.ts`**
**責務**: レポート生成API

**入力**:
```typescript
{
  sections: ReportSection[];
  format: 'pdf' | 'ppt';
  metadata: {
    sessionName: string;
    userName?: string;
    companyName?: string;
  }
}
```

**出力**:
```typescript
{
  success: boolean;
  data?: {
    fileName: string;
    base64: string;
    mimeType: string;
  };
  error?: string;
}
```

---

### 6. **既存ファイル修正: `app/consulting/start/page.tsx`**
**変更内容**:
- 「レポートをエクスポート」ボタンのonClickを更新
- ExportReportDialogを開く処理に変更
- 現在のセッションデータを渡す

**保護レベル**: レベル3

---

## データモデル

### ReportSection
```typescript
interface ReportSection {
  id: string;                    // 'chat' | 'swot' | 'trends' | 'market' | 'recommendation'
  type: 'text' | 'table' | 'list';
  title: string;                 // セクションタイトル
  content: string | TableData | ListData;
  metadata?: {
    createdAt?: string;
    source?: string;
  };
}
```

### ExportConfig
```typescript
interface ExportConfig {
  sectionIds: string[];          // 選択されたセクションID
  format: 'pdf' | 'ppt';
  metadata: {
    sessionName: string;
    userName?: string;
    companyName?: string;
  };
}
```

---

## データフロー

### シーケンス図

```
User          ConsultingPage    Dialog           Builder          API             jsPDF
 |                 |              |                |                |                |
 |-- クリック ----->|              |                |                |                |
 |                 |-- open ----->|                |                |                |
 |                 |              |-- セクション -->|                |                |
 |                 |              |    選択         |                |                |
 |<-- チェックボックス表示 -------|                |                |                |
 |                 |              |                |                |                |
 |-- プレビュー --->|              |                |                |                |
 |                 |              |-- build ------>|                |                |
 |                 |              |                |-- 会話解析 --->|                |
 |                 |              |                |<-- sections ---|                |
 |                 |              |<-- sections ---|                |                |
 |<-- プレビュー表示 -------------|                |                |                |
 |                 |              |                |                |                |
 |-- ダウンロード -->|              |                |                |                |
 |                 |              |-- generate --->|                |                |
 |                 |              |                |-- POST ------->|                |
 |                 |              |                |                |-- create ----->|
 |                 |              |                |                |                |-- PDF生成
 |                 |              |                |                |<-- buffer -----|
 |                 |              |                |<-- base64 -----|                |
 |                 |              |<-- result -----|                |                |
 |<-- ダウンロード開始 ------------|                |                |                |
 |                 |              |                |                |                |
```

---

## UIデザイン

### ExportReportDialog

```
┌────────────────────────────────────────────┐
│  📊 レポートをエクスポート          [×]    │
├────────────────────────────────────────────┤
│                                            │
│  エクスポートする内容を選択してください     │
│                                            │
│  ┌──────────────────────────────────────┐ │
│  │ ☑ 会話全体 (25メッセージ)           │ │
│  │   AIとの会話履歴をすべて含めます     │ │
│  │                                      │ │
│  │ ☑ SWOT分析                           │ │
│  │   強み・弱み・機会・脅威の分析結果   │ │
│  │                                      │ │
│  │ □ 業界動向 (未実施)                 │ │
│  │   このセッションでは実施されていません│ │
│  │                                      │ │
│  │ □ 市場データ (未実施)               │ │
│  │   このセッションでは実施されていません│ │
│  └──────────────────────────────────────┘ │
│                                            │
│  形式:                                     │
│  ┌──────────────────────────────────────┐ │
│  │ PDF (推奨)                      [▼]  │ │
│  └──────────────────────────────────────┘ │
│                                            │
│  ┌────────────────────────────────────┐   │
│  │ 📄 プレビューを表示します          │   │
│  │ 選択: 2セクション                  │   │
│  │ 推定サイズ: 約500KB                │   │
│  └────────────────────────────────────┘   │
│                                            │
│  [キャンセル]  [プレビュー]  [ダウンロード]│
└────────────────────────────────────────────┘
```

### ReportPreview

```
┌────────────────────────────────────────────┐
│  📄 レポートプレビュー              [×]    │
├────────────────────────────────────────────┤
│  [← 前へ]    [1 / 2]    [次へ →]          │
├────────────────────────────────────────────┤
│                                            │
│  ┌──────────────────────────────────────┐ │
│  │                                      │ │
│  │  AI経営コンサルティング              │ │
│  │  会話レポート                        │ │
│  │                                      │ │
│  │  セッション: 新規事業戦略相談        │ │
│  │  作成日: 2026年2月7日                │ │
│  │                                      │ │
│  │  ─────────────────────────────────  │ │
│  │                                      │ │
│  │  【会話履歴】                        │ │
│  │                                      │ │
│  │  Q: 新規事業のSWOT分析をお願いします │ │
│  │                                      │ │
│  │  A: 承知しました。御社の新規事業に   │ │
│  │     ついて、以下の観点から分析...   │ │
│  │                                      │ │
│  └──────────────────────────────────────┘ │
│                                            │
│  [ダウンロード]                  [閉じる]  │
└────────────────────────────────────────────┘
```

---

## セキュリティ考慮点

### 1. データ検証
- エクスポートするセクションは現在のセッションのもののみ
- 他ユーザーのデータは含めない

### 2. ファイルサイズ制限
- PDF: 最大10MB
- セクション数: 最大10セクション

### 3. レート制限
- 1ユーザー: 1分間に5回まで

---

## エラーハンドリング

### エラーケース

| エラー | 原因 | 対処 |
|-------|------|------|
| セクション未選択 | ユーザーがチェックなし | ダウンロードボタンを無効化 |
| PDF生成失敗 | jsPDFエラー | 500エラー、トースト通知 |
| データなし | 該当セクションの会話なし | チェックボックスを無効化 |
| ファイルサイズ超過 | 会話が長すぎる | 400エラー、分割提案 |

---

## ファイル変更計画

### 新規作成

#### 1. `components/consulting/ExportReportDialog.tsx`
**目的**: エクスポート設定UI

**保護レベル**: レベル3

#### 2. `components/consulting/ReportPreview.tsx`
**目的**: プレビュー表示UI

**保護レベル**: レベル3

#### 3. `lib/report/builder.ts`
**目的**: レポート構築ロジック

**保護レベル**: レベル3

#### 4. `lib/report/pdf-generator.ts`
**目的**: PDF生成ロジック

**保護レベル**: レベル3

#### 5. `lib/report/types.ts`
**目的**: 型定義

**保護レベル**: レベル3

#### 6. `app/api/tools/generate-report/route.ts`
**目的**: レポート生成API

**保護レベル**: レベル3

---

### 変更対象

#### 7. `app/consulting/start/page.tsx`
**変更内容**: レポートエクスポートボタンの実装

**変更箇所**:
```typescript
// 変更前
onClick={() => toast.info("準備中", { ... })}

// 変更後
onClick={() => setShowExportDialog(true)}
```

**保護レベル**: レベル3

---

### 参照のみ
- `package.json` - jspdf, jspdf-autotable追加確認

---

## 依存ライブラリ

### 新規追加

```json
{
  "jspdf": "^2.5.1",
  "jspdf-autotable": "^3.8.2"
}
```

**理由**:
- `jspdf`: PDF生成の標準ライブラリ
- `jspdf-autotable`: テーブル（SWOT分析）生成用

---

## 成功基準（Phase A）

### 完了条件

- ✅ 「レポートをエクスポート」ボタンクリックでダイアログ表示
- ✅ 実施済みセクションがチェックボックスで選択可能
- ✅ 未実施セクションはグレーアウト
- ✅ プレビュー表示が正常に動作
- ✅ PDF生成・ダウンロードが正常に動作
- ✅ 日本語が正しく表示される
- ✅ 会話データが正しく含まれる
- ✅ SWOT分析が表形式で含まれる

---

## Phase B への移行条件

Phase A成功後、次の機能を追加：

1. **PPT生成対応**
   - pptxgenjsでPPT生成

2. **Supabase Storage保存**
   - 生成したレポートを保存
   - 履歴管理

3. **テンプレートカスタマイズ**
   - ユーザーごとのテンプレート設定

4. **Dify統合**
   - AIが自動でレポート生成提案

---

## リスク管理

### 技術的リスク

| リスク | 影響 | 対策 |
|-------|------|------|
| jsPDFの日本語フォント | 文字化け | フォント埋め込み検証 |
| 長い会話のPDF化 | ファイルサイズ超過 | ページ分割、要約機能 |
| SWOT分析の抽出 | データがない | チェックボックス無効化 |

---

## 実装後のドキュメント化

実装完了後、以下を記録：

1. 実際の生成時間（セクションごと）
2. ファイルサイズ（セクションごと）
3. 発生したエラーと解決方法
4. ユーザーフィードバック
5. パフォーマンス改善点

---

**作成日**: 2026-02-07
**Phase**: Design
**前Phase**: Phase C（プロトタイプ）完了
**次フェーズ**: Plan（実装計画作成）
