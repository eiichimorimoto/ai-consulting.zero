# 音声読み上げ（TTS）検討メモ

**日付**: 2026-02-14  
**対象**: ChatArea.tsx / ChatMessage.tsx の「音声で読み上げる」  
**現状**: Web Speech API（`speechSynthesis`）のみ使用。バックエンド TTS および `/api/tts` は未実装。

---

## 1. 現状の「ぎこちなさ」の要因（想定）

| 要因 | 説明 |
|------|------|
| **ブラウザ音声の差** | 環境によって日本語の音声エンジン・品質が異なり、ロボット的・途切れ気味になりやすい |
| **長文を一括読み** | 長い回答を1発の `SpeechSynthesisUtterance` で読むと、ブラウザによっては遅延・途切れが目立つ |
| **音声の選び方** | 日本語対応ボイスを明示していない場合、デフォルトの英語ボイスになることがある |
| **マークダウンそのまま** | `#` や `**` を除去しているが、リスト・コードブロックなどは未処理で読みが不自然になりうる |

---

## 2. 改善の方向性

### オプション A: フロントのみ（Web Speech API の改善）

- **日本語ボイスを明示選択**: `speechSynthesis.getVoices()` で `lang === 'ja-JP'` のボイスを優先して `utterance.voice` にセット
- **長文のチャンク分割**: 一定文字数（例: 200〜300字）や句点で区切り、複数の `Utterance` に分けて順次 `speak()`（`onend` で次を開始）。途切れ感を減らしつつ、キャンセルしやすい
- **読み上げテキストの正規化**: 見出し記号・リスト記号・コードブロックを空白や「。」に置換し、読みやすくする
- **再生速度の微調整**: `utterance.rate` を 0.9〜1.1 程度でユーザー設定可能にすると、聞きやすさが変わる

**メリット**: 実装が軽い、追加インフラ不要  
**デメリット**: 品質はブラウザ依存のまま

---

### オプション B: バックエンド TTS（将来検討）

- **例**: OpenAI TTS API / Google Cloud TTS / 他クラウド TTS
- **フロー**: フロントから「このメッセージを読み上げ用テキストで」リクエスト → `/api/tts` でテキストを受け取り、TTS API を呼び出し → 音声データ（base64 または URL）を返す → フロントで `Audio` 再生
- **注意**: コスト・レート制限・言語設定（ja）の確認が必要

**メリット**: 音質・安定性の向上、ブラウザ差の解消  
**デメリット**: API キー管理、コスト、実装工数

---

## 3. 推奨ステップ

1. **短期**: オプション A を実施  
   - 日本語ボイス優先  
   - 長文はチャンク分割（句点 or 200字程度）  
   - マークダウン正規化の強化（リスト・コードブロックを簡略化）
2. **中期**: ユーザーからの要望や利用状況を見て、オプション B（`/api/tts`）の要否を判断

---

## 4. 影響範囲（現状）

- **ChatArea.tsx**: `handleSpeak`（`speakingMessageId` 管理）、読み上げボタン
- **ChatMessage.tsx**（`app/consulting/components/`）: 同様に `speechSynthesis` で読み上げ
- 上記以外に TTS 専用 API は未実装のため、オプション B をやる場合は新規で `/api/tts` を追加する想定。
