# 🧠 Brainstorm: SearchTab本格実装（Web検索+AI要約）

**日付**: 2026-02-04  
**機能名**: Start画面右パネル「検索」タブの本格実装

---

## プロジェクトコンテキスト

### 技術スタック
- **Next.js 16** + TypeScript + Supabase
- **Brave Search API**: Web検索（既存実装あり）
- **OpenAI API / Dify API**: AI要約

### 関連ファイル
- `components/consulting/SearchTab.tsx` (現在ダミー実装)
- `lib/brave-search.ts` (既存のBrave Search実装)
- `app/api/company-intel/route.ts` (参考: 会社情報検索)

### ファイル保護レベル
- **レベル3**: SearchTab.tsx（変更可能）
- **レベル3**: 新規APIルート作成（/api/consulting/search/）

---

## 要件サマリー

### ユーザーからの要望
> 「これを本当に検索できるように変更してください。Web検索は、会社情報の所でも使っているので参照してください。検索結果は、3つ程度収集してAIで要約して表示してください。ここの検索目的は、チャットでAIとやり取りしているときに一時的にユーザーが調べてAIに情報を流すものです。他にこの意図で違う方法が有れば提案してください。」

### 目的
- チャット中にユーザーが**一時的に**Web情報を調べる
- 検索結果を**AI要約**してチャットに挿入
- 会話の文脈を補完する情報収集ツール

---

## 逆質問リスト

### 1. 機能要件
- ✅ 検索結果の件数: 3件程度
- ✅ AI要約: 必須
- ❓ 検索履歴の保存: Supabaseに永続化する？ローカルのみ？
- ❓ 検索結果のキャッシュ: 同じクエリは再利用する？

### 2. AI要約の仕様
- ❓ 要約のスタイル: 箇条書き？段落形式？
- ❓ 要約の長さ: 100文字程度？200文字程度？
- ❓ 要約のトーン: ビジネス調？フレンドリー調？
- ❓ 参考URL: 要約に含める？別途表示？

### 3. チャットへの挿入方法
- ✅ 現在: 個別の検索結果を1つずつ挿入
- ❓ 提案A: 3件の検索結果を1つの要約としてまとめて挿入
- ❓ 提案B: 要約 + 元の検索結果リンクを両方挿入
- ❓ 提案C: ユーザーが選択した検索結果のみ挿入

### 4. UX/UI
- ❓ 検索中の表示: ローディングアニメーション？進捗表示？
- ❓ エラー時の対応: 再試行ボタン？エラーメッセージのみ？
- ❓ 要約表示: 折りたたみ？展開表示？

### 5. 技術選定
- ❓ AI要約: OpenAI GPT-4? Dify API? Claude?
- ❓ エンドポイント: `/api/consulting/search`でOK？
- ❓ レート制限: 必要？（秒間/分間の制限）

### 6. セキュリティ
- ✅ APIキー: サーバーサイドで管理
- ❓ 検索クエリのログ: 保存する？
- ❓ 検索結果のフィルタリング: 不適切なコンテンツ除外？

---

## 代替案の提案

### 現行案: Web検索 + AI要約
**フロー**:
```
ユーザー入力 → Brave Search (3件)
  ↓
AI要約 (OpenAI/Dify)
  ↓
要約 + 参考URL → チャット挿入
```

**メリット**:
- ✅ 情報が簡潔にまとまる
- ✅ チャットが長くならない
- ✅ AIが理解しやすい形式

**デメリット**:
- ❌ 要約に時間がかかる（3-5秒）
- ❌ APIコストが発生（OpenAI）
- ❌ 要約の品質がAIに依存

---

### 代替案A: Web検索のみ（要約なし）
**フロー**:
```
ユーザー入力 → Brave Search (3件)
  ↓
タイトル + スニペット → 一覧表示
  ↓
ユーザーが選択 → チャット挿入
```

**メリット**:
- ✅ 高速（1-2秒）
- ✅ コストが低い（Brave APIのみ）
- ✅ オリジナル情報を保持

**デメリット**:
- ❌ ユーザーが情報を読む必要がある
- ❌ チャットが長くなる可能性

---

### 代替案B: チャット連携型（Difyツール）
**フロー**:
```
ユーザーがチャットで質問
  ↓
Difyが必要に応じて自動でWeb検索
  ↓
検索結果を踏まえてAIが回答
```

**メリット**:
- ✅ シームレス（検索タブ不要）
- ✅ AIが自動判断
- ✅ 会話の文脈に統合

**デメリット**:
- ❌ ユーザーが検索をコントロールできない
- ❌ Difyのツール設定が必要
- ❌ コストが高い（毎回AI判断）

---

### 代替案C: ハイブリッド型（検索+AI統合）
**フロー**:
```
ユーザー入力 → Brave Search (3件)
  ↓
検索結果を表示（折りたたみ）
  ↓
「要約を生成」ボタン → AI要約
  ↓
要約をチャット挿入
```

**メリット**:
- ✅ ユーザーがコントロール
- ✅ 必要な時だけAI使用（コスト削減）
- ✅ 検索結果も確認できる

**デメリット**:
- ❌ 手順が増える
- ❌ UIが複雑化

---

## 推奨案

### 🏆 **現行案（Web検索 + AI要約）を推奨**

**理由**:
1. **ユーザーの意図に最も合致**: 「3つ程度収集してAIで要約」
2. **チャット体験が向上**: 簡潔な情報でAIとの会話がスムーズ
3. **既存実装を活用**: Brave Search + OpenAI/Dify APIの組み合わせ

**改善提案**:
- 検索結果をアコーディオン表示（要約 + 詳細を折りたたみ）
- 「詳細を見る」で元の検索結果を確認可能
- 「要約を再生成」ボタンで異なる要約を試せる

---

## 確定要件（ユーザー承認待ち）

### 仮決定事項
- ✅ Brave Search APIを使用（3件取得）
- ✅ AI要約を実装（OpenAI GPT-4-turbo推奨）
- ✅ 要約 + 参考URLをチャットに挿入
- ✅ 検索履歴はローカル（sessionStorage）で管理
- ✅ エラー時は再試行ボタン表示

### 未確定事項（要確認）
1. **AI要約のスタイル**: 箇条書き？段落形式？
2. **要約の長さ**: 100-150文字？200-300文字？
3. **チャット挿入形式**: 要約のみ？要約+URL？
4. **検索結果の表示**: 要約前に元結果を表示する？
5. **AI選定**: OpenAI？Dify？Claude？

---

## スコープ外（今回は実装しない）

- ❌ 検索履歴のSupabase永続化
- ❌ 検索結果のキャッシュ機構
- ❌ 不適切コンテンツのフィルタリング
- ❌ レート制限の実装
- ❌ 検索クエリの自動補完
- ❌ 画像検索
- ❌ 検索結果のブックマーク機能

---

## ファイル影響範囲

### 新規作成
- `app/api/consulting/search/route.ts` (APIエンドポイント)
- `docs/architecture/design_20260204_search_tab.md` (設計ドキュメント)
- `docs/plans/implementation_plan_20260204_search_tab.md` (実装計画)

### 変更対象
- `components/consulting/SearchTab.tsx` (保護レベル3)
  - ダミー実装を削除
  - 実際のAPI呼び出しに変更
  - AI要約の表示機能追加

### 参照のみ
- `lib/brave-search.ts` (既存のBrave Search実装)
- `app/api/company-intel/route.ts` (参考実装)
- `hooks/useFileAttachment.ts` (参考: API呼び出しパターン)

---

## 次のステップ

### ✅ Phase 1完了
このBrainstormドキュメント作成完了

### 🔜 Phase 2: DESIGN
- アーキテクチャ図作成
- データフロー設計
- API仕様定義
- エラーハンドリング設計

### 🔜 Phase 3: PLAN
- タスク分解
- 実装順序決定
- 見積もり

### 🔜 Phase 4: IMPLEMENT
- APIルート実装
- SearchTab改修
- テスト・動作確認

---

## 質問事項（ユーザーへ）

**以下の点についてご確認をお願いします**:

### 1. 要約のスタイル
どちらが良いですか？

**A案: 箇条書き（簡潔）**
```
検索キーワード「中小企業 売上向上」の要約:
• 新規顧客獲得が最も効果的（年間+15%）
• デジタルマーケティング活用で成長率18%
• 既存顧客の単価向上で安定的な増収

参考: https://example.com/sales1, https://example.com/sales2
```

**B案: 段落形式（詳細）**
```
検索キーワード「中小企業 売上向上」の要約:

中小企業が売上を向上させるには、新規顧客獲得が最も効果的であり、年間+15%の成長が期待できます。また、デジタルマーケティングを活用することで成長率18%を実現した事例が多数報告されています。さらに、既存顧客の単価向上により安定的な増収が可能です。

参考: https://example.com/sales1, https://example.com/sales2, https://example.com/sales3
```

### 2. AI選定
どのAIを使用しますか？

- **OpenAI GPT-4-turbo**: 高品質、やや高コスト
- **Dify API**: 既存統合あり、カスタマイズ可能
- **Claude 3.5 Sonnet**: 高品質、長文対応

### 3. その他
- 検索結果を要約前に表示する必要はありますか？
- 検索履歴は何件保持しますか？（現在5件）
- エラー時の再試行は自動？手動？

---

**これで問題なければ、Phase 2: DESIGNに進みます！**
