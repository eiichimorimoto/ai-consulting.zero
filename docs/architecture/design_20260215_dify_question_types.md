# Dify での質問形式の出し分け（文書質問 vs 選択肢）

**日付**: 2026-02-15  
**目的**: 「文書による質問」と「選択肢付き質問」を Dify の回答内容に応じて出し分けられるようにする設計メモ。

---

## 1. 現状の整理

- **共通で聞いているもの（会社情報・外部情報）**: 3点目まで実施済み。残り2点は未実施。
- **カテゴリ・サブカテゴリ**: アプリ側で固定の選択肢（1段・2段）を表示。
- **Dify プロンプト**: クライアント情報・担当者情報・現在の課題（カテゴリ/詳細）を渡し、経営コンサルとしてアドバイス。曖昧な質問の明確化・会話継続・回答フォーマットを指示。
- **課題**: 「AIなのに選択肢ばかり」と感じる人もいれば、選択肢があった方が答えやすい人もいる。人によって特性が違うため、**システム側で「文書質問」と「選択肢付き質問」を出し分けられるとよい**。

---

## 2. 実現の可否

**結論: 難しいことではなく、実現可能。**

- **文書による質問**: 現状どおり、Dify の通常のテキスト回答をそのまま表示すればよい。
- **選択肢付き質問**: Dify の回答テキストに「選択肢用の構造」を含ませ、アプリでパースして既存の `buttons`（または同等）で描画する。

既存のチャット UI には `interactive.type === "buttons"` で「文字列のリストをボタン表示」する仕組みがあるので、**Dify が「いつ選択肢を出すか」を決め、出すときは決まったフォーマットで返す**形にすればよい。

---

## 3. 実装方針（案）

### 3.1 Dify 側

- **通常時**: これまでどおり自然文で質問・回答。
- **選択肢を出したいとき**: 回答の末尾に、アプリと取り決めたブロックを付与する。

例（マークダウンコードブロックで構造を渡す）:

```text
（通常の説明文や質問文）

```app_choices
以下のうち当てはまるものを選んでください。
- 1〜2年程度
- 3〜5年程度
- 5年以上
- わからない
```
```

または JSON で:

```text
```app_choices
{"question":"課題を感じ始めた時期はどれに近いですか？","options":["1〜2年程度","3〜5年程度","5年以上","わからない"]}
```
```

- プロンプトに追記する例:
  - 「ユーザーに複数候補から選ばせたいときは、回答の最後に ```app_choices で始まるブロックを1つだけ付けてください。1行目が質問文、2行目以降は「- 選択肢」で1行1つ。または JSON で question と options を渡す。」
  - 「選択肢を出さないときはこのブロックは付けないでください。」

Dify のワークフローで「出力を必ずコードノードで検証する」などにしてもよいが、まずは LLM の出力規則だけで運用する形が簡単。

### 3.2 アプリ側（Next.js）

1. **Dify からの返答テキストを受け取る**（現状どおり）。
2. **`app_choices` ブロックの有無を判定**  
   - 正規表現や簡易パーサーで `` ```app_choices ... ``` `` を検出。
3. **ブロックがある場合**
   - ブロック内から「質問文」と「選択肢の配列」を抽出。
   - 表示用テキストからは `` ```app_choices ... ``` `` を削除（ユーザーには見せない）。
   - そのメッセージに `interactive: { type: "buttons", data: options[] }` のような形で持たせる（既存の `buttons` を流用する場合）。  
   - 必要なら `type: "question-buttons"` を新設し、`question` と `options` の両方を持たせて「質問文＋ボタン」を表示。
4. **ブロックがない場合**
   - 従来どおりテキストのみ表示（文書による質問）。

選択肢のクリック時は、選んだラベルをそのままユーザー発言として送信すれば、現状の「ユーザーがテキストで答える」フローと同一に扱える。

---

## 4. 運用上の注意

- **出し分けの判断は Dify（LLM）に任せる**  
  - 「ここは選択肢で聞く」「ここは自由記述で聞く」はプロンプトで指示し、アプリは「ブロックがあれば選択肢表示、なければ通常表示」だけ担当する。
- **選択肢は「補助」**  
  - 選択肢を選んだあとでも、「その他」「もっと詳しく」のような自由入力は従来どおり送れるようにしておく。
- **既存プロンプトとの両立**  
  - 今の「クライアント情報・担当者情報・課題・明確性チェック・会話継続・回答フォーマット」はそのまま維持し、その上で「選択肢を使うときのフォーマット」だけ追加する形でよい。

---

## 5. まとめ

- **文書による質問** → 現状の Dify のテキスト回答をそのまま表示。
- **選択肢付き質問** → Dify に「選択肢を出したいときは `app_choices` ブロックを付ける」と約束させ、アプリでパースして既存のボタン UI で表示。
- どちらを使うかは Dify（LLM）に任せ、人によって「選びやすい」「書きやすい」の差は、同じシステムで両方に対応できる形にできる。

現状のプロンプト（会社情報・課題・明確性・会話継続・フォーマット）はそのままでよく、**追加するのは「選択肢ブロックの形式と、付与するタイミングの指示」**だけでよい。
