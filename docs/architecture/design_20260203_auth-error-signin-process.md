# 設計: 認証エラー画面のサインインプロセス（/auth/error）

**日付**: 2026-02-03  
**対象**: `app/auth/error/page.tsx`  
**目的**: メール確認リンクエラー時の案内を整理し、再送 vs ログイン誘導を明確にする。

---

## 1. エラー種別と想定状況

| エラー | 想定状況 | 主導線 | 副導線 |
|--------|----------|--------|--------|
| **flow_expired / code_expired** | リンクの有効期限（約1時間）切れ。**まだリンクを1回も押していない**可能性が高い。 | 確認メールを**再送信** | 再送しても届かない・既に確認済みの場合は**ログイン** |
| **invalid_code** | リンク使用済み（2回目クリック）または期限切れ。**既に1回押している**可能性が高い。 | **ログイン**を試す | まだリンクを押していない場合のみ再送（補助） |
| **access_denied** | 同上。Supabase がアクセス拒否。 | **ログイン**を試す | 同上 |

---

## 2. メッセージと案内のルール

### 2.1 有効期限切れ（flow_expired / code_expired）

- **タイトル**: 「確認リンクの有効期限が切れました」
- **説明**: 「メール内のリンクは約1時間で無効になります。**まだリンクを開いていない場合**は、下記から確認メールを再送信してください。」
- **主 CTA**: 「確認メールを再送信」（フォーム＋ボタン）
- **副案内**: 「再送しても届かない場合、既にアカウントが確認済みになっていることがあります。その場合は**ログイン**してください。」＋ ログインボタン（常時表示）
- **再送成功時**: 「確認メールを再送信しました。メールをご確認ください。届かない場合は既に確認済みの可能性があります。**ログインを試してください**。」＋ ログインボタン（主 CTA に変更）
- **再送不可時（API で既に確認済みなど）**: エラーメッセージで「既に確認済みの可能性があります。**ログイン**してください。」＋ ログインボタン

### 2.2 無効なコード / アクセス拒否（invalid_code / access_denied）

- **タイトル**: 「確認リンクは1回のみ有効です」／「アクセスが拒否されました」
- **説明**: 「確認リンクは1回だけ使えます。既に使用済みのためこのエラーになっていることがあります。**ログイン**してください。」
- **主 CTA**: 「ログインする」（常時メインの青ボタン）
- **副案内**: 「まだメールのリンクを1回も開いていない場合は、確認メールの再送信もできます。」＋ 再送信は補助（折りたたみ or 小さめリンクで展開）

---

## 3. UI 構成（共通）

- **常時表示**: 「ログインする」ボタン（メイン or サブに応じてスタイル切り替え）
- **新規登録はこちら**: リンク（サブ）
- **トップページに戻る**: フッターリンク

---

## 4. 実装方針

- `error` パラメータで `flow_expired` / `code_expired` のときのみ、再送信フォームを**主**に表示。
- `invalid_code` / `access_denied` のときはログインを**主**、再送信は**補助**（任意で表示）。
- 再送信成功後は、主 CTA を「ログインする」にし、再送メール待ちよりログイン試行を優先して案内。
- 再送信 API が「既に確認済み」等でエラーを返した場合は、ログイン誘導のメッセージを表示。

---

## 5. ファイル影響範囲

- **変更**: `app/auth/error/page.tsx` のみ（保護レベル 3）
- **参照**: なし
