# Google PageSpeed Insights API の利用制限

## 📋 制限内容

### 無料枠
- **25,000リクエスト/日**
- 課金なしで利用可能

### リセットタイミング
```
リセット時間: 太平洋時間（PT）の午前0時
日本時間換算:
- 夏時間（3月〜11月）: 日本時間 16:00
- 冬時間（11月〜3月）: 日本時間 17:00
```

**重要**: タイムゾーンは Google のデータセンター（米国太平洋時間）に依存

---

## 🔍 現在の使用状況確認方法

### 1. Google Cloud Console で確認

1. [Google Cloud Console](https://console.cloud.google.com/) にアクセス
2. プロジェクトを選択
3. 左メニュー → **「APIとサービス」** → **「ダッシュボード」**
4. **「PageSpeed Insights API」** をクリック
5. **「指標」タブ**で以下を確認：
   - リクエスト数（過去24時間）
   - エラー率
   - レイテンシ

### 2. クォータ確認

1. Google Cloud Console → **「APIとサービス」** → **「割り当て」**
2. 検索ボックスに **「PageSpeed」** と入力
3. 現在の使用状況とクォータを確認

---

## 🛡️ 対策（優先度順）

### ✅ 実装済み

1. **Supabaseキャッシュ（24時間）**
   - 初回のみAPI呼び出し
   - 2回目以降はキャッシュから返却
   - **削減効果: 90%以上**

### 🔄 検討中

2. **ユーザー制限**
   - 1ユーザーあたり 5回/日 に制限
   - sessionStorageでカウント
   - **削減効果: 使用量を予測可能に**

3. **APIキーローテーション**
   - 複数のAPIキーを用意
   - 順番に使用
   - **削減効果: 実質的な上限を2倍、3倍に**

4. **プレミアムプラン検討**
   - 課金でクォータ増加
   - Google Cloud Console で申請可能

---

## 📈 使用量見積もり

### キャッシュなしの場合
```
1URL分析 = 2リクエスト（mobile + desktop）
100ユーザー × 5URL/日 = 1,000リクエスト/日

→ 25,000リクエスト制限に対して 4% 使用
```

### キャッシュありの場合（24時間）
```
初回のみAPI呼び出し
同じURLは24時間キャッシュ

100ユーザーが同じ5URLを分析:
- 初回: 10リクエスト（5URL × 2戦略）
- 2回目以降: 0リクエスト（キャッシュから）

→ 99%削減 🎉
```

---

## 🚨 現在の状況（2026-02-07）

- **制限到達**: 25,000リクエスト/日に到達
- **原因**: 開発中の繰り返しテスト + キャッシュ未実装期間
- **次回リセット**: 
  - 太平洋時間 2026-02-07 00:00（冬時間）
  - **日本時間 2026-02-07 17:00**

### 一時的な対応

**今すぐできること:**
1. ✅ Supabaseキャッシュを実装済み（今回）
2. ⏰ 日本時間 17:00 までAPI使用を控える
3. 🧪 テストは別のAPIキーまたはモックデータで実施

**恒久対策:**
1. ユーザー制限の実装
2. 監視ダッシュボードの作成
3. アラート設定（80%到達時に通知）
