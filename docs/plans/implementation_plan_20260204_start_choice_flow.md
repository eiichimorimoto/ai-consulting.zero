# 実装プラン: Start画面 新規/既存選択フロー（2026-02-04）

## 1. 要件サマリー

- **初回表示**: ページに来た時はラベルを出さない。新規/既存の選択のみ表示。
- **選択UI**: 新規と既存ボタンを**先頭**に、**左blockの上**に配置。背景を付け、やや大きく。左blockの横幅(w-80=320px)を超えない。
- **新規選択時**: 「新規相談」ラベルを1つ表示してから相談開始（既存の新規ユーザーフロー）。
- **既存選択時**: 直近の課題をラベルで表示（最大5つ）。右に「既存フォルダー」（履歴）を表示。

## 2. 変更案の比較

| 案 | 内容 | メリット | デメリット |
|----|------|----------|------------|
| **A** | 初回は userChoice=null とし、新規/既存ボタンのみ表示。選択後にセッション取得または新規1件をセット | 初回はAPIを叩かず表示が速い。選択に応じてのみAPI | 初回と選択後の二段階状態管理が必要 |
| **B** | 従来通り初回にAPIで件数取得し、0件なら「新規」、1件以上なら「既存」を自動選択してラベル表示 | 実装変更が少ない | 「ラベルを出さない」が満たせない |
| **C** | 初回は必ず「選択画面」を出し、新規クリックで新規1タブ、既存クリックでAPI取得して最大5タブ＋履歴表示 | 要件どおり「来た時はラベルなし」「選んだ段階で表示」を満たす | 既存ユーザーもいちど新規/既存を選ぶ必要がある |

**採用案: C**  
要件「このページに来た時はラベルは出しません」「新規か既存を選んだ段階で」を満たすため。

## 3. ファクトチェック

- **API**: `GET /api/consulting/sessions` は既存のまま。既存選択時に呼ぶ。
- **DB**: 変更なし。consulting_sessions の参照のみ。
- **既存コード**: SessionTabs は「セッション配列」を受け取るだけ。空配列で呼べばタブは出さず、1件なら1タブ、5件なら5タブになる。
- **左block幅**: `w-80` = 20rem = 320px。新規/既存ボタン行は `max-w-[20rem]` または `w-80` で制限。

## 4. 画面状態の定義

| 状態 | 意味 | 表示 |
|------|------|------|
| `choicePending` | 初回・未選択 | 新規/既存ボタンのみ（左block上）。ラベル行・メインコンテンツは簡易表示 or 空 |
| `choiceNew` | 新規を選択済み | ラベル1つ「新規相談」＋左サイド＋チャット＋右インサイト |
| `choiceExisting` | 既存を選択済み | 直近最大5ラベル＋左サイド＋チャット＋右は履歴（既存フォルダー）を表示 |

## 5. 実装タスク（順序）

1. **状態の追加**  
   - `userChoice: null | 'new' | 'existing'` を追加。  
   - 初回は `sessionsLoaded` 後に `userChoice === null` のままにし、セッションは空でよい（または取得しない）。

2. **初回表示の変更**  
   - `userChoice === null` のときは SessionTabs を出さない。  
   - 代わりに「新規」「既存」ボタンを、左blockの上・幅 w-80 内に配置。  
   - 背景付き・やや大きめのボタンにする。

3. **新規ボタン**  
   - クリックで `userChoice = 'new'`、`allSessions = [createInitialSessionForNewUser()]`、`activeSessionId = 'new-session'` にし、既存の新規フローへ。

4. **既存ボタン**  
   - クリックで `userChoice = 'existing'`、`GET /api/consulting/sessions` で取得 → `mapApiSessionsToSessionData` で最大5件をタブ用にセット。  
   - `setIsHistoryOpen(true)` で履歴パネル（既存フォルダー）を右に表示。

5. **既存時のラベル数**  
   - 直近4つ or 5つ: 要件は「直近の4つの課題」と「直近の課題ラベルを5つ並べて」の両方。  
   - 実装では **最大5タブ** に統一（既存の MAX_OPEN_TABS）。

6. **左block上レイアウト**  
   - 新規/既存の行を、メインの `flex` の**上**に置く。  
   - その行は `max-w-[20rem]`（左blockと同じ幅）で中央 or 左寄せし、左blockを超えないようにする。

## 6. ファイル変更一覧

| ファイル | 変更内容 |
|----------|----------|
| `app/consulting/start/page.tsx` | userChoice 状態、初回はセッション取得しない or 取得してもラベル出さない分岐、新規/既存ボタン行の追加、選択時の処理 |

## 7. 安全確認

- 既存の「新規」「既存」判定（API 0件→新規、1件以上→既存）は、**選択後**の既存フローでのみ使用。
- SessionHistoryPanel、SessionTabs、TabbedContextPanel の既存 props はそのまま利用。
- 1ファイルずつ変更し、他ファイルは参照のみ（ルール準拠）。
