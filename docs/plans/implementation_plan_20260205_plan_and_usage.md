# ğŸ“ Implementation Plan: ãƒ—ãƒ©ãƒ³ãƒ»åˆ©ç”¨ã‚«ã‚¦ãƒ³ãƒˆãƒ»ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±è¡¨ç¤º

**æ—¥ä»˜**: 2026-02-05

---

## ã‚¿ã‚¹ã‚¯é †åºï¼ˆ1ãƒ•ã‚¡ã‚¤ãƒ«ãšã¤ï¼‰

### Task 1: ãƒ—ãƒ©ãƒ³å¤‰æ›´ API ã®æ–°è¦ä½œæˆ
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `app/api/settings/change-plan/route.ts`ï¼ˆæ–°è¦ï¼‰
- **å†…å®¹**: POST ã§ planType ã‚’å—ã‘å–ã‚Šã€profiles.plan_type ã¨ subscriptions ã‚’æ›´æ–°ã€‚
- **ä¾å­˜**: ãªã—ã€‚

### Task 2: SettingsContent ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ãƒ–ãƒ­ãƒƒã‚¯ã¨ãƒ—ãƒ©ãƒ³å¤‰æ›´å‡¦ç†
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `components/SettingsContent.tsx`
- **å†…å®¹**: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚«ãƒ¼ãƒ‰å†…ã«ã€Œã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ—ãƒ©ãƒ³åãƒ»ãƒãƒ£ãƒƒãƒˆæ•°ãƒ»OCRæ•°ï¼‰ã¨ã€Œãƒ—ãƒ©ãƒ³å¤‰æ›´ã€ãƒœã‚¿ãƒ³è¿½åŠ ã€‚handleChangePlan ã§ API å‘¼ã³å‡ºã— + toast + refreshã€‚
- **ä¾å­˜**: Task 1ã€‚

### Task 3: ãƒãƒ£ãƒƒãƒˆé€ä¿¡æ™‚ã®åˆ©ç”¨ã‚«ã‚¦ãƒ³ãƒˆåŠ ç®—
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `app/api/consulting/sessions/[id]/messages/route.ts`
- **å†…å®¹**: Dify å‘¼ã³å‡ºã—æˆåŠŸå¾Œã€å½“è©² user_id ã® profiles ã® monthly_chat_count ã‚’ +1ã€‚
- **ä¾å­˜**: ãªã—ã€‚

### Task 4: OCR åˆ©ç”¨æ™‚ã®åˆ©ç”¨ã‚«ã‚¦ãƒ³ãƒˆåŠ ç®—
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `app/api/ocr-business-card/route.ts`
- **å†…å®¹**: OCR æˆåŠŸå¾Œã€å½“è©² user_id ã® profiles ã® monthly_ocr_count ã‚’ +1ã€‚
- **ä¾å­˜**: ãªã—ã€‚

---

## å®Ÿè£…ãƒ¡ãƒ¢

- ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã® plan_type / monthly_* ã¯è¨­å®šãƒšãƒ¼ã‚¸ã§æ—¢ã« select('*') ã®ãŸã‚å–å¾—æ¸ˆã¿ã€‚ä»–ç”»é¢ã¯ä»Šå›ã‚¹ã‚³ãƒ¼ãƒ—å¤–ã€‚
- subscriptions ã®ã‚¹ã‚­ãƒ¼ãƒã¯ user_id, plan_type, status ç­‰ã€‚profiles ã¨åŒæœŸã•ã›ã‚‹å½¢ã§ update/insertã€‚
