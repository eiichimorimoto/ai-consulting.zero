# 📝 Implementation Plan: エクスポート統合機能（Phase A）

## プロジェクト構造

```
ai-consulting-zero/
├── app/
│   ├── api/
│   │   └── tools/
│   │       ├── generate-presentation/   ← Phase C
│   │       └── generate-report/         ← 新規作成（Phase A）
│   │           └── route.ts
│   └── consulting/
│       └── start/
│           └── page.tsx                 ← 修正
├── components/
│   └── consulting/
│       ├── TestPPTButton.tsx            ← Phase C
│       ├── ExportReportDialog.tsx       ← 新規作成
│       └── ReportPreview.tsx            ← 新規作成
├── lib/
│   ├── ppt/                             ← Phase C
│   │   ├── generator.ts
│   │   └── templates.ts
│   └── report/                          ← 新規作成
│       ├── types.ts
│       ├── builder.ts
│       └── pdf-generator.ts
└── package.json                         ← 依存関係追加
```

---

## タスクリスト

### Task 1: 依存関係の追加
- **目的**: jsPDF, jspdf-autotableをインストール
- **依存**: なし
- **成果物**: 
  - `package.json` 更新
- **見積もり**: 5分
- **優先度**: 最高
- **変更通知必須**: いいえ

**コマンド**:
```bash
npm install jspdf@2.5.1 jspdf-autotable@3.8.2
```

---

### Task 2: 型定義の作成
- **目的**: ReportSection, ExportConfig等の型定義
- **依存**: なし
- **成果物**:
  - `lib/report/types.ts` (新規作成・保護レベル3)
- **見積もり**: 15分
- **優先度**: 最高
- **変更通知必須**: いいえ

**内容**:
- ReportSection interface
- ExportConfig interface
- TableData, ListData type
- SectionType enum

---

### Task 3: レポートビルダーの作成
- **目的**: 会話データからレポートセクションを構築
- **依存**: Task 2
- **成果物**:
  - `lib/report/builder.ts` (新規作成・保護レベル3)
- **見積もり**: 45分
- **優先度**: 最高
- **変更通知必須**: いいえ

**機能**:
- buildReportSections() - メイン関数
- extractSwotSection() - SWOT抽出
- extractTrendsSection() - 業界動向抽出
- extractChatHistory() - 会話履歴抽出

---

### Task 4: PDF生成ユーティリティの作成
- **目的**: jsPDFでPDF生成
- **依存**: Task 2
- **成果物**:
  - `lib/report/pdf-generator.ts` (新規作成・保護レベル3)
- **見積もり**: 60分
- **優先度**: 最高
- **変更通知必須**: いいえ

**機能**:
- generatePDFReport() - メイン関数
- addTitlePage() - タイトルページ
- addChatSection() - 会話履歴
- addSwotTable() - SWOT表
- addListSection() - 箇条書きセクション

---

### Task 5: API Routeの作成
- **目的**: レポート生成APIエンドポイント
- **依存**: Task 3, Task 4
- **成果物**:
  - `app/api/tools/generate-report/route.ts` (新規作成・保護レベル3)
- **見積もり**: 30分
- **優先度**: 最高
- **変更通知必須**: いいえ

**機能**:
- POST: レポート生成
- エラーハンドリング
- ファイルサイズチェック

---

### Task 6: ReportPreviewコンポーネントの作成
- **目的**: プレビュー表示UI
- **依存**: Task 2
- **成果物**:
  - `components/consulting/ReportPreview.tsx` (新規作成・保護レベル3)
- **見積もり**: 45分
- **優先度**: 高
- **変更通知必須**: いいえ

**機能**:
- ページネーション
- 印刷スタイル
- ダウンロードボタン

---

### Task 7: ExportReportDialogコンポーネントの作成
- **目的**: エクスポート設定UI
- **依存**: Task 2, Task 6
- **成果物**:
  - `components/consulting/ExportReportDialog.tsx` (新規作成・保護レベル3)
- **見積もり**: 60分
- **優先度**: 最高
- **変更通知必須**: いいえ

**機能**:
- セクション選択チェックボックス
- 形式選択ドロップダウン
- プレビュー表示
- ダウンロード処理

---

### Task 8: AI相談画面への統合
- **目的**: 既存ボタンと統合
- **依存**: Task 7
- **成果物**:
  - `app/consulting/start/page.tsx` 修正 (保護レベル3)
- **見積もり**: 20分
- **優先度**: 最高
- **変更通知必須**: いいえ（レベル3）

**変更箇所**:
- ExportReportDialogのインポート
- State追加（showExportDialog）
- 「レポートをエクスポート」ボタンのonClick更新
- ダイアログコンポーネント追加

---

### Task 9: 動作確認・テスト
- **目的**: 正常動作の確認
- **依存**: Task 8
- **成果物**: テスト結果レポート
- **見積もり**: 30分
- **優先度**: 最高
- **変更通知必須**: いいえ

**確認項目**:
- ✅ ダイアログ表示
- ✅ セクション選択
- ✅ プレビュー表示
- ✅ PDF生成
- ✅ ダウンロード
- ✅ 日本語表示
- ✅ SWOT表形式
- ✅ エラーハンドリング

---

### Task 10: プロトタイプボタンの削除
- **目的**: Phase Cのテストボタンを削除
- **依存**: Task 9
- **成果物**:
  - `app/consulting/start/page.tsx` 修正
  - `components/consulting/TestPPTButton.tsx` 削除（オプション）
- **見積もり**: 5分
- **優先度**: 中
- **変更通知必須**: いいえ

**変更内容**:
- TestPPTButtonの表示を削除
- ファイルは残す（将来のテストに使用可能）

---

### Task 11: コミット
- **目的**: Gitにコミット
- **依存**: Task 10
- **成果物**: Gitコミット
- **見積もり**: 5分
- **優先度**: 中
- **変更通知必須**: いいえ

**コミットメッセージ**:
```
feat: エクスポート統合機能（Phase A）

- jsPDF, jspdf-autotable追加
- レポートビルダー実装（会話データ解析）
- PDF生成ユーティリティ実装
- ExportReportDialog, ReportPreview実装
- 既存「レポートをエクスポート」ボタンと統合
- プレビュー機能実装
- 複数セクション選択対応
```

---

## 実装順序

```
Task 1 (依存関係追加) 
  ↓
Task 2 (型定義) ━━━━━━━━━━┓
  ↓                      ↓
Task 3 (ビルダー)      Task 4 (PDF生成)
  ↓                      ↓
  ┗━━━━━━━━━━━━━━━━━━━━━┛
           ↓
      Task 5 (API Route)
           ↓
      Task 6 (ReportPreview)
           ↓
      Task 7 (ExportReportDialog)
           ↓
      Task 8 (画面統合)
           ↓
      Task 9 (動作確認)
           ↓
      Task 10 (プロトタイプ削除)
           ↓
      Task 11 (コミット)
```

**実装方針**: ボトムアップ（低レベル→高レベル）

---

## 総見積もり時間

| タスク | 時間 |
|-------|------|
| Task 1 | 5分 |
| Task 2 | 15分 |
| Task 3 | 45分 |
| Task 4 | 60分 |
| Task 5 | 30分 |
| Task 6 | 45分 |
| Task 7 | 60分 |
| Task 8 | 20分 |
| Task 9 | 30分 |
| Task 10 | 5分 |
| Task 11 | 5分 |
| **合計** | **約5時間20分** |

---

## 詳細タスク（Task 3: レポートビルダー）

### 実装内容

#### 1. extractChatHistory()
```typescript
// 会話履歴を抽出
// - ユーザー/AIのメッセージをペアで抽出
// - タイムスタンプ付き
// - 最大100メッセージ
```

#### 2. extractSwotSection()
```typescript
// SWOT分析を抽出
// - AIメッセージから「強み」「弱み」「機会」「脅威」のキーワード検索
// - 箇条書きを配列に変換
// - TableData形式に変換
```

#### 3. extractTrendsSection()
```typescript
// 業界動向を抽出
// - AIメッセージから「業界動向」「トレンド」のキーワード検索
// - 箇条書きを配列に変換
// - ListData形式に変換
```

---

## 詳細タスク（Task 4: PDF生成）

### PDF構成

#### ページ1: 表紙
```
┌─────────────────────────────────┐
│                                 │
│   AI経営コンサルティング         │
│   会話レポート                  │
│                                 │
│   セッション: 〇〇相談           │
│   作成日: 2026年2月7日           │
│                                 │
└─────────────────────────────────┘
```

#### ページ2-N: セクション
```
┌─────────────────────────────────┐
│ 【会話履歴】                     │
│ ─────────────────────────────   │
│ Q1: ユーザーの質問              │
│ A1: AIの回答...                 │
│                                 │
│ Q2: ...                         │
│ A2: ...                         │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│ 【SWOT分析】                     │
│ ─────────────────────────────   │
│ ┌───────────┬───────────┐       │
│ │ 強み      │ 弱み      │       │
│ ├───────────┼───────────┤       │
│ │ •...      │ •...      │       │
│ │           │           │       │
│ ├───────────┼───────────┤       │
│ │ 機会      │ 脅威      │       │
│ ├───────────┼───────────┤       │
│ │ •...      │ •...      │       │
│ └───────────┴───────────┘       │
└─────────────────────────────────┘
```

---

## リスク管理

### リスク1: 会話データの構造化
**問題**: AIの回答形式が統一されていない
**対策**: 
- 柔軟なパターンマッチング
- キーワードベースの抽出
- フォールバック処理

### リスク2: jsPDFの日本語フォント
**問題**: デフォルトフォントで文字化け
**対策**:
- NotoSansJPフォント埋め込み検証
- 必要に応じてフォントファイル追加

### リスク3: 長い会話のPDF化
**問題**: ファイルサイズ超過
**対策**:
- 最大100メッセージに制限
- ページ分割処理

---

## 成功基準

### Phase A完了条件

- ✅ すべてのタスクが完了
- ✅ 「レポートをエクスポート」ボタンクリックでダイアログ表示
- ✅ 実施済みセクションが選択可能
- ✅ プレビュー表示が正常に動作
- ✅ PDF生成・ダウンロードが正常に動作
- ✅ 日本語が正しく表示される
- ✅ SWOT分析が表形式で表示される
- ✅ エラー時に適切なメッセージが表示される

---

## 次のステップ（Phase B）

Phase A成功後、以下を検討：

1. **PPT生成対応**
   - pptxgenjsでPPT生成
   - プレゼン形式のレイアウト

2. **Supabase Storage保存**
   - 生成したレポートを保存
   - 履歴管理画面

3. **テンプレートカスタマイズ**
   - ユーザーごとのカスタマイズ

4. **Dify統合**
   - AIが自動でレポート生成提案

---

**作成日**: 2026-02-07
**Phase**: Plan
**前Phase**: Design完了
**次フェーズ**: Implement（実装開始）
