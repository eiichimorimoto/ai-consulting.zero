# テスト計画書（2026-02-06）

## 🎯 テストの目的

今回の修正で以下の問題を解決しました：

1. **「読み込み中...」が永遠に表示される問題**
   - 原因: sessionStorageからの状態復元が不完全
   - 修正: `openSessionIds`から`allSessions`を再構築する処理を実装

2. **カテゴリ選択時のメッセージがページ遷移後に表示されない問題**
   - 原因: カテゴリ選択時のメッセージがクライアントサイドのみに保存
   - 修正: Supabaseにも保存するように変更

3. **その他のバグ修正**
   - `TypeError: Cannot read properties of undefined (reading 'toLocaleTimeString')`
   - 一時IDの重複生成問題

---

## 🧪 テストケース

### **テストケース1: カテゴリ選択 → ページ遷移 → メッセージ保持**

#### 事前準備
```javascript
// Consoleで実行してsessionStorageをクリア
sessionStorage.clear();
location.reload();
```

#### 手順
1. **`http://localhost:3000/consulting/start` を開く**
2. **「新規」ボタンをクリック**
3. **カテゴリを選択**（例: 「売上の伸び悩み」）
   - ✅ ユーザーメッセージ「売上の伸び悩み」が表示される
   - ✅ AI応答「「売上の伸び悩み」についてですね...」が表示される
   - ✅ サブカテゴリボタンが表示される
4. **Consoleで確認**:
   ```
   ✅ Category selection messages saved to Supabase
   ```
5. **サブカテゴリを選択**（例: 「新規顧客獲得が低調」）
6. **通常のメッセージを送信**（例: 「詳しく教えてください」）
7. **ダッシュボードに移動**（`/dashboard`）
8. **再び `/consulting/start` を開く**
9. **「既存」ボタンをクリック**
10. **セッション「売上の伸び悩み」をクリック**
11. **確認**:
    - ✅ **カテゴリ選択時のメッセージが表示される**
    - ✅ **サブカテゴリ選択時のメッセージが表示される**
    - ✅ **通常のメッセージも全て表示される**
    - ✅ **スクロールして過去の会話が見える**

#### 期待される結果
- ✅ 全てのメッセージが保持されている
- ✅ メッセージの順序が正しい
- ✅ タイムスタンプが正しく表示される
- ✅ サブカテゴリボタンが復元される

---

### **テストケース2: 「既存」選択 → 状態復元**

#### 手順
1. **`http://localhost:3000/consulting/start` を開く**
2. **「既存」ボタンをクリック**
   - ✅ セッション一覧が表示される
3. **任意のセッションをクリック**
4. **ダッシュボードに移動**
5. **再び `/consulting/start` を開く**
6. **確認**:
   - ✅ **「読み込み中...」が永遠に表示されない**
   - ✅ **セッションが正しく復元される**
   - ✅ **開いていたタブが復元される**

#### 期待される結果
- ✅ セッション一覧が正しく表示される
- ✅ タブの開閉状態が復元される
- ✅ アクティブセッションが復元される

---

### **テストケース3: 「新規」選択 → ページ遷移 → リセット**

#### 手順
1. **`http://localhost:3000/consulting/start` を開く**
2. **「新規」ボタンをクリック**
3. **カテゴリを選択せずに**、ダッシュボードに移動
4. **再び `/consulting/start` を開く**
5. **確認**:
   - ✅ **「新規/既存」選択画面に戻る**（状態がリセットされる）

#### 期待される結果
- ✅ 一時セッションの状態はリセットされる
- ✅ 「新規/既存」選択画面が表示される

---

### **テストケース4: エラーハンドリング**

#### 手順1: ログアウト状態でアクセス
1. **ログアウト**
2. **`/consulting/start` を開く**
3. **確認**:
   - ✅ ログイン画面にリダイレクトされる

#### 手順2: 無効なセッションIDでアクセス
1. **Console で実行**:
   ```javascript
   fetch('/api/consulting/sessions/invalid-id/messages')
     .then(res => res.json())
     .then(console.log);
   ```
2. **確認**:
   - ✅ `{ error: 'Session not found' }` が返る

---

## 📊 確認ポイント

### **Console確認**

**正常時に表示されるログ**:
```
✅ Category selection messages saved to Supabase
```

**エラー時に表示されるログ**:
```
Failed to save category selection messages: ...
Failed to restore sessions: ...
```

### **Network タブ確認**

**カテゴリ選択時**:
1. `POST /api/consulting/sessions` - セッション作成（新規の場合）
2. `POST /api/consulting/sessions/[id]/messages` - メッセージ保存
   - Request: `{ message: "売上の伸び悩み", skipDify: true, aiResponse: "..." }`
   - Response: `{ messages: [...], conversation_id: null }`

**ページ遷移後の復元時**:
1. `GET /api/consulting/sessions` - セッション一覧取得
2. `GET /api/consulting/sessions/[id]/messages` - メッセージ取得
   - Response: `{ messages: [...], count: X }`

---

## 🐛 トラブルシューティング

### **問題1: メッセージが表示されない**

**確認**:
```javascript
// Consoleで実行
console.log('currentSession:', window.sessionStorage.getItem('consulting_state'));
```

**対処**:
- sessionStorageをクリアして再試行
- サーバーを再起動

---

### **問題2: 「読み込み中...」が表示される**

**原因**:
- 状態復元処理が失敗している
- `allSessions`が空のまま

**対処**:
1. Consoleで確認:
   ```javascript
   sessionStorage.clear();
   location.reload();
   ```
2. サーバーログを確認:
   ```bash
   tail -f .cursor/projects/.../terminals/[id].txt
   ```

---

### **問題3: 401 Unauthorized エラー**

**原因**:
- ログアウトしている
- セッションが期限切れ

**対処**:
1. 再ログイン
2. サーバーを再起動

---

## 📚 関連ドキュメント

- `docs/architecture/implementation_summary_20260205.md` - 実装サマリー
- `docs/plans/test_scenarios_20260205.md` - テストシナリオ詳細
- `.cursor/rules/superpowers-process.mdc` - 開発プロセス

---

## 🔄 次のステップ（修正が必要な場合）

1. **エラーログを確認**
2. **Console/Networkタブでデバッグ**
3. **ターミナルログを確認**
4. **必要に応じてコード修正**

---

## 📌 重要な注意事項

1. **必ずsessionStorageをクリアしてからテスト**
   - 古い状態が残っていると、正しくテストできない

2. **テスト前にログイン状態を確認**
   - ログアウトしているとエラーになる

3. **Console/Networkタブを開いてテスト**
   - エラーやリクエストを確認できる

4. **一時IDと実IDの違いを理解**
   - `temp-session-...` → 一時ID（カテゴリ選択前）
   - UUID → 実ID（Supabaseセッション作成後）

---

## 🎯 成功の基準

- ✅ カテゴリ選択時のメッセージがSupabaseに保存される
- ✅ ページ遷移後も全てのメッセージが表示される
- ✅ 「読み込み中...」が永遠に表示されない
- ✅ スクロールして過去の会話が見える
- ✅ エラーが発生しない

---

**明日のテスト、頑張ってください！**
