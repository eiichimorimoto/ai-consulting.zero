# 天気API問題 - 徹底分析と再発防止策

> 作成日: 2026-01-09
> 重要度: 🔴 最高

---

## 🔴 問題の概要

**Web検索から気温を抽出していたため、不正確なデータが表示されていた。**

---

## 📊 調査結果

### 1. いつから問題があったか

**最初のコミットから（2024-12-31頃）**

```
113c3fa feat: ダッシュボード機能拡張 - 業種ベース検索、ファクトチェック、SWOT説明、週間天気、トラフィック情報
```

### 2. なぜWeb検索を使っていたか

**設計ミス**: 最初の実装時に、以下の理由でWeb検索を選択した
1. **追加のAPIキー不要**: Brave Search APIのみで済ませようとした
2. **実装が簡単**: Web検索結果から正規表現で気温を抽出するだけ
3. **コスト削減**: 新しいAPIサービスを増やしたくなかった

**しかし、これは重大な設計ミス:**
- Web検索結果は不正確（最高気温・最低気温・現在気温が混在）
- タイムラグがある（検索結果のキャッシュ）
- 信頼性が低い（検索結果の品質に依存）
- ユーザーに誤った情報を提供する

### 3. 問題の経緯

| 日付 | コミット | 内容 |
|------|----------|------|
| 2024-12-31 | 113c3fa | **最初の実装**: Web検索で気温抽出 |
| 2025-01-08 | 2d87115 | ダミーデータ削除（しかしWeb検索は継続） |
| 2025-01-09 | 359d6bd | **OpenWeatherMap API導入**（根本解決） |

**約10日間、不正確なデータが表示されていた。**

---

## 🔍 他の同様の問題

以下のファイルでもWeb検索を使用:
1. `app/api/dashboard/swot-analysis/route.ts` - SWOT分析
2. `app/api/dashboard/market/route.ts` - 市場データ
3. `app/api/company-intel/route.ts` - 会社情報
4. `app/api/dashboard/industry-trends/route.ts` - 業界動向
5. `app/api/dashboard/industry-forecast/route.ts` - 業界予測

**これらは補助的な情報源として使用しており、問題ない。**
しかし、**定量的なデータ（気温、株価、為替等）はWeb検索で取得すべきではない。**

---

## ❌ 設計ミスの根本原因

### 1. データソース選定基準の欠如
- 「何でもWeb検索で取れる」という誤った認識
- 定量データと定性データの区別がなかった
- 信頼性・精度の評価が不十分

### 2. 初期設計の甘さ
- APIコスト削減を優先しすぎた
- ユーザーへの影響を軽視した
- 「とりあえず動けばいい」という姿勢

### 3. レビュー・テストの不足
- 実際の天気サイトとの比較検証をしなかった
- デバッグ情報を確認しなかった
- ユーザーからの指摘で初めて気づいた

---

## ✅ 再発防止策

### 1. データソース選定基準（必須）

#### 🟢 信頼できるAPI優先
- **定量データ（気温、株価、為替、統計値）**: 必ず公式API使用
- **リアルタイムデータ**: 必ず公式API使用
- **正確性が重要**: 必ず公式API使用

#### 🟡 Web検索OK（補助的用途のみ）
- 最新ニュース
- イベント情報
- 定性的な情報（評判、動向）
- 公式APIが存在しないデータ

#### 🔴 絶対NG
- ダミーデータ・固定値を本番で使用
- 推定値・予測値を実測値として表示
- Web検索から定量データを抽出

### 2. 実装前チェックリスト

新しいデータソースを追加する際、以下を確認:

- [ ] このデータは定量データか定性データか？
- [ ] 公式APIは存在するか？
- [ ] 無料プランで十分か？
- [ ] Web検索で代替可能か？（定性データのみ）
- [ ] ユーザーへの影響は？（誤情報のリスク）
- [ ] 実際のデータソースと比較検証したか？

### 3. コードレビュー必須項目

```typescript
// ❌ NG例
const temp = extractTempFromWebSearch(results)

// ✅ OK例（公式API）
const temp = await getCurrentWeather(lat, lon)

// ⚠️ 要確認（Web検索）
const news = await braveWebSearch('最新ニュース')
// → 定性データなのでOK
```

### 4. デバッグ情報の必須表示

全てのデータソースに`_debug`フィールドを追加:
- `dataSource`: 'OpenWeatherMap' | 'BraveSearch' | 'Manual'
- `extractedValue`: 抽出された値
- `apiError`: エラーメッセージ
- `lastUpdated`: 最終更新時刻

### 5. ユーザーからのフィードバック重視

- 「おかしい」という指摘は真摯に受け止める
- 実際のデータソースと比較検証する
- 問題があれば即座に修正する

---

## 📚 推奨APIリスト

### 定量データ
| データ | 推奨API | 無料プラン |
|--------|---------|-----------|
| 天気 | OpenWeatherMap | ✅ 60calls/分 |
| 株価 | Alpha Vantage | ✅ 500calls/日 |
| 為替 | ExchangeRate-API | ✅ 1500calls/月 |
| 統計 | e-Stat API（政府統計） | ✅ 無制限 |

### 定性データ
| データ | 推奨方法 | 備考 |
|--------|----------|------|
| ニュース | Brave Search | ✅ 既に使用中 |
| イベント | Brave Search | ✅ 既に使用中 |
| 評判・口コミ | Brave Search | ✅ 既に使用中 |

---

## 🎯 今後の方針

1. **定量データは公式API必須**
2. **Web検索は補助的用途のみ**
3. **実装前にデータソースを検討**
4. **デバッグ情報で検証可能に**
5. **ユーザーフィードバックを重視**

---

## 📝 メモリー記録

このドキュメントの内容をメモリーに記録し、今後の開発で参照する。

**教訓**: 「とりあえず動けばいい」ではなく、「正確なデータを提供する」ことが最優先。
