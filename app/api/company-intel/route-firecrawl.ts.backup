// BACKUP FILE (do not use as a route)
// This file is kept only as a historical backup of a Firecrawl-based implementation.
// Next.js App Router uses `route.ts` for the endpoint. This backup must NOT be imported.
//
// Original filename: `route 2.ts`

import { NextResponse } from "next/server"
import OpenAI from "openai"

interface FirecrawlResponse {
  data?: {
    markdown?: string
    content?: string
    text?: string
  }
  markdown?: string
  content?: string
  text?: string
}

interface CompanyIntelResult {
  industry?: string | null
  employeeCount?: string | null
  annualRevenue?: string | null
  products?: string[]
  services?: string[]
  branches?: string[]
  offices?: string[]
  factories?: string[]
  otherLocations?: string[]
  summary?: string
  rawNotes?: string
}

export async function POST(request: Request) {
  try {
    const body = await request.json()
    const website = (body?.website as string | undefined)?.trim()

    if (!website) {
      return NextResponse.json(
        { error: "websiteは必須です" },
        { status: 400 }
      )
    }

    const normalizedUrl =
      website.startsWith("http://") || website.startsWith("https://")
        ? website
        : `https://${website}`

    const firecrawlKey = process.env.FIRECRAWL_API_KEY
    if (!firecrawlKey) {
      return NextResponse.json(
        { error: "FIRECRAWL_API_KEYが設定されていません" },
        { status: 500 }
      )
    }

    const openaiKey = process.env.OPENAI_API_KEY
    if (!openaiKey) {
      return NextResponse.json(
        { error: "OPENAI_API_KEYが設定されていません" },
        { status: 500 }
      )
    }

    // 1. FirecrawlでWebサイトをスクレイピング
    const firecrawlResponse = await fetch("https://api.firecrawl.dev/v1/scrape", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${firecrawlKey}`,
      },
      body: JSON.stringify({
        url: normalizedUrl,
        formats: ["markdown", "text"],
        extract: { mode: "structured" },
      }),
    })

    if (!firecrawlResponse.ok) {
      const errorText = await firecrawlResponse.text()
      console.error("Firecrawl error:", errorText)
      return NextResponse.json(
        { error: "Webサイトの取得に失敗しました", details: errorText },
        { status: firecrawlResponse.status }
      )
    }

    const firecrawlJson = (await firecrawlResponse.json()) as FirecrawlResponse
    const scrapedContent =
      firecrawlJson?.data?.markdown ||
      firecrawlJson?.data?.content ||
      firecrawlJson?.markdown ||
      firecrawlJson?.content ||
      firecrawlJson?.text ||
      ""

    if (!scrapedContent) {
      return NextResponse.json(
        { error: "Webサイトの情報を取得できませんでした" },
        { status: 422 }
      )
    }

    // 2. OpenAIで構造化データを抽出
    const openai = new OpenAI({ apiKey: openaiKey })
    const prompt = `以下は企業の公式ウェブサイトから取得したテキストです。日本語で読み取り、企業情報をJSONで返してください。

必ず下記のJSON構造で回答し、読み取れない項目はnullまたは空配列にしてください。
{
  "industry": "...",
  "employeeCount": "...",
  "annualRevenue": "...",
  "products": ["..."],
  "services": ["..."],
  "branches": ["..."],
  "offices": ["..."],
  "factories": ["..."],
  "otherLocations": ["..."],
  "summary": "取得した情報の要約",
  "rawNotes": "その他の重要情報を簡潔に"
}

テキスト:
${scrapedContent.slice(0, 12000)}`

    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      max_tokens: 800,
      temperature: 0.2,
      messages: [{ role: "user", content: prompt }],
    })

    const textContent = completion.choices[0]?.message?.content?.trim()
    if (!textContent) {
      return NextResponse.json(
        { error: "OpenAIから有効なレスポンスが得られませんでした" },
        { status: 500 }
      )
    }

    let parsed: CompanyIntelResult
    try {
      const match = textContent.match(/```(?:json)?\s*([\s\S]*?)\s*```/)
      const jsonText = match ? match[1] : textContent
      parsed = JSON.parse(jsonText)
    } catch (error) {
      console.error("JSON parse error:", error, textContent)
      return NextResponse.json(
        { error: "AIレスポンスの解析に失敗しました" },
        { status: 500 }
      )
    }

    return NextResponse.json({
      data: parsed,
      meta: {
        source: normalizedUrl,
        scrapedCharacters: scrapedContent.length,
      },
    })
  } catch (error) {
    console.error("company-intel API error:", error)
    return NextResponse.json(
      { error: "会社情報の取得に失敗しました" },
      { status: 500 }
    )
  }
}




